<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeland Property Flip Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base & Dark Mode Theme --- */
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --border-color: #444;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --primary-color: #00e5ff; /* Neon Blue/Cyan */
            --primary-hover: #00b8cc;
            --danger-color: #ff4d4d;
            --danger-hover: #cc3d3d;
            --success-color: #00cc66;
            --success-hover: #00a352;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .calculator-wrapper {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* --- API Key Bar --- */
        .api-key-bar {
            background-color: #1a1a1a;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
        }
        .api-key-bar label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .api-key-bar .input {
            flex-grow: 1;
            min-width: 200px;
            background-color: var(--bg-tertiary);
        }

        /* --- Tabs --- */
        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }
        .tab-link {
            padding: 12px 18px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
        }
        .tab-link:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        .tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            padding: 24px;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Form Elements --- */
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .subsection-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 16px;
            margin-bottom: 12px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 24px;
        }
        @media (min-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        @media (min-width: 640px) {
            .input-row {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            .input-row .input {
                flex-grow: 1;
            }
        }
        .label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .input, .select {
            width: 100%;
            padding: 10px 12px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color_80);
        }
        .input::placeholder {
            color: #555;
        }
        .select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300E5FF%22%20d%3D%22M287%2069.4a17.6%2017.6%0%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.6-3.6%205.4-7.9%205.4-12.9%200-5-1.8-9.2-5.4-12.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 10px;
        }
        .select option {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .input-addon {
            display: flex;
            align-items: center;
        }
        .input-addon .input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: 0;
        }
        .input-addon .addon {
            padding: 10px 12px;
            font-size: 1rem;
            font-weight: 500;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-left: 0;
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
            color: var(--text-secondary);
        }
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            outline: none;
            border: 1px solid var(--border-color);
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border: 2px solid var(--bg-secondary);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .slider:hover::-webkit-slider-thumb {
            background: var(--primary-hover);
        }
        .slider:hover::-moz-range-thumb {
            background: var(--primary-hover);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }
        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        .btn.btn-primary {
            background-color: var(--primary-color);
            color: #000;
        }
        .btn.btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn.btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn.btn-secondary:hover {
            background-color: var(--border-color);
        }
        .btn.btn-danger {
            background-color: var(--danger-color);
            color: #fff;
        }
        .btn.btn-danger:hover {
            background-color: var(--danger-hover);
        }
        .btn.btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .file-upload-wrapper {
            position: relative;
            display: inline-block;
        }
        #csv-file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        #file-name {
            margin-left: 10px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* --- Results & Outputs --- */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 640px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .result-box {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }
        .result-box-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        .result-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border-color);
        }
        .result-line:last-child {
            border-bottom: none;
        }
        .result-line-label {
            color: var(--text-secondary);
        }
        .result-line-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        .profit { color: var(--success-color); }
        .loss { color: var(--danger-color); }
        .ai-output-box {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            display: none;
        }
        .ai-output-content {
            font-family: monospace;
            white-space: pre-wrap;
            color: var(--text-primary);
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .spinner-container {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
            color: var(--text-secondary);
        }
        .spinner-container .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            position: relative;
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 24px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .modal-close {
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px; /* for scrollbar */
        }
        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ARV Comps Grid --- */
        .comp-grid-header, .comp-grid {
            display: none; /* Mobile first: hide grid */
            grid-template-columns: 2fr 0.5fr 0.5fr 1fr 1fr;
            gap: 10px;
            align-items: flex-end;
        }
        .comp-grid-header {
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        .comp-grid-header .label {
            margin-bottom: 0;
        }
        @media (min-width: 1024px) {
            .comp-grid-header, .comp-grid {
                display: grid;
            }
            .comp-grid .label {
                display: none; /* Hide individual labels on desktop */
            }
        }
        .comp-grid .input-group {
            gap: 0; /* Remove gap for grid */
        }

        /* --- Saved Deals --- */
        .deal-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .deal-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .deal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 229, 255, 0.1);
            border-color: var(--primary-color);
        }
        .deal-card-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .deal-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .deal-card-profit {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .deal-card-body {
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .deal-card-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .deal-card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .deal-card-footer {
            padding: 12px 16px;
            background-color: var(--bg-primary);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        /* --- Tutorial Modal --- */
        #how-to-use-modal .modal-body ul {
            list-style-type: disc;
            padding-left: 20px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        #how-to-use-modal .modal-body li {
            margin-bottom: 8px;
        }
        #how-to-use-modal .modal-body strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        #how-to-use-modal .modal-body code {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* --- Utility Classes --- */
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .pt-4 { padding-top: 1rem; }
        .w-full { width: 100%; }
        .max-w-md { max-width: 28rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container">
        <!-- Header -->
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-white">Homeland Property Flip Calculator</h1>
            <p class="text-lg text-gray-400 mt-2">Your All-in-One Deal Analysis Suite</p>
            <button id="how-to-use-btn" class="text-sm text-cyan-400 hover:text-cyan-300 mt-2 font-medium">
                How to Use This Calculator
            </button>
        </header>

        <div class="calculator-wrapper">
            
            <!-- API Key Bar -->
            <div class="api-key-bar">
                <label for="api-key-input" class="whitespace-nowrap">Google AI API Key:</label>
                <input type="password" id="api-key-input" class="input input-sm" placeholder="Enter your API Key...">
                <button id="save-api-key-btn" class="btn btn-primary btn-sm">
                    <span>Save Key</span>
                </button>
            </div>

            <!-- Tab Navigation -->
            <nav class="tab-nav">
                <a class="tab-link active" onclick="showTab('deal-calculator')">Deal Calculator</a>
                <a class="tab-link" onclick="showTab('mao-calculator')">MAO Calculator</a>
                <a class="tab-link" onclick="showTab('ai-market-analyzer')">AI Market Analyzer</a>
                <a class="tab-link" onclick="showTab('what-if')">What If? (Sensitivity)</a>
                <a class="tab-link" onclick="showTab('batch-analyzer')">Batch Analyzer</a>
                <a class="tab-link" onclick="showTab('saved-deals')">Saved Deals</a>
            </nav>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- ===== Tab Pane: Deal Calculator ===== -->
                <div id="deal-calculator" class="tab-pane active">
                    <div class="grid-container">
                        <!-- Left Column: Inputs -->
                        <div class="space-y-6">
                            <!-- Core Numbers -->
                            <div class="result-box">
                                <h3 class="result-box-title">Core Numbers</h3>
                                <div class="input-group">
                                    <label for="purchase-price" class="label">Purchase Price</label>
                                    <input type="text" id="purchase-price" class="input" placeholder="e.g., 250,000" oninput="formatCurrency(this)">
                                </div>
                                <div class="input-group">
                                    <label for="arv" class="label">After Repair Value (ARV)</label>
                                    <div class="flex">
                                        <input type="text" id="arv" class="input rounded-r-none" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                                        <button id="arv-comps-btn" class="btn btn-secondary rounded-l-none whitespace-nowrap">
                                            ✨ Comps
                                        </button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="rehab-costs" class="label">Rehab Costs</label>
                                    <div class="flex">
                                        <input type="text" id="rehab-costs" class="input rounded-r-none" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                                        <button id="rehab-breakdown-btn" class="btn btn-secondary rounded-l-none whitespace-nowrap">
                                            Tools
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Financing -->
                            <div class="result-box">
                                <h3 class="result-box-title">Financing (Optional)</h3>
                                <div class="input-group">
                                    <label for="financing-type" class="label">Financing Type</label>
                                    <select id="financing-type" class="select">
                                        <option value="cash">All Cash</option>
                                        <option value="loan">Loan</option>
                                    </select>
                                </div>
                                <div id="loan-inputs-container" class="space-y-4 pt-4" style="display: none;">
                                    <div class="input-group">
                                        <label for="down-payment-percent" class="label">Down Payment (%)</label>
                                        <input type="number" id="down-payment-percent" class="input" placeholder="e.g., 20">
                                    </div>
                                    <div class="input-group">
                                        <label for="interest-rate" class="label">Interest Rate (%)</label>
                                        <input type="number" id="interest-rate" class="input" placeholder="e.g., 7.5">
                                    </div>
                                    <div class="input-group">
                                        <label for="loan-points" class="label">Loan Points (%)</label>
                                        <input type="number" id="loan-points" class="input" placeholder="e.g., 2">
                                    </div>
                                    <div class="input-group">
                                        <label for="other-closing-costs" class="label">Other Closing Costs ($)</label>
                                        <input type="text" id="other-closing-costs" class="input" placeholder="e.g., 3,000" oninput="formatCurrency(this)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Holding & Selling Costs -->
                            <div class="result-box">
                                <h3 class="result-box-title">Holding & Selling Costs</h3>
                                <div class="input-group">
                                    <label for="holding-months" class="label">Project Length (Months)</label>
                                    <input type="number" id="holding-months" class="input" placeholder="e.g., 6">
                                </div>
                                <div class="input-group">
                                    <label for="monthly-holding-costs" class="label">Monthly Holding Costs ($)</label>
                                    <input type="text" id="monthly-holding-costs" class="input" placeholder="e.g., 1,000" oninput="formatCurrency(this)">
                                </div>
                                <div class="input-group">
                                    <label for="selling-costs-percent" class="label">Selling Costs (%)</label>
                                    <input type="number" id="selling-costs-percent" class="input" placeholder="e.g., 6">
                                </div>
                                <div class="input-group">
                                    <label for="selling-costs-flat" class="label">Selling Costs (Flat $)</label>
                                    <input type="text" id="selling-costs-flat" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Results -->
                        <div class="space-y-6">
                            <button id="calculate-deal-btn" class="btn btn-primary w-full text-lg">
                                <span>Calculate Deal</span>
                            </button>

                            <div id="results-container" class="result-box" style="display: none;">
                                <h3 class="result-box-title">Deal Summary</h3>
                                <div class="result-line">
                                    <span class="result-line-label">Estimated Gross Profit</span>
                                    <span id="gross-profit-result" class="result-line-value text-2xl profit">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Return on Investment (ROI)</span>
                                    <span id="roi-result" class="result-line-value profit">0.0%</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Annualized ROI</span>
                                    <span id="annualized-roi-result" class="result-line-value profit">0.0%</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Total Cash Needed</span>
                                    <span id="total-cash-needed-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Profit per Month</span>
                                    <span id="profit-per-month-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label" title="Cash-on-Cash ROI (All-Cash Deal)">Total Investment (Cash Deal)</span>
                                    <span id="total-investment-cash-result" class="result-line-value">$0</span>
                                </div>

                                <h3 class="subsection-title">Cost Breakdown</h3>
                                <div class="result-line">
                                    <span class="result-line-label">Purchase Price</span>
                                    <span id="purchase-price-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Rehab Costs</span>
                                    <span id="rehab-costs-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Holding Costs</span>
                                    <span id="total-holding-costs-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Financing Costs</span>
                                    <span id="total-financing-costs-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Selling Costs</span>
                                    <span id="total-selling-costs-result" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line total-line">
                                    <span class="result-line-label">Total Costs</span>
                                    <span id="total-costs-result" class="result-line-value">$0</span>
                                </div>

                                <h3 class="subsection-title">Profit Check</h3>
                                <div class="result-line text-sm">
                                    <span class="result-line-label">Est. ARV</span>
                                    <span id="profit-check-arv" class="result-line-value">$0</span>
                                </div>
                                <div class="result-line text-sm">
                                    <span class="result-line-label">Total Costs</span>
                                    <span id="profit-check-costs" class="result-line-value loss">($0)</span>
                                </div>
                                <div class="result-line total-line">
                                    <span class="result-line-label">Profit</span>
                                    <span id="profit-check-result" class="result-line-value profit">$0</span>
                                </div>

                                <!-- AI Summary & Actions -->
                                <div class="mt-6 space-y-3">
                                    <button id="get-deal-summary-btn" class="btn btn-secondary w-full">
                                        <span class="spinner"></span>
                                        <span>✨ Get AI Deal Summary</span>
                                    </button>
                                    <div id="ai-summary-container" class="ai-output-box" style="display: none;">
                                        <div id="ai-summary-spinner" class="spinner-container" style="display: none;">
                                            <div class="spinner-sm"></div>
                                        </div>
                                        <pre id="ai-summary-content" class="ai-output-content"></pre>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="save-deal-btn" class="btn btn-secondary w-full">💾 Save Deal</button>
                                        <button id="print-report-btn" class="btn btn-secondary w-full">🖨️ Print Report</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Deal Calculator Tab Pane -->

                <!-- ===== ARV Comps Modal ===== -->
                <div id="arv-modal" class="modal-overlay">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">ARV Comps Calculator</h3>
                            <span id="arv-modal-close" class="modal-close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <!-- AI Comp Finder -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI Comp Finder</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="input-group md:col-span-3">
                                        <label for="subject-address" class="label">Subject Property Address</label>
                                        <input type="text" id="subject-address" class="input" placeholder="e.g., 123 Main St, Denver, CO 80210">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-comp-radius" class="label">Radius (miles)</label>
                                        <input type="number" id="ai-comp-radius" class="input" placeholder="e.g., 3" value="3">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-comp-status" class="label">Comp Status</label>
                                        <select id="ai-comp-status" class="select">
                                            <option value="Sold">Sold Comps</option>
                                            <option value="For Sale">For Sale Comps</option>
                                        </select>
                                    </div>
                                    <div class="input-group" id="ai-sold-since-container">
                                        <label for="ai-sold-since" class="label">Sold Since</label>
                                        <select id="ai-sold-since" class="select">
                                            <option value="3 months">Last 3 Months</option>
                                            <option value="1 month">Last 1 Month</option>
                                            <option value="6 months">Last 6 Months</option>
                                            <option value="12 months">Last 12 Months</option>
                                            <option value="24 months">Last 24 Months</option>
                                            <option value="36 months">Last 36 Months</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="ai-comp-finder-btn" class="btn btn-primary w-full mt-4">
                                    <span class="spinner"></span>
                                    <span>✨ Find Comps with AI</span>
                                </button>
                                <p id="ai-comp-finder-status" class="text-sm text-center mt-2" style="display: none;"></p>
                            </div>
                            
                            <!-- Manual Comps Table -->
                            <h4 class="subsection-title">Manual Comps</h4>
                            <div class="input-group mb-4 w-full md:w-1/3">
                                <label for="subject-sqft" class="label">Subject Property Sq. Ft.</label>
                                <input type="text" id="subject-sqft" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                            </div>
                            <div class="comp-grid-header">
                                <span>Address</span>
                                <span>Beds</span>
                                <span>Baths</span>
                                <span>Sq. Ft.</span>
                                <span>Sale Price</span>
                            </div>
                            <div id="comps-list-container" class="space-y-2 mb-4">
                                <!-- Comp rows injected by JS -->
                            </div>
                            <button id="add-comp-row-btn" class="btn btn-secondary btn-sm">Add Comp Row</button>

                            <!-- ARV Results -->
                            <div class="mt-6 pt-6 border-t border-gray-700">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="result-box text-center">
                                        <span class="result-line-label block">Avg. Price / Sq. Ft.</span>
                                        <span id="avg-price-per-sqft-result" class="result-line-value text-2xl profit">$0</span>
                                    </div>
                                    <div class="result-box text-center">
                                        <span class="result-line-label block">Estimated ARV</span>
                                        <span id="estimated-arv-result" class="result-line-value text-2xl profit">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="use-arv-btn" class="btn btn-primary">Use this ARV</button>
                        </div>
                    </div>
                </div>

                <!-- ===== AI Rehab Breakdown Modal ===== -->
                <div id="rehab-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Rehab Cost Estimator</h3>
                            <span id="rehab-modal-close" class="modal-close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <!-- AI Estimator -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI Rehab Cost Estimator</h4>
                                <div class="input-group mb-4">
                                    <label for="rehab-description" class="label">Describe the Rehab</label>
                                    <textarea id="rehab-description" class="input" rows="3" placeholder="e.g., Full kitchen gut, 2 new bathrooms, new flooring throughout, interior and exterior paint."></textarea>
                                </div>
                                <div class="input-group mb-4">
                                    <label for="subject-sqft-rehab" class="label">Property Sq. Ft.</label>
                                    <input type="text" id="subject-sqft-rehab" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                                </div>
                                <button id="ai-rehab-btn" class="btn btn-primary w-full">
                                    <span class="spinner"></span>
                                    <span>✨ Generate AI Estimate</span>
                                </button>
                                <div id="ai-rehab-output" class="ai-output-box" style="display: none;">
                                    <div id="ai-rehab-cost-output" class="mb-4">
                                        <!-- AI Cost injected here -->
                                    </div>
                                    <pre id="ai-rehab-content" class="ai-output-content"></pre>
                                </div>
                            </div>
                            
                            <!-- Manual Itemization -->
                            <h4 class="subsection-title">Manual Itemization</h4>
                            <div id="manual-rehab-list" class="space-y-2 mb-4">
                                <!-- Itemized rows injected by JS -->
                            </div>
                            <button id="add-rehab-item-btn" class="btn btn-secondary btn-sm">Add Item</button>
                            
                            <div class="mt-4 pt-4 border-t border-gray-700">
                                <div class="result-line" style="border-bottom: none;">
                                    <span class="result-line-label">Total Itemized Cost</span>
                                    <span id="manual-rehab-total" class="result-line-value text-xl profit">$0</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ===== Tab Pane: MAO Calculator ===== -->
                <div id="mao-calculator" class="tab-pane">
                    <div class="grid-container">
                        <!-- Quick MAO Rule -->
                        <div class="result-box space-y-4">
                            <h3 class="result-box-title">Quick MAO Rule (e.g., The 70% Rule)</h3>
                            <p class="text-sm text-gray-400 -mt-2">
                                The 70% Rule is a common benchmark stating you should pay no more than 70% of the ARV, minus rehab costs.
                                <br>
                                <span class="text-cyan-400">Higher %</span> = More aggressive offer, less profit.
                                <br>
                                <span class="text-red-400">Lower %</span> = More conservative offer, more profit.
                            </p>
                            <div class="input-group">
                                <label for="mao-rule-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-rule-arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-rule-rehab" class="label">Rehab Costs</label>
                                <input type="text" id="mao-rule-rehab" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-rule-slider" class="label">MAO Percentage: <span id="mao-rule-percent" class="text-cyan-400 font-bold">70%</span></label>
                                <input type="range" id="mao-rule-slider" class="slider" min="50" max="100" value="70">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer (MAO)</span>
                                <span id="mao-rule-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>

                        <!-- MAO by Desired Profit -->
                        <div class="result-box space-y-4">
                            <h3 class="result-box-title">MAO by Desired Profit</h3>
                            <div class="input-group">
                                <label for="mao-profit-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-profit-arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-rehab" class="label">Rehab Costs</label>
                                <input type="text" id="mao-profit-rehab" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-holding" class="label">All Holding & Selling Costs</label>
                                <input type="text" id="mao-profit-holding" class_name="input" placeholder="e.g., 40,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-desired" class="label">Desired Profit</label>
                                <input type="text" id="mao-profit-desired" class="input" placeholder="e.g., 60,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer (MAO)</span>
                                <span id="mao-profit-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>
                    </div>
                </div> <!-- End MAO Calculator Tab Pane -->

                <!-- ===== Tab Pane: AI Market Analyzer ===== -->
                <div id="ai-market-analyzer" class="tab-pane">
                    <div class="grid-container">
                        <!-- AI Neighborhood Analysis -->
                        <div class="result-box space-y-4">
                            <h3 class="result-box-title">AI Neighborhood Analysis</h3>
                            <div class="input-group">
                                <label for="ai-market-address" class="label">Address or Zip Code</label>
                                <input type="text" id="ai-market-address" class="input" placeholder="e.g., 80210">
                            </div>
                            <button id="ai-market-btn" class="btn btn-primary w-full">
                                <span class="spinner"></span>
                                <span>✨ Analyze Market</span>
                            </button>
                            <div id="ai-market-output" class="ai-output-box" style="display: none;">
                                <pre id="ai-market-content" class="ai-output-content"></pre>
                            </div>
                        </div>
                        
                        <!-- Market Velocity -->
                        <div class="result-box space-y-4">
                            <h3 class="result-box-title">Market Velocity (Sell-Through Rate)</h3>
                            
                            <!-- AI Velocity -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                                <h4 class="subsection-title mt-0">AI-Powered Velocity Search</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="ai-velocity-zip" class="label">Zip Code</label>
                                        <input type="text" id="ai-velocity-zip" class="input" placeholder="e.g., 80210">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-velocity-type" class="label">Property Type (Optional)</label>
                                        <input type="text" id="ai-velocity-type" class="input" placeholder="e.g., 3-bed homes">
                                    </div>
                                </div>
                                <button id="ai-velocity-btn" class="btn btn-primary w-full mt-4">
                                    <span class="spinner"></span>
                                    <span>✨ AI-Powered Velocity Search</span>
                                </button>
                                <p id="ai-velocity-status" class="text-sm text-center mt-2" style="display: none;"></p>
                            </div>

                            <!-- Manual Velocity -->
                            <h4 class="subsection-title">Manual Calculator</h4>
                            <div class="input-group">
                                <label for="velocity-sold" class="label">Homes Sold (Last 30 Days)</label>
                                <input type="number" id="velocity-sold" class="input" placeholder="e.g., 20">
                            </div>
                            <div class="input-group">
                                <label for="velocity-inventory" class="label">Total Homes for Sale</label>
                                <input type="number" id="velocity-inventory" class="input" placeholder="e.g., 100">
                            </div>
                            <button id="velocity-calculate-btn" class="btn btn-secondary w-full">Calculate Rate</button>
                            
                            <div id="velocity-results-container" style="display: none;">
                                <div class="result-line mt-4">
                                    <span class="result-line-label">Sell-Through Rate</span>
                                    <span id="velocity-rate-result" class="result-line-value text-xl profit">0.0%</span>
                                </div>
                                <div class="result-line total-line">
                                    <span class="result-line-label">Market Type</span>
                                    <span id="velocity-market-result" class="result-line-value text-2xl profit">---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End AI Market Analyzer Tab Pane -->

                <!-- ===== Tab Pane: What If? ===== -->
                <div id="what-if" class="tab-pane">
                    <div class="result-box overflow-x-auto">
                        <h3 class="result-box-title">"What If?" Sensitivity Analysis</h3>
                        <p class="text-sm text-gray-400 -mt-2 mb-4">
                            This table shows your estimated profit based on changes in your ARV and Rehab Costs.
                            <br>
                            Your base calculation is the <span class="bg-cyan-900/50 px-2 py-1 rounded">blue cell</span>.
                        </p>
                        <table class="what-if-table">
                            <thead>
                                <tr>
                                    <th class="text-left">Profit</th>
                                    <th class="text-center">Rehab -10%</th>
                                    <th class="text-center">Base Rehab</th>
                                    <th class="text-center">Rehab +10%</th>
                                    <th class="text-center">Rehab +20%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-left">ARV +5%</td>
                                    <td id="what-if-arv-high-rehab-low">---</td>
                                    <td id="what-if-arv-high-rehab-mid">---</td>
                                    <td id="what-if-arv-high-rehab-high">---</td>
                                    <td id="what-if-arv-high-rehab-over">---</td>
                                </tr>
                                <tr>
                                    <td class="text-left">Base ARV</td>
                                    <td id="what-if-arv-mid-rehab-low">---</td>
                                    <td id="what-if-profit-base" class="base-cell">---</td>
                                    <td id="what-if-arv-mid-rehab-high">---</td>
                                    <td id="what-if-arv-mid-rehab-over">---</td>
                                </tr>
                                <tr>
                                    <td class="text-left">ARV -5%</td>
                                    <td id="what-if-arv-low-rehab-low">---</td>
                                    <td id="what-if-arv-low-rehab-mid">---</td>
                                    <td id="what-if-arv-low-rehab-high">---</td>
                                    <td id="what-if-arv-low-rehab-over">---</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div> <!-- End What If? Tab Pane -->

                <!-- ===== Tab Pane: Batch Analyzer ===== -->
                <div id="batch-analyzer" class="tab-pane">
                    <div class="result-box space-y-4">
                        <h3 class="result-box-title">Batch Deal Analyzer</h3>
                        <p class="text-sm text-gray-400 -mt-2">
                            Upload a CSV file of properties to analyze the first 10 deals at once.
                        </p>
                        
                        <div class="input-group">
                            <label class="label">1. Upload CSV File</label>
                            <label class="file-input-label" for="csv-file-input">
                                <span>Choose File</span>
                                <span id="file-name" class="file-name-display">No file chosen</span>
                            </label>
                            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        </div>

                        <div class="input-group">
                            <label class="label">2. Map CSV Columns</label>
                            <button id="map-columns-btn" class="btn btn-secondary w-full" disabled>Map Columns</button>
                        </div>
                        
                        <div class="input-group">
                            <label for="batch-rehab-cost" class="label">3. Default Rehab Cost ($)</label>
                            <input type="text" id="batch-rehab-cost" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                        </div>
                        
                        <button id="run-batch-btn" class="btn btn-primary w-full" disabled>
                            <span class="spinner"></span>
                            <span>Analyze First 10 Properties</span>
                        </button>
                    </div>

                    <div id="batch-results-container" class="result-box mt-6" style="display: none;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="result-box-title">Batch Results</h3>
                            <button id="download-batch-csv-btn" class="btn btn-secondary btn-sm">Download Results</button>
                        </div>
                        <p id="batch-status-text" class="text-sm text-gray-400 mb-4"></p>
                        <div class="overflow-x-auto">
                            <table class="what-if-table w-full">
                                <thead id="batch-results-table-head">
                                    <!-- Headers injected by JS -->
                                </thead>
                                <tbody id="batch-results-table-body">
                                    <!-- Results injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div> <!-- End Batch Analyzer Tab Pane -->

                <!-- ===== Tab Pane: Saved Deals ===== -->
                <div id="saved-deals" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">Saved Deals</h3>
                    </div>
                    <div id="saved-deals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                        <!-- Deal cards injected by JS -->
                        <div id="no-saved-deals" class="text-gray-400">You have no saved deals.</div>
                    </div>
                </div> <!-- End Saved Deals Tab Pane -->

            </div> <!-- End Tab Content -->
        </div>
    </div>

    <!-- ===== Modals ===== -->
    
    <!-- How-to-Use Modal -->
    <div id="how-to-use-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">How to Use This Calculator</h3>
                <span id="how-to-use-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <h4 class="subsection-title mt-0">Core Workflow (1-2-3)</h4>
                <ol class="list-decimal list-inside space-y-2 mb-6">
                    <li>
                        <strong>Fill out the "Deal Calculator" tab.</strong> 
                        Enter your Purchase Price, Rehab Costs, and ARV. Use the "✨ Comps" button to find an accurate ARV with AI.
                    </li>
                    <li>
                        <strong>Click "Calculate Deal".</strong> 
                        Instantly see your potential Profit, ROI, and Total Cash Needed in the "Deal Summary."
                    </li>
                    <li>
                        <strong>Check the other tabs.</strong> 
                        The calculator automatically uses your data to populate the "MAO Calculator" and "What If?" tabs for deeper analysis.
                    </li>
                </ol>

                <h4 class="subsection-title">Feature Breakdown</h4>
                <p class="mb-2"><strong>API Key (At the Top)</strong></p>
                <p class="modal-text">
                    This is required for all "✨" AI features. Get a free key from Google AI Studio and paste it here. The calculator saves it in your browser.
                </p>

                <p class="mb-2 mt-4"><strong>Tab 1: Deal Calculator</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li><strong>Core Numbers:</strong> Your main inputs. The "✨ Comps" button is the most powerful tool here. It opens the ARV Comps Calculator.</li>
                    <li><strong>ARV Comps Calculator:</strong> Manually enter comps or use the "AI Comp Finder". This tool searches Google for comps based on your address, radius, and timeframes. It then auto-fills the table and calculates your ARV.</li>
                    <li><strong>Rehab Tools:</strong> Click the "Tools" button to open the Rehab Cost Estimator. You can describe your project and have the AI generate a budget breakdown and cost estimate, or you can itemize your costs manually.</li>
                    <li><strong>Deal Summary:</strong> Your main results. The "AI Deal Summary" button provides a written analysis of the deal.</li>
                </ul>

                <p class="mb-2 mt-4"><strong>Tab 2: MAO Calculator</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li><strong>Quick MAO Rule:</strong> Uses the 70% rule (or any % you choose with the slider) to give you a fast "Max Allowable Offer" (MAO).</li>
                    <li><strong>MAO by Desired Profit:</strong> A more precise tool. It calculates the MAO by working backward from your ARV and desired profit.</li>
                </ul>
                
                <p class="mb-2 mt-4"><strong>Tab 3: AI Market Analyzer</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li><strong>AI Neighborhood Analysis:</strong> Enter a zip code or address to get an AI-powered summary of market trends, school ratings, and local amenities.</li>
                    <li><strong>Market Velocity:</strong> This shows you how "hot" a market is. You can use the "AI-Powered Velocity Search" to find the data for a zip code, or enter your own numbers manually.</li>
                </ul>
                
                <p class="mb-2 mt-4"><strong>Tab 4: "What If?"</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li>This "Sensitivity Analysis" table automatically shows you how your profit changes if your ARV is lower or your rehab costs are higher than you planned.</li>
                </ul>
                
                <p class="mb-2 mt-4"><strong>Tab 5: Batch Analyzer</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li>**1. Upload CSV:** Upload your list of properties.</li>
                    <li>**2. Map Columns:** Tell the calculator which columns in your file are the Address, Sq. Ft., etc.</li>
                    <li>**3. Analyze:** The tool will run the first 10 properties through the AI Comp Finder to estimate an ARV and calculate the potential profit for each. You can then download the results as a new CSV.</li>
                </ul>

                <p class="mb-2 mt-4"><strong>Tab 6: Saved Deals</strong></p>
                <ul class="list-disc list-inside space-y-2 modal-text">
                    <li>After calculating a deal, click "💾 Save Deal". You can name it and it will appear here. Click "Load" to instantly repopulate the calculator with that deal's numbers.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="how-to-use-close-btn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Save Deal Modal -->
    <div id="save-deal-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Save Deal</h3>
                <span id="save-deal-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="save-deal-name" class="label">Deal Name or Address</label>
                    <input type="text" id="save-deal-name" class="input" placeholder="e.g., 123 Main St">
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-save-deal-btn" class="btn btn-primary">Save Deal</button>
            </div>
        </div>
    </div>
    
    <!-- Batch Map Modal -->
    <div id="batch-map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Map CSV Columns</h3>
                <span id="batch-map-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-text">Tell the calculator which columns in your CSV file match these fields.</p>
                
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 my-4">
                    <h4 class="subsection-title mt-0">Address (Option 1 - Full Address)</h4>
                    <div class="input-group">
                        <label for="map-full-address" class="label">Full Address</label>
                        <select id="map-full-address" class="select map-select"></select>
                    </div>
                </div>

                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 my-4">
                    <h4 class="subsection-title mt-0">Address (Option 2 - Separated)</h4>
                    <div class="input-group">
                        <label for="map-street-address" class="label">Street Address</label>
                        <select id="map-street-address" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-city" class="label">City</label>
                        <select id="map-city" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-state" class="label">State</label>
                        <select id="map-state" class="select map-select"></select>
                    </div>
                </div>
                
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 my-4">
                    <h4 class="subsection-title mt-0">Required Fields</h4>
                    <div class="input-group">
                        <label for="map-zip-code" class="label">Zip Code (Required for AI)</label>
                        <select id="map-zip-code" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-sqft" class="label">Square Footage (Required)</label>
                        <select id="map-sqft" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-purchase-price" class="label">Current Value / Est. Purchase Price (Required)</label>
                        <select id="map-purchase-price" class="select map-select"></select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-map-btn" class="btn btn-primary">Save Mapping</button>
            </div>
        </div>
    </div>

    <!-- ===== Main App Script ===== -->
    <script>
        console.log("Homeland Property Flip Calculator script loaded.");

        // --- Global State ---
        // We'll store the full deal object here for "What If" and "Save"
        let currentDealData = null; 
        let savedDeals = [];
        let arvComps = []; // Array to hold comp objects
        let csvData = [];
        let csvHeaders = [];
        let csvColumnMapping = {};
        let rehabItems = []; // For itemized rehab

        // --- Helper Functions ---
        const getById = (id) => document.getElementById(id);
        
        const currencyFormatter = (value) => {
            if (isNaN(value)) return "---";
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        };

        const percentFormatter = (value) => {
            if (isNaN(value)) return "---";
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1,
            }).format(value);
        };

        const parseCurrency = (value) => {
            if (typeof value !== 'string') {
                value = String(value);
            }
            return parseFloat(value.replace(/[^0-9.-]+/g, '')) || 0;
        };
        
        const formatCurrencyInput = (input) => {
            let value = input.value;
            // Handle negative numbers
            let isNegative = value.startsWith('-');
            let num = parseCurrency(value);
            if (isNaN(num)) {
                input.value = '';
            } else {
                // Format the absolute value
                let formattedValue = new Intl.NumberFormat('en-US').format(Math.abs(num));
                // Add the negative sign back if it was there and the number isn't zero
                input.value = isNegative && num !== 0 ? '-' + formattedValue : formattedValue;
            }
        };

        const toggleSpinner = (btnId, textContent, show) => {
            const btn = getById(btnId);
            if (!btn) return;
            const spinner = btn.querySelector('.spinner');
            const text = btn.querySelector('span:not(.spinner)');
            
            if (show) {
                btn.disabled = true;
                if (spinner) spinner.style.display = 'inline-block';
                if (text) text.textContent = 'Loading...';
            } else {
                btn.disabled = false;
                if (spinner) spinner.style.display = 'none';
                if (text) text.textContent = textContent;
            }
        };

        const openModal = (id) => getById(id).style.display = 'block';
        const closeModal = (id) => getById(id).style.display = 'none';
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white z-50';
            if (type === 'success') {
                toast.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'error') {
                toast.style.backgroundColor = 'var(--danger-color)';
            } else {
                toast.style.backgroundColor = 'var(--primary-color)';
            }
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s ease';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
        };

        // --- Core Deal Calculation ---
        function getDealInputs() {
            return {
                purchasePrice: parseCurrency(getById('purchase-price').value),
                arv: parseCurrency(getById('arv').value),
                rehabCosts: parseCurrency(getById('rehab-costs').value),
                financingType: getById('financing-type').value,
                downPaymentPercent: parseFloat(getById('down-payment-percent').value) / 100 || 0,
                interestRate: parseFloat(getById('interest-rate').value) / 100 || 0,
                loanPoints: parseFloat(getById('loan-points').value) / 100 || 0,
                otherClosingCosts: parseCurrency(getById('other-closing-costs').value),
                holdingMonths: parseInt(getById('holding-months').value) || 0,
                monthlyHoldingCosts: parseCurrency(getById('monthly-holding-costs').value),
                sellingCostsPercent: parseFloat(getById('selling-costs-percent').value) / 100 || 0,
                sellingCostsFlat: parseCurrency(getById('selling-costs-flat').value),
            };
        }

        function calculateDeal(dealInputs) {
            const {
                purchasePrice, arv, rehabCosts, financingType, downPaymentPercent,
                interestRate, loanPoints, otherClosingCosts, holdingMonths,
                monthlyHoldingCosts, sellingCostsPercent, sellingCostsFlat
            } = dealInputs;

            let loanAmount = 0;
            let totalFinancingCosts = 0;
            let downPayment = 0;
            let upfrontCash = 0;

            const totalHoldingCosts = monthlyHoldingCosts * holdingMonths;
            const totalSellingCosts = (arv * sellingCostsPercent) + sellingCostsFlat;

            if (financingType === 'loan') {
                loanAmount = purchasePrice * (1 - downPaymentPercent);
                downPayment = purchasePrice * downPaymentPercent;
                // Calculate points on total loan amount (purchase loan + rehab if financed)
                // Assuming rehab is financed if loan is chosen, common in fix/flip
                const financedRehab = rehabCosts; // Assuming 100% rehab finance
                const totalLoanAmount = loanAmount + financedRehab;
                const pointsCost = totalLoanAmount * loanPoints;
                
                // Interest cost calculation on outstanding balance
                // Simple interest model for holding period
                const interestCost = (totalLoanAmount * interestRate / 12) * holdingMonths;
                
                totalFinancingCosts = pointsCost + interestCost + otherClosingCosts;
                
                // Total cash needed = down payment + upfront closing costs + rehab (if not financed) + holding + selling
                // Assuming rehab is NOT financed (common for total cash calculation)
                upfrontCash = downPayment + otherClosingCosts + pointsCost;
                totalCashNeeded = upfrontCash + rehabCosts + totalHoldingCosts + interestCost;

            } else {
                // All cash deal
                totalCashNeeded = purchasePrice + rehabCosts + totalHoldingCosts + totalSellingCosts;
            }

            const totalCosts = purchasePrice + rehabCosts + totalHoldingCosts + totalFinancingCosts + totalSellingCosts;
            const grossProfit = arv - totalCosts;

            let roi = 0;
            if (totalCashNeeded > 0) {
                 roi = grossProfit / totalCashNeeded;
            } else if (grossProfit > 0) {
                roi = Infinity; // Handle no-money-down case
            }
            
            const annualizedRoi = (holdingMonths > 0) ? (roi / holdingMonths) * 12 : (roi > 0 ? Infinity : 0);
            const profitPerMonth = holdingMonths > 0 ? grossProfit / holdingMonths : 0;
            
            const totalInvestmentCash = purchasePrice + rehabCosts + totalHoldingCosts + totalSellingCosts;

            return {
                ...dealInputs, // Store inputs for saving
                grossProfit,
                roi,
                annualizedRoi,
                totalCashNeeded,
                totalInvestmentCash,
                profitPerMonth,
                totalCosts,
                totalHoldingCosts,
                totalFinancingCosts,
                totalSellingCosts,
            };
        }

        function displayDealResults(results) {
            currentDealData = results; // Save for other tabs

            getById('gross-profit-result').textContent = currencyFormatter(results.grossProfit);
            getById('gross-profit-result').className = `result-line-value text-2xl ${results.grossProfit >= 0 ? 'profit' : 'loss'}`;
            
            getById('roi-result').textContent = percentFormatter(results.roi);
            getById('roi-result').className = `result-line-value ${results.roi >= 0 ? 'profit' : 'loss'}`;
            
            getById('annualized-roi-result').textContent = percentFormatter(results.annualizedRoi);
            getById('annualized-roi-result').className = `result-line-value ${results.annualizedRoi >= 0 ? 'profit' : 'loss'}`;

            getById('total-cash-needed-result').textContent = currencyFormatter(results.totalCashNeeded);
            getById('total-investment-cash-result').textContent = currencyFormatter(results.totalInvestmentCash);
            getById('profit-per-month-result').textContent = currencyFormatter(results.profitPerMonth);
            
            getById('purchase-price-result').textContent = currencyFormatter(results.purchasePrice);
            getById('rehab-costs-result').textContent = currencyFormatter(results.rehabCosts);
            getById('total-holding-costs-result').textContent = currencyFormatter(results.totalHoldingCosts);
            getById('total-financing-costs-result').textContent = currencyFormatter(results.totalFinancingCosts);
            getById('total-selling-costs-result').textContent = currencyFormatter(results.totalSellingCosts);
            getById('total-costs-result').textContent = currencyFormatter(results.totalCosts);
            
            getById('profit-check-arv').textContent = currencyFormatter(results.arv);
            getById('profit-check-costs').textContent = `(${currencyFormatter(results.totalCosts)})`;
            getById('profit-check-result').textContent = currencyFormatter(results.arv - results.totalCosts);
            
            getById('results-container').style.display = 'block';
            getById('ai-summary-container').style.display = 'none'; // Hide old summary
            getById('ai-summary-content').textContent = '';
            
            // Auto-populate other tabs
            syncArvFields(results.arv, 'arv');
            getById('mao-rule-rehab').value = new Intl.NumberFormat('en-US').format(results.rehabCosts);
            getById('mao-profit-rehab').value = new Intl.NumberFormat('en-US').format(results.rehabCosts);
            const holdingAndSelling = results.totalHoldingCosts + results.totalFinancingCosts + results.totalSellingCosts;
            getById('mao-profit-holding').value = new Intl.NumberFormat('en-US').format(holdingAndSelling);
            
            // Trigger MAO calcs
            calculateMaoRule();
            calculateMaoProfit();

            // Trigger "What If" calculation
            calculateWhatIf();
        }

        // --- Gemini API Function ---
        async function callGeminiAPI(userQuery, systemPrompt, jsonSchema = null, useGoogleSearch = false, retries = 3) {
            const apiKey = localStorage.getItem('geminiApiKey') || "";
            if (!apiKey) {
                return { error: "Error: API Key is missing. Please enter your Google AI Studio API Key at the top of the calculator and click 'Save Key'." };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
            };

            if (systemPrompt) {
                payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            }

            if (useGoogleSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                };
            }
            
            // This is the combined request logic for Search + JSON
            // If we use Google Search AND a JSON schema, we must put the system prompt in the user query.
            if (useGoogleSearch && jsonSchema) {
                payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: systemPrompt + "\n\nUser Query: " + userQuery }]
                    }],
                    tools: [{ "google_search": {} }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: jsonSchema
                    }
                };
                // Remove systemInstruction as it conflicts
                delete payload.systemInstruction;
            } else if (useGoogleSearch && !jsonSchema) {
                // This is for the AI Comp Finder, which does search but *not* a schema
                // Use a simpler prompt structure that is less likely to fail
                const combinedPrompt = systemPrompt + "\n\nHere is the user query: " + userQuery;
                payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: combinedPrompt }]
                    }],
                    tools: [{ "google_search": {} }]
                };
                delete payload.systemInstruction;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorBody;
                    try {
                        errorBody = await response.json();
                        console.error("Gemini API Error Body:", errorBody);
                    } catch (e) {
                        console.error("Could not parse error body:", e);
                        errorBody = { error: { message: "An unknown error occurred." } };
                    }

                    let errorMsg = `HTTP error! status: ${response.status}`;
                    const errorReason = errorBody?.error?.details?.[0]?.reason;

                    if (response.status === 400 && errorReason === "API_KEY_INVALID") {
                        errorMsg = "Error: API Key Not Valid. The key you entered is incorrect or has expired. Please get a new key from Google AI Studio.";
                    } else if (response.status === 401 || response.status === 403) {
                        errorMsg = "Error: API Key is invalid or unauthorized. Please check your Google AI Studio API Key and permissions.";
                    } else if (errorBody?.error?.message) {
                        errorMsg = errorBody.error.message;
                    }
                    
                    return { error: new Error(errorMsg) };
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    // Clean up markdown if AI returns it
                    text = text.replace(/^```json\n/, '').replace(/\n```$/, '');
                    return { text };
                } else {
                    return { error: new Error("Invalid response structure from API.") };
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (retries > 0) {
                    console.log(`Retrying... (${retries} attempts left)`);
                    await new Promise(res => setTimeout(res, (4 - retries) * 1000)); // Exponential backoff
                    return callGeminiAPI(userQuery, systemPrompt, jsonSchema, useGoogleSearch, retries - 1);
                }
                return { error };
            }
        }

        // --- ARV Comps Calculator Logic ---
        function addCompRow(comp = {}) {
            const container = getById('comps-list-container');
            const compId = `comp-${arvComps.length}`;
            const newRow = document.createElement('div');
            newRow.className = 'comp-grid mb-2';
            newRow.id = compId;
            newRow.innerHTML = `
                <div class="input-group">
                    <label for="${compId}-address" class="label md:hidden">Address</label>
                    <input type="text" id="${compId}-address" class="input comp-address" placeholder="123 Main St" value="${comp.address || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-beds" class="label md:hidden">Beds</label>
                    <input type="number" id="${compId}-beds" class="input comp-beds" placeholder="Beds" value="${comp.beds || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-baths" class="label md:hidden">Baths</label>
                    <input type="number" id="${compId}-baths" class="input comp-baths" placeholder="Baths" value="${comp.baths || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-sqft" class="label md:hidden">Sq. Ft.</label>
                    <input type="text" id="${compId}-sqft" class="input comp-sqft" placeholder="1,400" value="${comp.sqft || ''}" oninput="formatCurrency(this)">
                </div>
                <div class="input-group">
                    <label for="${compId}-price" class="label md:hidden">Sale Price</label>
                    <input type="text" id="${compId}-price" class="input comp-price" placeholder="410,000" value="${comp.salePrice || ''}" oninput="formatCurrency(this)">
                </div>
            `;
            container.appendChild(newRow);
            
            // Add listeners to re-calculate on change
            newRow.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', calculateArv);
                if (input.classList.contains('comp-sqft') || input.classList.contains('comp-price')) {
                    input.addEventListener('input', () => formatCurrencyInput(input));
                }
            });

            arvComps.push(newRow); // Add to our tracked array
        }

        function calculateArv() {
            let totalSqft = 0;
            let totalPrice = 0;
            let compCount = 0;

            getById('comps-list-container').querySelectorAll('.comp-grid').forEach(row => {
                const sqft = parseCurrency(row.querySelector('.comp-sqft').value);
                const price = parseCurrency(row.querySelector('.comp-price').value);
                
                if (sqft > 0 && price > 0) {
                    totalSqft += sqft;
                    totalPrice += price;
                    compCount++;
                }
            });

            const avgPricePerSqft = compCount > 0 ? totalPrice / totalSqft : 0;
            const subjectSqft = parseCurrency(getById('subject-sqft').value);
            const estimatedArv = subjectSqft * avgPricePerSqft;

            getById('avg-price-per-sqft-result').textContent = currencyFormatter(avgPricePerSqft);
            getById('estimated-arv-result').textContent = currencyFormatter(estimatedArv);

            return estimatedArv;
        }

        // --- Rehab Cost Estimator Logic ---
        function addRehabItem(item = {}) {
            const container = getById('manual-rehab-list');
            const itemId = `rehab-item-${rehabItems.length}`;
            const newRow = document.createElement('div');
            newRow.className = 'rehab-item-grid';
            newRow.id = itemId;
            newRow.innerHTML = `
                <input type="text" class="input" placeholder="Item (e.g., Kitchen)" value="${item.name || ''}">
                <input type="text" class="input" placeholder="Cost (e.g., 15,000)" value="${item.cost || ''}" oninput="formatCurrency(this)">
                <button class="btn-icon">&times;</button>
            `;
            
            newRow.querySelector('button').addEventListener('click', () => {
                newRow.remove();
                rehabItems = rehabItems.filter(i => i.id !== itemId);
                updateManualRehabTotal();
            });
            
            newRow.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateManualRehabTotal);
                if (input.placeholder.startsWith('Cost')) {
                    input.addEventListener('input', () => formatCurrencyInput(input));
                }
            });

            container.appendChild(newRow);
            rehabItems.push({ id: itemId, element: newRow });
            updateManualRehabTotal();
        }
        
        function updateManualRehabTotal() {
            let total = 0;
            getById('manual-rehab-list').querySelectorAll('.rehab-item-grid').forEach(row => {
                const cost = parseCurrency(row.querySelectorAll('input')[1].value);
                total += cost;
            });
            getById('manual-rehab-total').textContent = currencyFormatter(total);
            
            // Also update the main rehab cost field
            getById('rehab-costs').value = new Intl.NumberFormat('en-US').format(total);
            return total;
        }

        async function runAiRehabEstimate() {
            const description = getById('rehab-description').value.trim();
            const sqft = parseCurrency(getById('subject-sqft-rehab').value);
            
            if (!description || sqft === 0) {
                showToast("Please enter a rehab description and property square footage.", "error");
                return;
            }
            
            toggleSpinner('ai-rehab-btn', 'Generate AI Estimate', true);
            const outputDiv = getById('ai-rehab-output');
            const costOutputDiv = getById('ai-rehab-cost-output');
            const contentP = getById('ai-rehab-content');
            outputDiv.style.display = 'block';

            // --- Two-Step AI Rehab Estimate ---
            // Step 1: Get Budget Breakdown (Percentages)
            const breakdownQuery = `Generate a typical budget allocation checklist (using percentages) for a house flip with the following rehab description: "${description}"`;
            const breakdownPrompt = "You are a general contractor. Provide a simple, bulleted checklist of rehab items and their estimated percentage of the total budget. Do not add any introductory or concluding text. Just the list.";
            const breakdownResult = await callGeminiAPI(breakdownQuery, breakdownPrompt);
            
            if (breakdownResult.error) {
                toggleSpinner('ai-rehab-btn', 'Generate AI Estimate', false);
                contentP.textContent = breakdownResult.error.message;
                return;
            }
            
            contentP.textContent = breakdownResult.text; // Show breakdown first

            // Step 2: Get Total Cost Estimate (JSON)
            const costQuery = `Based on this rehab description: "${description}" for a ${sqft} sq ft house, what is the total estimated rehab cost?`;
            const costPrompt = "You are a general contractor. Based on the user's query, provide a low, average, and high total cost estimate. Return ONLY a JSON object in the specified format.";
            const schema = {
                type: "OBJECT",
                properties: {
                    "lowEstimate": { "type": "NUMBER" },
                    "averageEstimate": { "type": "NUMBER" },
                    "highEstimate": { "type": "NUMBER" }
                },
                required: ["lowEstimate", "averageEstimate", "highEstimate"]
            };
            
            const costResult = await callGeminiAPI(costQuery, costPrompt, schema);
            
            toggleSpinner('ai-rehab-btn', 'Generate AI Estimate', false);

            if (costResult.error) {
                costOutputDiv.innerHTML = `<p class="text-red-400">Could not estimate total cost. ${costResult.error.message}</p>`;
            } else {
                try {
                    const data = JSON.parse(costResult.text);
                    costOutputDiv.innerHTML = `
                        <p class="text-lg font-bold">AI Cost Estimate:</p>
                        <p>Low: ${currencyFormatter(data.lowEstimate)}</p>
                        <p><strong>Average: ${currencyFormatter(data.averageEstimate)}</strong></p>
                        <p>High: ${currencyFormatter(data.highEstimate)}</p>
                        <button id="use-avg-rehab-btn" class="btn btn-secondary btn-sm mt-2">Use Average Cost</button>
                    `;
                    getById('use-avg-rehab-btn').addEventListener('click', () => {
                        getById('rehab-costs').value = new Intl.NumberFormat('en-US').format(data.averageEstimate);
                        closeModal('rehab-modal');
                        showToast("Rehab cost updated!", "success");
                    });
                } catch (e) {
                    console.error("AI Rehab Cost Parse Error:", e, costResult.text);
                    costOutputDiv.innerHTML = `<p class="text-red-400">AI response for cost was in an invalid format.</p>`;
                }
            }
        }

        // --- MAO Calculator Logic ---
        function calculateMaoRule() {
            const arv = parseCurrency(getById('mao-rule-arv').value);
            const rehab = parseCurrency(getById('mao-rule-rehab').value);
            const percent = parseFloat(getById('mao-rule-slider').value) / 100;
            
            const mao = (arv * percent) - rehab;
            getById('mao-rule-result').textContent = currencyFormatter(mao);
        }

        function calculateMaoProfit() {
            const arv = parseCurrency(getById('mao-profit-arv').value);
            const rehab = parseCurrency(getById('mao-profit-rehab').value);
            const holdingSelling = parseCurrency(getById('mao-profit-holding').value);
            const profit = parseCurrency(getById('mao-profit-desired').value);

            const mao = arv - rehab - holdingSelling - profit;
            getById('mao-profit-result').textContent = currencyFormatter(mao);
        }
        
        // --- AI Market Analyzer Logic ---
        function calculateVelocity() {
            const sold = parseInt(getById('velocity-sold').value);
            const inventory = parseInt(getById('velocity-inventory').value);
            
            if (isNaN(sold) || isNaN(inventory) || inventory === 0) {
                getById('velocity-rate-result').textContent = "---";
                getById('velocity-market-result').textContent = "---";
                getById('velocity-results-container').style.display = 'none';
                return;
            }
            
            const rate = sold / inventory;
            let marketType = "---";
            let className = "profit"; // Default color

            if (rate < 0.14) {
                marketType = "Strong Buyer's Market";
                className = "loss";
            } else if (rate < 0.16) {
                marketType = "Buyer's Market";
                className = "loss";
            } else if (rate < 0.19) {
                marketType = "Balanced Market";
                className = "profit";
            } else if (rate < 0.22) {
                marketType = "Seller's Market";
                className = "profit";
            } else {
                marketType = "Hot Seller's Market";
                className = "profit";
            }
            
            getById('velocity-rate-result').textContent = percentFormatter(rate);
            getById('velocity-market-result').textContent = marketType;
            getById('velocity-market-result').className = `result-line-value text-2xl ${className}`;
            getById('velocity-results-container').style.display = 'block';
        }

        // --- What If? Logic ---
        function calculateWhatIf() {
            if (!currentDealData) return;

            const { arv, rehabCosts, grossProfit } = currentDealData;

            // Fill base values
            getById('what-if-profit-base').textContent = currencyFormatter(grossProfit);

            // Scenarios
            const scenarios = [
                { arvMod: 1.05, rehabMod: 0.90, id: 'what-if-arv-high-rehab-low' },
                { arvMod: 1.05, rehabMod: 1.00, id: 'what-if-arv-high-rehab-mid' },
                { arvMod: 1.05, rehabMod: 1.10, id: 'what-if-arv-high-rehab-high' },
                { arvMod: 1.05, rehabMod: 1.20, id: 'what-if-arv-high-rehab-over' },
                
                { arvMod: 1.00, rehabMod: 0.90, id: 'what-if-arv-mid-rehab-low' },
                { arvMod: 1.00, rehabMod: 1.10, id: 'what-if-arv-mid-rehab-high' },
                { arvMod: 1.00, rehabMod: 1.20, id: 'what-if-arv-mid-rehab-over' },

                { arvMod: 0.95, rehabMod: 0.90, id: 'what-if-arv-low-rehab-low' },
                { arvMod: 0.95, rehabMod: 1.00, id: 'what-if-arv-low-rehab-mid' },
                { arvMod: 0.95, rehabMod: 1.10, id: 'what-if-arv-low-rehab-high' },
                { arvMod: 0.95, rehabMod: 1.20, id: 'what-if-arv-low-rehab-over' },
            ];
            
            scenarios.forEach(scenario => {
                const newInputs = { ...currentDealData };
                newInputs.arv = arv * scenario.arvMod;
                newInputs.rehabCosts = rehabCosts * scenario.rehabMod;
                
                const result = calculateDeal(newInputs);
                const cell = getById(scenario.id);
                cell.textContent = currencyFormatter(result.grossProfit);
                cell.className = result.grossProfit >= 0 ? 'profit' : 'loss';
            });
        }

        // --- Batch Analyzer Logic ---
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        reject(new Error("CSV file must have at least one header row and one data row."));
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const data = lines.slice(1).map(line => {
                        // This regex handles commas inside quotes
                        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                        });
                        return obj;
                    });
                    resolve({ headers, data });
                };
                reader.onerror = (e) => reject(new Error("Error reading file."));
                reader.readAsText(file);
            });
        }

        function openMapModal() {
            if (!csvHeaders.length) {
                showToast("Please upload a CSV file first.", "error");
                return;
            }
            const selects = document.querySelectorAll('.map-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">-- Select Column --</option>'; // Clear old options
                csvHeaders.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
                // Try to auto-select based on common names
                const id = select.id;
                const commonNames = {
                    'map-full-address': ['Full Address', 'Parcel Full Address', 'Address', 'Property Address'],
                    'map-street-address': ['Street Address', 'Parcel Address', 'Address1'],
                    'map-city': ['City', 'Parcel City'],
                    'map-state': ['State', 'Parcel State'],
                    'map-zip-code': ['ZIP', 'Zip Code', 'Parcel ZIP'],
                    'map-sqft': ['Sq Ft', 'Structure Sq Ft', 'Living Area'],
                    'map-purchase-price': ['Market Value Estimate', 'Market Total Parcel Value', 'Est Value', 'Price']
                };
                const matchingHeader = csvHeaders.find(h => commonNames[id]?.some(name => h.toLowerCase() === name.toLowerCase()));
                if (matchingHeader) {
                    select.value = matchingHeader;
                }
            });
            openModal('batch-map-modal');
        }

        async function runBatchAnalysis() {
            const defaultRehab = parseCurrency(getById('batch-rehab-cost').value);
            if (defaultRehab === 0) {
                showToast("Please enter a default rehab cost.", "error");
                return;
            }
            if (Object.keys(csvColumnMapping).length === 0) {
                showToast("Please map your CSV columns first.", "error");
                return;
            }

            toggleSpinner('run-batch-btn', 'Analyze First 10 Properties', true);
            getById('batch-results-container').style.display = 'block';
            const statusText = getById('batch-status-text');
            const tableHead = getById('batch-results-table-head');
            const tableBody = getById('batch-results-table-body');

            // Prepare table
            tableHead.innerHTML = `
                <tr>
                    <th class="p-3">Address</th>
                    <th class="p-3">Est. Purchase Price</th>
                    <th class="p-3">Est. ARV (AI)</th>
                    <th class="p-3">Est. Rehab</th>
                    <th class="p-3">Est. Profit (AI)</th>
                    <th class="p-3">Est. ROI (AI)</th>
                    <th class="p-3">MAO (70% Rule)</th>
                    <th class="p-3">Status</th>
                </tr>
            `;
            tableBody.innerHTML = '';
            
            const propertiesToAnalyze = csvData.slice(0, 10);
            let resultsData = [];

            for (let i = 0; i < propertiesToAnalyze.length; i++) {
                const row = propertiesToAnalyze[i];
                statusText.textContent = `Analyzing property ${i + 1} of ${propertiesToAnalyze.length}...`;
                
                // 1. Construct Address
                let fullAddress = "";
                if (csvColumnMapping.fullAddress) {
                    fullAddress = row[csvColumnMapping.fullAddress];
                } else if (csvColumnMapping.streetAddress && csvColumnMapping.city && csvColumnMapping.state) {
                    fullAddress = `${row[csvColumnMapping.streetAddress]}, ${row[csvColumnMapping.city]}, ${row[csvColumnMapping.state]}`;
                }
                
                const zip = row[csvColumnMapping.zipCode] || '';
                if (!fullAddress && zip) {
                    fullAddress = zip; // Fallback to zip
                }

                if (!fullAddress) {
                    statusText.textContent = `Skipping row ${i + 1}: Missing address information.`;
                    continue;
                }

                const purchasePrice = parseCurrency(row[csvColumnMapping.purchasePrice]);
                const sqft = parseCurrency(row[csvColumnMapping.sqft]);

                if (sqft === 0) {
                    statusText.textContent = `Skipping ${fullAddress}: Missing Sq. Ft.`;
                    continue;
                }

                // 2. Run AI Comp Finder to get ARV
                const compQuery = `Find recent sold homes near ${fullAddress}.`;
                const compPrompt = `You are a real estate comping expert. Find recently sold comparable properties for ${fullAddress}. Return a JSON array of comps, up to 10. For each comp, include "address", "salePrice", and "sqft".
                
                Example:
                {
                  "comps": [
                    { "address": "125 Main St, Denver, CO", "salePrice": 400000, "sqft": 1500 },
                    { "address": "127 Main St, Denver, CO", "salePrice": 410000, "sqft": 1550 }
                  ]
                }
                
                Please return ONLY the JSON object and no other text.`;

                const compResult = await callGeminiAPI(compQuery, compPrompt, null, true, 2);
                let estArv = 0;
                let analysisStatus = "Error";
                let estProfit = 0, estRoi = 0, estMao = 0;

                if (!compResult.error) {
                    try {
                        const compsData = JSON.parse(compResult.text);
                        if (compsData.comps && compsData.comps.length > 0) {
                            let totalSqft = 0;
                            let totalPrice = 0;
                            compsData.comps.forEach(c => {
                                totalSqft += parseFloat(c.sqft) || 0;
                                totalPrice += parseFloat(c.salePrice) || 0;
                            });
                            const avgPpsqf = totalSqft > 0 ? totalPrice / totalSqft : 0;
                            estArv = avgPpsqf * sqft;
                            analysisStatus = "Success";
                        } else {
                            analysisStatus = "No Comps Found";
                        }
                    } catch (e) {
                        console.error("AI Comp Parse Error (Batch):", e, compResult.text);
                        analysisStatus = "AI Error";
                    }
                } else {
                    analysisStatus = "API Error";
                }

                // 3. Run Deal Calculation
                if (analysisStatus === "Success") {
                    const inputs = getDealInputs(); // Get defaults
                    inputs.purchasePrice = purchasePrice;
                    inputs.arv = estArv;
                    inputs.rehabCosts = defaultRehab;
                    
                    const deal = calculateDeal(inputs);
                    estProfit = deal.grossProfit;
                    estRoi = deal.roi;
                    estMao = (estArv * 0.70) - defaultRehab;
                }
                
                // 4. Add to results and table
                const resultRow = {
                    ...row, // Original data
                    "Est. ARV (AI)": currencyFormatter(estArv),
                    "Est. Rehab": currencyFormatter(defaultRehab),
                    "Est. Profit (AI)": currencyFormatter(estProfit),
                    "Est. ROI (AI)": percentFormatter(estRoi),
                    "MAO (70% Rule)": currencyFormatter(estMao),
                    "Analysis Status": analysisStatus
                };
                resultsData.push(resultRow);

                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-800">
                        <td class="p-3">${fullAddress}</td>
                        <td class="p-3">${currencyFormatter(purchasePrice)}</td>
                        <td class="p-3">${currencyFormatter(estArv)}</td>
                        <td class="p-3">${currencyFormatter(defaultRehab)}</td>
                        <td class="p-3 ${estProfit > 0 ? 'profit' : 'loss'}">${currencyFormatter(estProfit)}</td>
                        <td class="p-3 ${estRoi > 0 ? 'profit' : 'loss'}">${percentFormatter(estRoi)}</td>
                        <td class="p-3">${currencyFormatter(estMao)}</td>
                        <td class="p-3">${analysisStatus}</td>
                    </tr>
                `;
            }
            
            statusText.textContent = `Analysis complete for ${propertiesToAnalyze.length} properties.`;
            toggleSpinner('run-batch-btn', 'Analyze First 10 Properties', false);
            csvData = resultsData; // Overwrite for download
        }

        function downloadBatchCSV() {
            if (csvData.length === 0) {
                showToast("No data to download.", "error");
                return;
            }

            const headers = Object.keys(csvData[0]);
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\n";

            csvData.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header] ? row[header].toString() : '';
                    // Handle values with commas
                    if (cell.includes(',')) {
                        cell = `"${cell}"`;
                    }
                    return cell;
                });
                csvContent += values.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "flip_analysis_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Saved Deals Logic ---
        function saveDeal() {
            const dealName = getById('save-deal-name').value.trim();
            if (!dealName) {
                showToast("Please enter a deal name.", "error");
                return;
            }
            if (!currentDealData) {
                showToast("Please calculate a deal first.", "error");
                return;
            }
            
            const dealToSave = {
                id: `deal-${new Date().getTime()}`,
                name: dealName,
                ...currentDealData
            };
            
            savedDeals.push(dealToSave);
            localStorage.setItem('savedDeals', JSON.stringify(savedDeals));
            renderSavedDeals();
            closeModal('save-deal-modal');
            showToast("Deal saved successfully!", "success");
        }

        function loadDeal(id) {
            const deal = savedDeals.find(d => d.id === id);
            if (!deal) return;

            // Load inputs
            getById('purchase-price').value = new Intl.NumberFormat('en-US').format(deal.purchasePrice);
            getById('arv').value = new Intl.NumberFormat('en-US').format(deal.arv);
            getById('rehab-costs').value = new Intl.NumberFormat('en-US').format(deal.rehabCosts);
            getById('financing-type').value = deal.financingType;
            getById('down-payment-percent').value = deal.downPaymentPercent * 100;
            getById('interest-rate').value = deal.interestRate * 100;
            getById('loan-points').value = deal.loanPoints * 100;
            getById('other-closing-costs').value = new Intl.NumberFormat('en-US').format(deal.otherClosingCosts);
            getById('holding-months').value = deal.holdingMonths;
            getById('monthly-holding-costs').value = new Intl.NumberFormat('en-US').format(deal.monthlyHoldingCosts);
            getById('selling-costs-percent').value = deal.sellingCostsPercent * 100;
            getById('selling-costs-flat').value = new Intl.NumberFormat('en-US').format(deal.sellingCostsFlat);

            // Re-calculate and display
            calculateDeal(deal);
            
            // Switch to main tab
            showTab('deal-calculator');
            showToast(`Deal "${deal.name}" loaded.`, "info");
        }

        function deleteDeal(id) {
            if (!confirm("Are you sure you want to delete this deal?")) return;
            savedDeals = savedDeals.filter(d => d.id !== id);
            localStorage.setItem('savedDeals', JSON.stringify(savedDeals));
            renderSavedDeals();
            showToast("Deal deleted.", "info");
        }

        function renderSavedDeals() {
            const container = getById('saved-deals-container');
            const noDealsMsg = getById('no-saved-deals');
            
            container.innerHTML = ''; // Clear
            
            if (savedDeals.length === 0) {
                container.appendChild(noDealsMsg);
                return;
            }

            savedDeals.forEach(deal => {
                const card = document.createElement('div');
                card.className = 'deal-card';
                card.innerHTML = `
                    <div class="deal-card-header">
                        <h4 class="deal-card-title">${deal.name}</h4>
                        <div class="deal-card-profit ${deal.grossProfit >= 0 ? 'profit' : 'loss'}">
                            ${currencyFormatter(deal.grossProfit)}
                        </div>
                    </div>
                    <div class="deal-card-body">
                        <div>
                            <span class="deal-card-label">ROI</span>
                            <span class="deal-card-value ${deal.roi >= 0 ? 'profit' : 'loss'}">${percentFormatter(deal.roi)}</span>
                        </div>
                        <div>
                            <span class="deal-card-label">ARV</span>
                            <span class="deal-card-value">${currencyFormatter(deal.arv)}</span>
                        </div>
                        <div>
                            <span class="deal-card-label">Purchase</span>
                            <span class="deal-card-value">${currencyFormatter(deal.purchasePrice)}</span>
                        </div>
                    </div>
                    <div class="deal-card-footer">
                        <button class="btn btn-secondary btn-sm" onclick="loadDeal('${deal.id}')">Load</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDeal('${deal.id}')">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- Tab & ARV Sync Logic ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-link').forEach(link => {
                link.classList.remove('active');
            });
            
            getById(tabId).classList.add('active');
            document.querySelector(`.tab-link[onclick="showTab('${tabId}')"]`).classList.add('active');
        }
        
        function syncArvFields(value, sourceId) {
            const arv = parseCurrency(value);
            const formattedArv = new Intl.NumberFormat('en-US').format(arv);

            if (sourceId !== 'arv') getById('arv').value = formattedArv;
            if (sourceId !== 'mao-rule-arv') getById('mao-rule-arv').value = formattedArv;
            if (sourceId !== 'mao-profit-arv') getById('mao-profit-arv').value = formattedArv;
            
            // Recalculate MAO fields if they were changed
            if (sourceId.startsWith('mao-')) {
                calculateMaoRule();
                calculateMaoProfit();
            }
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing calculator...");

            // --- Main Tab Navigation ---
            document.querySelectorAll('.tab-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.currentTarget.getAttribute('onclick').match(/'(.*?)'/)[1];
                    showTab(tabId);
                });
            });

            // --- API Key ---
            getById('save-api-key-btn').addEventListener('click', () => {
                const key = getById('api-key-input').value.trim();
                localStorage.setItem('geminiApiKey', key);
                getById('api-key-input').value = '******************';
                showToast("API Key saved successfully!", "success");
            });
            // Load saved key on start
            if (localStorage.getItem('geminiApiKey')) {
                getById('api-key-input').value = '******************';
            }

            // --- How-to-Use Modal ---
            getById('how-to-use-btn').addEventListener('click', () => openModal('how-to-use-modal'));
            getById('how-to-use-modal-close').addEventListener('click', () => closeModal('how-to-use-modal'));
            getById('how-to-use-close-btn').addEventListener('click', () => closeModal('how-to-use-modal'));
            
            // --- Deal Calculator Tab ---
            getById('financing-type').addEventListener('change', (e) => {
                getById('loan-inputs-container').style.display = e.target.value === 'loan' ? 'block' : 'none';
            });
            
            getById('calculate-deal-btn').addEventListener('click', () => {
                const inputs = getDealInputs();
                displayDealResults(calculateDeal(inputs));
            });
            
            getById('get-deal-summary-btn').addEventListener('click', async () => {
                if (!currentDealData) {
                    showToast("Please calculate a deal first.", "error");
                    return;
                }
                const container = getById('ai-summary-container');
                const content = getById('ai-summary-content');
                const spinner = getById('ai-summary-spinner');
                
                container.style.display = 'block';
                content.style.display = 'none';
                spinner.style.display = 'flex';

                const prompt = `Analyze this real estate flip deal:\n${JSON.stringify(currentDealData, null, 2)}`;
                const systemPrompt = "You are a seasoned real estate investor. Provide a concise, bulleted summary of the strengths and weaknesses of this deal. Focus on profit, ROI, and cash needed.";
                
                const result = await callGeminiAPI(prompt, systemPrompt);
                
                spinner.style.display = 'none';
                content.style.display = 'block';
                if (result.error) {
                    content.textContent = result.error.message;
                } else {
                    content.textContent = result.text;
                }
            });

            getById('print-report-btn').addEventListener('click', () => {
                if (!currentDealData) {
                    showToast("Please calculate a deal first.", "error");
                    return;
                }
                const reportWindow = window.open('', '', 'height=800,width=800');
                reportWindow.document.write('<html><head><title>Flip Analysis Report</title>');
                reportWindow.document.write('<style> body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; background: #f4f4f4; color: #333;} .container { max-width: 750px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); } h1 { color: #007BFF; border-bottom: 2px solid #007BFF; padding-bottom: 10px; } h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 30px; } .line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dotted #ccc; } .line-label { font-weight: bold; color: #555; } .line-value { font-weight: bold; } .profit { color: #28a745; } .loss { color: #dc3545; } </style>');
                reportWindow.document.write('</head><body><div class="container">');
                reportWindow.document.write(`<h1>Flip Analysis Report: ${getById('save-deal-name').value || 'My Deal'}</h1>`);
                
                const results = currentDealData;
                const profitClass = results.grossProfit >= 0 ? 'profit' : 'loss';
                const roiClass = results.roi >= 0 ? 'profit' : 'loss';
                
                reportWindow.document.write('<h2>Key Metrics</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Estimated Gross Profit</span><span class="line-value ${profitClass}">${currencyFormatter(results.grossProfit)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Return on Investment (ROI)</span><span class="line-value ${roiClass}">${percentFormatter(results.roi)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Annualized ROI</span><span class="line-value ${roiClass}">${percentFormatter(results.annualizedRoi)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Cash Needed</span><span class="line-value">${currencyFormatter(results.totalCashNeeded)}</span></div>`);
                
                reportWindow.document.write('<h2>Deal Assumptions</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Purchase Price</span><span class="line-value">${currencyFormatter(results.purchasePrice)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">After Repair Value (ARV)</span><span class="line-value">${currencyFormatter(results.arv)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Rehab Costs</span><span class="line-value">${currencyFormatter(results.rehabCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Project Length</span><span class="line-value">${results.holdingMonths} Months</span></div>`);
                
                reportWindow.document.write('<h2>Cost Breakdown</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Holding Costs</span><span class="line-value">${currencyFormatter(results.totalHoldingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Financing Costs</span><span class="line-value">${currencyFormatter(results.totalFinancingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Selling Costs</span><span class="line-value">${currencyFormatter(results.totalSellingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line" style="border-top: 2px solid #333; font-weight: bold;"><span class="line-label">Total All Costs</span><span class="line-value">${currencyFormatter(results.totalCosts)}</span></div>`);

                reportWindow.document.write('</div></body></html>');
                reportWindow.document.close();
                reportWindow.print();
            });

            // --- ARV Comps Modal ---
            getById('arv-comps-btn').addEventListener('click', () => {
                // Clear old comps
                getById('comps-list-container').innerHTML = '';
                arvComps = [];
                // Add 3 default rows
                addCompRow();
                addCompRow();
                addCompRow();
                // Reset results
                calculateArv();
                openModal('arv-modal');
            });
            getById('arv-modal-close').addEventListener('click', () => closeModal('arv-modal'));
            getById('add-comp-row-btn').addEventListener('click', () => addCompRow());
            getById('use-arv-btn').addEventListener('click', () => {
                const estArv = parseCurrency(getById('estimated-arv-result').textContent);
                if (estArv > 0) {
                    syncArvFields(estArv, 'arv-modal');
                    showToast("ARV updated successfully!", "success");
                    closeModal('arv-modal');
                } else {
                    showToast("Cannot use an ARV of $0.", "error");
                }
            });
            
            getById('ai-comp-status').addEventListener('change', (e) => {
                getById('ai-sold-since-container').style.display = e.target.value === 'Sold' ? 'block' : 'none';
            });

            getById('ai-comp-finder-btn').addEventListener('click', async () => {
                const address = getById('subject-address').value.trim();
                const radius = getById('ai-comp-radius').value || '3';
                const status = getById('ai-comp-status').value;
                const soldSince = getById('ai-sold-since').value;
                const statusText = getById('ai-comp-finder-status');

                if (!address) {
                    showToast("Please enter a subject property address.", "error");
                    return;
                }

                toggleSpinner('ai-comp-finder-btn', '✨ Find Comps with AI', true);
                statusText.textContent = "Finding comps...";
                statusText.style.display = 'block';

                const query = `${status} home comps near ${address} within a ${radius} mile radius. ${status === 'Sold' ? `Sold in the last ${soldSince}.` : ''}`;
                const prompt = `You are a real estate comping expert. Find ${status} comparable properties for ${address} within a ${radius} mile radius. ${status === 'Sold' ? `Must be sold in the last ${soldSince}.` : ''}
                Return a JSON object with a single key "comps", which is an array. For each comp, include "address", "beds", "baths", "sqft", and "salePrice".
                
                Example:
                {
                  "comps": [
                    { "address": "125 Main St, Denver, CO", "beds": 3, "baths": 2, "sqft": 1500, "salePrice": 400000 },
                    { "address": "127 Main St, Denver, CO", "beds": 3, "baths": 2.5, "sqft": 1550, "salePrice": 410000 }
                  ]
                }
                
                Please return ONLY the JSON object and no other text.`;

                const result = await callGeminiAPI(query, prompt, null, true, 2);
                
                toggleSpinner('ai-comp-finder-btn', '✨ Find Comps with AI', false);
                getById('comps-list-container').innerHTML = ''; // Clear existing rows
                arvComps = [];

                if (result.error) {
                    statusText.textContent = result.error.message;
                } else {
                    try {
                        const compsData = JSON.parse(result.text);
                        if (compsData.comps && compsData.comps.length > 0) {
                            if (compsData.comps.length < 3) {
                                statusText.textContent = `Only ${compsData.comps.length} comps found. Try expanding your criteria.`;
                            } else {
                                statusText.textContent = `Success! Found ${compsData.comps.length} comps.`;
                            }
                            compsData.comps.forEach(comp => addCompRow(comp));
                        } else {
                            statusText.textContent = "No comps found matching your criteria. Please try a larger radius or different timeframe.";
                            addCompRow(); addCompRow(); addCompRow(); // Add empty rows
                        }
                    } catch (e) {
                        console.error("AI Comp Parse Error:", e, result.text);
                        statusText.textContent = "AI response was in an invalid format. Please try again.";
                        addCompRow(); addCompRow(); addCompRow(); // Add empty rows
                    }
                }
                calculateArv(); // Recalculate with new comps
            });

            // --- AI Rehab Modal ---
            getById('rehab-breakdown-btn').addEventListener('click', () => {
                getById('ai-rehab-content').textContent = '';
                getById('ai-rehab-output').style.display = 'none';
                // Sync Sq. Ft. from main calculator
                getById('subject-sqft-rehab').value = getById('subject-sqft').value || '';
                // Add 3 default item rows
                getById('manual-rehab-list').innerHTML = '';
                rehabItems = [];
                addRehabItem();
                addRehabItem();
                addRehabItem();
                openModal('rehab-modal');
            });
            getById('rehab-modal-close').addEventListener('click', () => {
                updateManualRehabTotal(); // Make sure total is saved
                closeModal('rehab-modal');
            });
            getById('ai-rehab-btn').addEventListener('click', runAiRehabEstimate);
            getById('add-rehab-item-btn').addEventListener('click', () => addRehabItem());


            // --- MAO Calculator Tab ---
            getById('mao-rule-arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'mao-rule-arv');
                calculateMaoRule();
            });
            getById('mao-profit-arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'mao-profit-arv');
                calculateMaoProfit();
            });
            getById('arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'arv');
            });
            
            getById('mao-rule-slider').addEventListener('input', (e) => {
                getById('mao-rule-percent').textContent = `${e.target.value}%`;
                calculateMaoRule();
            });
            [getById('mao-rule-rehab'), getById('mao-rule-slider')].forEach(el => {
                el.addEventListener('input', calculateMaoRule);
            });
            [getById('mao-profit-rehab'), getById('mao-profit-holding'), getById('mao-profit-desired')].forEach(el => {
                el.addEventListener('input', calculateMaoProfit);
            });

            // --- AI Market Analyzer Tab ---
            getById('ai-market-btn').addEventListener('click', async () => {
                const address = getById('ai-market-address').value.trim();
                if (!address) {
                    showToast("Please enter a zip code or address.", "error");
                    return;
                }
                
                toggleSpinner('ai-market-btn', '✨ Analyze Market', true);
                const outputDiv = getById('ai-market-output');
                const contentP = getById('ai-market-content');
                outputDiv.style.display = 'block';

                const query = `Provide a real estate market analysis for ${address}`;
                const systemPrompt = "You are a real estate market analyst. Provide a summary of the market trends, school ratings, and local amenities for this area. Use bullet points.";

                const result = await callGeminiAPI(query, systemPrompt, null, true);
                
                toggleSpinner('ai-market-btn', '✨ Analyze Market', false);
                if (result.error) {
                    contentP.textContent = result.error.message;
                } else {
                    contentP.textContent = result.text;
                }
            });
            
            getById('velocity-calculate-btn').addEventListener('click', calculateVelocity);

            getById('ai-velocity-btn').addEventListener('click', async () => {
                const zip = getById('ai-velocity-zip').value.trim();
                const type = getById('ai-velocity-type').value.trim() || 'homes';
                if (!zip) {
                    showToast("Please enter a zip code.", "error");
                    return;
                }
                
                toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', true);
                const statusText = getById('ai-velocity-status');
                statusText.textContent = "Searching for market data...";
                statusText.style.display = 'block';

                // --- Two-Step AI Velocity Search ---
                // Step 1: Search for raw data
                const searchQuery = `real estate market data ${type} for sale vs sold in last 30 days in zip code ${zip}`;
                const searchPrompt = "You are a real estate data scraper. Find the total number of homes for sale right now AND the number of homes sold in the last 30 days for the following query. Provide this data as raw text.";
                
                const searchResult = await callGeminiAPI(searchQuery, searchPrompt, null, true, 2);

                if (searchResult.error) {
                    toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', false);
                    statusText.textContent = searchResult.error.message;
                    return;
                }

                statusText.textContent = "Data found. Extracting numbers...";

                // Step 2: Extract numbers from the raw data
                const extractQuery = `From the text below, extract "homesSold" (number sold in last 30 days) and "homesForSale" (total current inventory).
                
                TEXT: """${searchResult.text}"""
                `;
                const extractPrompt = "Extract the two numbers from the user's query and return ONLY a JSON object in the specified format.";
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "homesSold": { "type": "NUMBER" },
                        "homesForSale": { "type": "NUMBER" }
                    },
                    required: ["homesSold", "homesForSale"]
                };

                const extractResult = await callGeminiAPI(extractQuery, extractPrompt, schema, false, 2);

                toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', false);
                
                if (extractResult.error) {
                    statusText.textContent = extractResult.error.message;
                } else {
                    try {
                        const data = JSON.parse(extractResult.text);
                        getById('velocity-sold').value = data.homesSold;
                        getById('velocity-inventory').value = data.homesForSale;
                        calculateVelocity();
                        statusText.textContent = "Success! Data populated below.";
                    } catch (e) {
                        console.error("AI Velocity Parse Error:", e, extractResult.text);
                        statusText.textContent = "AI response was in an invalid format. Please try again.";
                    }
                }
            });

            // --- What If? Logic ---
            function calculateWhatIf() {
                if (!currentDealData) {
                    // Clear the table if no data
                    const cells = document.querySelectorAll('.what-if-table tbody td');
                    cells.forEach(cell => {
                        cell.textContent = '---';
                        cell.className = '';
                        if(cell.id === 'what-if-profit-base') cell.className = 'base-cell';
                    });
                    return;
                }

                const { arv, rehabCosts, grossProfit } = currentDealData;

                // Fill base values
                getById('what-if-profit-base').textContent = currencyFormatter(grossProfit);
                getById('what-if-profit-base').className = `base-cell ${grossProfit >= 0 ? 'profit' : 'loss'}`;

                // Scenarios
                const scenarios = [
                    { arvMod: 1.05, rehabMod: 0.90, id: 'what-if-arv-high-rehab-low' },
                    { arvMod: 1.05, rehabMod: 1.00, id: 'what-if-arv-high-rehab-mid' },
                    { arvMod: 1.05, rehabMod: 1.10, id: 'what-if-arv-high-rehab-high' },
                    { arvMod: 1.05, rehabMod: 1.20, id: 'what-if-arv-high-rehab-over' },
                    
                    { arvMod: 1.00, rehabMod: 0.90, id: 'what-if-arv-mid-rehab-low' },
                    { arvMod: 1.00, rehabMod: 1.10, id: 'what-if-arv-mid-rehab-high' },
                    { arvMod: 1.00, rehabMod: 1.20, id: 'what-if-arv-mid-rehab-over' },

                    { arvMod: 0.95, rehabMod: 0.90, id: 'what-if-arv-low-rehab-low' },
                    { arvMod: 0.95, rehabMod: 1.00, id: 'what-if-arv-low-rehab-mid' },
                    { arvMod: 0.95, rehabMod: 1.10, id: 'what-if-arv-low-rehab-high' },
                    { arvMod: 0.95, rehabMod: 1.20, id: 'what-if-arv-low-rehab-over' },
                ];
                
                scenarios.forEach(scenario => {
                    const newInputs = { ...currentDealData };
                    newInputs.arv = arv * scenario.arvMod;
                    newInputs.rehabCosts = rehabCosts * scenario.rehabMod;
                    
                    const result = calculateDeal(newInputs);
                    const cell = getById(scenario.id);
                    cell.textContent = currencyFormatter(result.grossProfit);
                    cell.className = result.grossProfit >= 0 ? 'profit' : 'loss';
                });
            }


