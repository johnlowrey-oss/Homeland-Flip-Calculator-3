<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeland Property Flip Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #111827; /* Dark Gray-Black */
            --bg-light: #1F2937; /* Lighter Gray-Black */
            --bg-lighter: #374151; /* Even Lighter */
            --text-color: #E5E7EB; /* Light Gray */
            --primary-color: #06B6D4; /* Neon Cyan */
            --primary-hover: #0891B2; /* Darker Cyan */
            --primary-text: #000000; /* Black text for high contrast on neon */
            --danger-color: #EF4444;
            --danger-hover: #DC2626;
            --success-color: #10B981;
            --success-hover: #059669;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--bg-lighter);
            border-radius: 20px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            margin-right: 0.25rem;
            border-radius: 0.375rem 0.375rem 0 0;
            background-color: var(--bg-light);
            color: var(--text-color);
            border: 1px solid var(--bg-lighter);
            border-bottom: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            white-space: nowrap; /* Prevents button text from wrapping on mobile */
        }
        
        /* Horizontal scroll for tabs on mobile */
        .tabs-container {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background-color: var(--bg-lighter);
        }
        .tab-btn.active {
            background-color: var(--bg-color);
            color: var(--primary-color);
            border-top-width: 2px;
            border-top-color: var(--primary-color);
            border-left-color: var(--bg-lighter);
            border-right-color: var(--bg-lighter);
            position: relative;
            top: 1px;
            z-index: 10;
        }
        .tab-pane {
            display: none;
            background-color: var(--bg-color);
            border: 1px solid var(--bg-lighter);
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 1.5rem;
        }
        .tab-pane.active {
            display: block;
        }
        .input, .select {
            background-color: var(--bg-light);
            color: var(--text-color);
            border: 1px solid var(--bg-lighter);
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem; /* Prevents iOS zoom */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input:focus, .select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.3);
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }
        .input-row {
            display: flex;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background-color: var(--bg-lighter);
            color: #9CA3AF;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--primary-text);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text-color);
            border: 1px solid var(--bg-lighter);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--bg-lighter);
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-hover);
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background-color: var(--success-hover);
        }
        
        /* Custom File Upload Button */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-btn {
            background-color: var(--bg-light);
            color: var(--text-color);
            border: 1px solid var(--bg-lighter);
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .file-input-wrapper:hover .file-input-btn {
            background-color: var(--bg-lighter);
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        #file-name {
            margin-left: 1rem;
            font-style: italic;
            color: #9CA3AF;
        }

        .results-box {
            background-color: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .results-box h3 {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .result-line {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--bg-lighter);
            font-size: 1rem;
            flex-wrap: wrap; /* For mobile */
        }
        .result-line:last-child {
            border-bottom: none;
        }
        .result-line-label {
            font-weight: 500;
            color: var(--text-color);
            margin-right: 1rem; /* Space between label and value */
        }
        .result-line-value {
            font-weight: 600;
            text-align: right;
        }
        .profit {
            color: var(--success-color);
            font-size: 1.25rem;
        }
        .loss {
            color: var(--danger-color);
            font-size: 1.25rem;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            padding-top: 60px;
        }
        .modal-content {
            background-color: var(--bg-color);
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid var(--bg-lighter);
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px; /* Wider modal for comps */
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-lighter);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 600;
        }
        .modal-close {
            color: var(--text-color);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--primary-color);
        }
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-body p, .modal-body li {
            color: var(--text-color);
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .modal-body h4 {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .modal-body code {
            background-color: var(--bg-light);
            color: var(--primary-color);
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .modal-body ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .modal-footer {
            border-top: 1px solid var(--bg-lighter);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            text-align: right;
        }
        
        /* Spinner */
        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Grid for Comps */
        .comp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            align-items: center;
        }
        .comp-grid-header {
            font-weight: 600;
            color: var(--text-color);
            padding-bottom: 0.5rem;
            display: none; /* Hide headers on mobile */
        }
        @media (min-width: 768px) {
            .comp-grid-header {
                display: block; /* Show headers on desktop */
            }
        }
        /* Mobile stacked layout for comps */
        @media (max-width: 767px) {
            .comp-grid {
                grid-template-columns: 1fr; /* Stack all items */
            }
            .comp-grid .input-group {
                display: grid;
                grid-template-columns: 100px 1fr; /* Label + Input */
                align-items: center;
            }
            .comp-grid .label {
                margin-bottom: 0; /* Remove default margin */
            }
        }

        /* Saved Deal Cards */
        #saved-deals-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        .deal-card {
            background-color: var(--bg-light);
            border: 1px solid var(--bg-lighter);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .deal-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.1);
        }
        .deal-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            word-wrap: break-word;
        }
        .deal-card-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .deal-card-label {
            color: var(--text-color);
        }
        .deal-card-value {
            font-weight: 600;
        }
        .deal-card-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold" style="color: var(--primary-color);">Homeland Property Flip Calculator</h1>
            <p class="text-lg text-gray-400">Your all-in-one deal analysis toolkit.</p>
        </header>

        <!-- API Key Input -->
        <div class="max-w-xl mx-auto mb-6 p-4 rounded-lg bg-gray-800 border border-gray-700">
            <label for="api-key-input" class="label text-center text-cyan-400">Google AI API Key</label>
            <p class="text-xs text-center text-gray-400 mb-2">Required for all "AI" features. Get a free key from Google AI Studio.</p>
            <div class="flex gap-2">
                <input type="password" id="api-key-input" class="input" placeholder="Enter your API Key...">
                <button id="save-key-btn" class="btn btn-primary">Save</button>
            </div>
            <p id="api-key-status" class="text-xs text-center text-green-500 mt-2" style="display: none;">API Key saved in browser.</p>
        </div>

        <!-- How to Use Button -->
        <div class="text-center mb-4">
            <button id="how-to-use-btn" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <span>How to Use This Calculator</span>
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs-container mb-0" style="margin-bottom: -1px;">
            <nav class="flex">
                <button class="tab-btn active" onclick="openTab(event, 'deal-calculator')">Deal Calculator</button>
                <button class="tab-btn" onclick="openTab(event, 'mao-calculator')">MAO Calculator</button>
                <button class="tab-btn" onclick="openTab(event, 'market-analyzer')">AI Market Analyzer</button>
                <button class="tab-btn" onclick="openTab(event, 'what-if')">What If?</button>
                <button class="tab-btn" onclick="openTab(event, 'batch-analyzer')">Batch Analyzer</button>
                <button class="tab-btn" onclick="openTab(event, 'saved-deals')">Saved Deals</button>
            </nav>
        </div>
        
	<!-- Tab Content -->
        <div id="tab-content">
            <!-- ===== Deal Calculator Tab ===== -->
            <div id="deal-calculator" class="tab-pane active">
                
                <!-- Purchase & Financing -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Purchase & Financing</h3>
                        <div class="input-group">
                            <label for="purchase-price" class="label">Purchase Price</label>
                            <input type="text" id="purchase-price" class="input" placeholder="e.g., 250,000" oninput="formatCurrency(this)">
                        </div>
                        
                        <div class="input-group">
                            <label for="financing-type" class="label">Financing Type</label>
                            <select id="financing-type" class="select">
                                <option value="cash">All Cash</option>
                                <option value="loan" selected>Financed (Loan)</option>
                            </select>
                        </div>
                        
                        <div id="loan-inputs-container">
                            <div class="input-group">
                                <label for="down-payment-percent" class="label">Down Payment (%)</label>
                                <input type="number" id="down-payment-percent" class="input" value="25">
                            </div>
                            <div class="input-group">
                                <label for="interest-rate" class="label">Interest Rate (%)</label>
                                <input type="number" id="interest-rate" class="input" value="7.5">
                            </div>
                            <div class="input-group">
                                <label for="loan-points" class="label">Loan Points (%)</label>
                                <input type="number" id="loan-points" class="input" value="1">
                            </div>
                            <div class="input-group">
                                <label for="other-closing-costs" class="label">Other Closing Costs (Flat $)</label>
                                <input type="text" id="other-closing-costs" class="input" placeholder="e.g., 3,000" value="3,000" oninput="formatCurrency(this)">
                            </div>
                        </div>
                    </div>

                    <!-- ARV & Rehab Costs -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">ARV & Rehab</h3>
                        <div class="input-group">
                            <label for="arv" class="label">After Repair Value (ARV)</label>
                            <div class="flex gap-2">
                                <input type="text" id="arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                                <button id="arv-comps-btn" class="btn btn-secondary" title="ARV Comps Calculator">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calculator" viewBox="0 0 16 16">
                                        <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
                                        <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.a.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.T.5.5 0 0 1-.5-.5v-1z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="rehab-costs" class="label">Total Rehab Costs</label>
                            <div class="flex gap-2">
                                <input type="text" id="rehab-costs" class="input" placeholder="e.g., 40,000" oninput="formatCurrency(this)">
                                <button id="rehab-breakdown-btn" class="btn btn-secondary" title="AI Rehab Breakdown">AI</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Holding & Selling Costs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Holding Costs</h3>
                        <div class="input-group">
                            <label for="holding-months" class="label">Project Length (Months)</label>
                            <input type="number" id="holding-months" class="input" placeholder="e.g., 6" value="6">
                        </div>
                        <div class="input-group">
                            <label for="monthly-holding-costs" class="label">Monthly Holding Costs (Taxes, Ins, Utils)</label>
                            <input type="text" id="monthly-holding-costs" class="input" placeholder="e.g., 500" value="500" oninput="formatCurrency(this)">
                        </div>
                    </div>

                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Selling Costs</h3>
                        <div class="input-group">
                            <label for="selling-costs-percent" class="label">Selling Costs (% of ARV)</label>
                            <input type="number" id="selling-costs-percent" class="input" placeholder="e.g., 6" value="6">
                        </div>
                        <div class="input-group">
                            <label for="selling-costs-flat" class="label">Selling Costs (Flat $)</label>
                            <input type="text" id="selling-costs-flat" class="input" placeholder="e.g., 1,500" value="0" oninput="formatCurrency(this)">
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="mt-8 text-center">
                    <button id="calculate-deal-btn" class_Original="btn btn-primary w-full md:w-1/2" class="btn btn-primary w-full md:w-1/2">Calculate Deal</button>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="results-box mt-8" style="display: none;">
                    <h3 class="text-center">Deal Analysis Results</h3>
                    
                    <div class="result-line bg-gray-900 p-2 rounded">
                        <span class="result-line-label text-cyan-400">Estimated Gross Profit</span>
                        <span class="result-line-value text-2xl" id="gross-profit-result">---</span>
                    </div>
                    <div class="result-line font-bold text-lg">
                        <span class="result-line-label">Return on Investment (ROI)</span>
                        <span class="result-line-value" id="roi-result">---</span>
                    </div>
                    <div class="result-line font-bold text-lg mb-4">
                        <span class="result-line-label">Annualized ROI</span>
                        <span class="result-line-value" id="annualized-roi-result">---</span>
                    </div>

                    <h4 class="text-lg font-semibold mb-2 text-cyan-400 mt-6">Investment Breakdown</h4>
                    <div class="result-line">
                        <span class="result-line-label">Total Cash Needed (for Financed Deal)</span>
                        <span class="result-line-value" id="total-cash-needed-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Total All-In Investment (if 100% Cash)</span>
                        <span class="result-line-value" id="total-investment-cash-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Profit per Month</span>
                        <span class="result-line-value" id="profit-per-month-result">---</span>
                    </div>

                    <h4 class="text-lg font-semibold mb-2 text-cyan-400 mt-6">Cost Breakdown</h4>
                    <div class="result-line">
                        <span class="result-line-label">Purchase Price</span>
                        <span class="result-line-value" id="purchase-price-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Rehab Costs</span>
                        <span class="result-line-value" id="rehab-costs-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Total Holding Costs (Utilities, Taxes)</span>
                        <span class="result-line-value" id="total-holding-costs-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Financing Costs (Points, Interest)</span>
                        <span class="result-line-value" id="total-financing-costs-result">---</span>
                    </div>
                    <div class="result-line">
                        <span class="result-line-label">Total Selling Costs</span>
                        <span class="result-line-value" id="total-selling-costs-result">---</span>
                    </div>
                    <div class="result-line border-t-2 border-cyan-400 font-bold">
                        <span class="result-line-label">Total Costs</span>
                        <span class="result-line-value" id="total-costs-result">---</span>
                    </div>
                    <div class="result-line font-bold">
                        <span class="result-line-label">ARV - Total Costs (Profit)</span>
                        <span class="result-line-value" id="profit-check-result">---</span>
                    </div>

                    <div class="mt-8 flex flex-col md:flex-row gap-4">
                        <button id="get-deal-summary-btn" class="btn btn-secondary flex-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16">
                                <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.217l.92.9a.25.25 0 0 0 .384.057l1.03-1.03a.25.25 0 0 0-.057-.384l-.92-.9a.25.25 0 0 0-.169-.068Zm1.223 1.833a.25.25 0 0 0-.057.384l1.03 1.03a.25.25 0 0 0 .384-.057l.92-.9a.25.25 0 0 0-.068-.217 24.768 24.768 0 0 1-1.871.183.25.25 0 0 0-.217-.068l-.92.9a.25.25 0 0 0-.169.068l-.92-.9a.25.25 0 0 0-.057-.384l1.03-1.03a.25.25 0 0 0 .384.057l.92.9a.25.25 0 0 0 .169-.068Z"/>
                                <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1Zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5ZM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5Z"/>
                            </svg>
                            Get AI Deal Summary
                        </button>
                        <button id="save-deal-btn" class="btn btn-success flex-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                            </svg>
                            Save Deal
                        </button>
                        <button id="print-report-btn" class="btn btn-secondary flex-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                            </svg>
                            Print Report
                        </button>
                    </div>
                    <div id="ai-summary-container" class="mt-4" style="display: none;">
                        <h4 class="text-lg font-semibold mb-2 text-cyan-400">AI Deal Summary</h4>
                        <div id="ai-summary-spinner" class="flex justify-center items-center h-24" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                        <p id="ai-summary-content" class="text-gray-300 whitespace-pre-wrap p-4 bg-gray-900 rounded"></p>
                    </div>
                </div>
            </div> <!-- End Deal Calculator Tab -->

            <!-- ===== ARV Comps Modal ===== -->
            <div id="arv-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">ARV Comps Calculator</h2>
                        <span class="modal-close" id="arv-modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <label for="subject-sqft" class="label">Subject Property Sq. Ft.</label>
                                <input type="text" id="subject-sqft" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="subject-address" class="label">Subject Property Address (for AI)</label>
                                <input type="text" id="subject-address" class="input" placeholder="e.g., 123 Main St, Denver, CO 80202">
                            </div>
                        </div>
                        
                        <!-- AI Comp Finder -->
                        <div class="p-4 bg-gray-800 rounded-lg border border-gray-700 my-4">
                            <h3 class="text-xl font-semibold mb-4 text-cyan-400">AI Comp Finder</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="ai-comp-status" class="label">Comp Status</label>
                                    <select id="ai-comp-status" class="select">
                                        <option value="Sold" selected>Sold Comps</option>
                                        <option value="For Sale">For Sale Comps</option>
                                    </select>
                                </div>
                                <div class="input-group" id="ai-sold-since-container">
                                    <label for="ai-sold-since" class="label">Sold Since</label>
                                    <select id="ai-sold-since" class="select">
                                        <option value="1 month">Last 1 Month</option>
                                        <option value="3 months" selected>Last 3 Months</option>
                                        <option value="6 months">Last 6 Months</option>
                                        <option value="12 months">Last 12 Months</option>
                                        <option value="24 months">Last 24 Months</option>
                                        <option value="36 months">Last 36 Months</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="ai-comp-radius" class="label">Search Radius (in miles)</label>
                                <input type="number" id="ai-comp-radius" class="input" placeholder="e.g., 3" value="3">
                            </div>
                            <button id="ai-comp-finder-btn" class="btn btn-primary w-full">
                                <span class="spinner" style="display: none;"></span>
                                ✨ Find Comps with AI
                            </button>
                            <p id="ai-comp-finder-status" class="text-sm text-cyan-400 text-center mt-2" style="display: none;"></p>
                        </div>
                        
                        <!-- Comps Table -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-cyan-400">Manual Comps Entry</h3>
                            <div class="comp-grid mb-2">
                                <div class="comp-grid-header">Address</div>
                                <div class="comp-grid-header">Beds</div>
                                <div class="comp-grid-header">Baths</div>
                                <div class="comp-grid-header">Sq. Ft.</div>
                                <div class="comp-grid-header">Sale Price</div>
                            </div>
                            <div id="comps-list-container">
                                <!-- Comp rows will be dynamically inserted here -->
                            </div>
                            <button id="add-comp-row-btn" class="btn btn-secondary mt-2">Add Comp</button>
                        </div>
                        
                        <!-- Comps Result -->
                        <div class="results-box mt-6">
                            <div class="result-line">
                                <span class="result-line-label">Average Price per Sq. Ft.</span>
                                <span class="result-line-value" id="avg-price-per-sqft-result">---</span>
                            </div>
                            <div class="result-line font-bold text-lg">
                                <span class="result-line-label">Estimated ARV</span>
                                <span class="result-line-value text-cyan-400" id="estimated-arv-result">---</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="use-arv-btn" class="btn btn-success">Use this ARV</button>
                    </div>
                </div>
            </div>

            <!-- ===== AI Rehab Breakdown Modal ===== -->
            <div id="rehab-modal" class="modal">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">AI Rehab Breakdown</h2>
                        <span class="modal-close" id="rehab-modal-close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p class="text-gray-400 mb-4">Describe the rehab, and the AI will generate a budget checklist. This helps you think through your rehab number.</p>
                        <div class="input-group">
                            <label for="rehab-description" class="label">Rehab Description</label>
                            <textarea id="rehab-description" class="input" rows="3" placeholder="e.g., Full kitchen remodel, 2 new bathrooms, new LVP flooring, and interior/exterior paint."></textarea>
                        </div>
                        <button id="ai-rehab-btn" class="btn btn-primary w-full">
                            <span class="spinner" style="display: none;"></span>
                            Generate Breakdown
                        </button>
                        <div id="ai-rehab-output" class="mt-6" style="display: none;">
                            <h4 class="text-lg font-semibold mb-2 text-cyan-400">Suggested Budget Allocation</h4>
                            <p id="ai-rehab-content" class="text-gray-300 whitespace-pre-wrap p-4 bg-gray-800 rounded"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== MAO Calculator Tab ===== -->
            <div id="mao-calculator" class="tab-pane">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Quick MAO Rule -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-2 text-cyan-400">Quick MAO Rule (e.g., 70% Rule)</h3>
                        <p class="text-sm text-gray-400 mb-4">
                            The 70% rule is a common guideline stating you should pay no more than 70% of the ARV, *minus* rehab costs. 
                            <span class="font-bold">Increasing the %</span> is more aggressive (less profit margin). 
                            <span class="font-bold">Decreasing it</span> is more conservative (more profit margin).
                        </p>

                        <div class="input-group">
                            <label for="mao-rule-arv" class="label">After Repair Value (ARV)</label>
                            <input type="text" id="mao-rule-arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                        </div>
                        <div class="input-group">
                            <label for="mao-rule-rehab" class="label">Total Rehab Costs</label>
                            <input type="text" id="mao-rule-rehab" class="input" placeholder="e.g., 40,000" oninput="formatCurrency(this)">
                        </div>
                        <div class="input-group">
                            <label for="mao-rule-slider" class="label">Flip Rule Percentage: <span id="mao-rule-percent" class="font-bold text-cyan-400">70%</span></label>
                            <input type="range" id="mao-rule-slider" min="50" max="100" value="70" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg"
                                style="--thumb-color: var(--primary-color); --track-color: var(--bg-lighter);">
                        </div>
                        <div class="results-box mt-4">
                            <div class="result-line">
                                <span class="result-line-label text-lg">Max Allowable Offer</span>
                                <span class="result-line-value text-2xl text-cyan-400" id="mao-rule-result">---</span>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed MAO (Based on Desired Profit) -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Detailed MAO (By Desired Profit)</h3>
                        <div class="input-group">
                            <label for="mao-profit-arv" class="label">After Repair Value (ARV)</Dlabel>
                            <input type="text" id="mao-profit-arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                        </div>
                        <div class="input-group">
                            <label for="mao-profit-rehab" class="label">Total Rehab Costs</label>
                            <input type="text" id="mao-profit-rehab" class="input" placeholder="e.g., 40,000" oninput="formatCurrency(this)">
                        </div>
                        <div class="input-group">
                            <label for="mao-profit-holding" class="label">Total Holding & Selling Costs</label>
                            <input type="text" id="mao-profit-holding" class="input" placeholder="e.g., 27,000" oninput="formatCurrency(this)">
                        </div>
                        <div class="input-group">
                            <label for="mao-profit-desired" class="label">Desired Profit ($)</label>
                            <input type="text" id="mao-profit-desired" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                        </div>
                        
                        <div class="results-box mt-4">
                            <div class="result-line">
                                <span class="result-line-label text-lg">Max Allowable Offer</span>
                                <span class="result-line-value text-2xl text-cyan-400" id="mao-profit-result">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End MAO Calculator Tab -->

            <!-- ===== AI Market Analyzer Tab ===== -->
            <div id="market-analyzer" class="tab-pane">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- AI Neighborhood Analyzer -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">AI Neighborhood Analyzer</h3>
                        <p class="text-sm text-gray-400 mb-4">Enter a Zip Code or Address to get an AI-powered analysis of the local market, including trends, schools, and amenities.</p>
                        <div class="input-group">
                            <label for="ai-market-address" class="label">Zip Code or Full Address</label>
                            <input type="text" id="ai-market-address" class="input" placeholder="e.g., 80202 or 123 Main St, Denver, CO">
                        </div>
                        <button id="ai-market-btn" class="btn btn-primary w-full">
                            <span class="spinner" style="display: none;"></span>
                            ✨ Analyze Market
                        </button>
                        <div id="ai-market-output" class="mt-6" style="display: none;">
                            <h4 class="text-lg font-semibold mb-2 text-cyan-400">AI Market Analysis</h4>
                            <p id="ai-market-content" class="text-gray-300 whitespace-pre-wrap p-4 bg-gray-900 rounded"></p>
                        </div>
                    </div>

                    <!-- Market Velocity (Sell-Through Rate) -->
                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400">Market Velocity (Sell-Through Rate)</h3>
                        
                        <!-- AI Velocity Search -->
                        <div class="p-3 bg-gray-900 rounded-lg border border-gray-700 mb-4">
                            <h4 class="text-lg font-semibold mb-2 text-cyan-400">AI-Powered Velocity Search</h4>
                            <div class="input-group">
                                <label for="ai-velocity-zip" class="label">Zip Code</label>
                                <input type="text" id="ai-velocity-zip" class="input" placeholder="e.g., 80202">
                            </div>
                            <div class="input-group">
                                <label for="ai-velocity-type" class="label">Property Type (Optional)</label>
                                <input type="text" id="ai-velocity-type" class="input" placeholder="e.g., 3-bed single-family homes">
                            </div>
                            <button id="ai-velocity-btn" class="btn btn-primary w-full">
                                <span class="spinner" style="display: none;"></span>
                                ✨ AI-Powered Velocity Search
                            </button>
                            <p id="ai-velocity-status" class="text-sm text-cyan-400 text-center mt-2" style="display: none;"></p>
                        </div>
                        
                        <!-- Manual Velocity Calculator -->
                        <div class="input-group">
                            <label for="velocity-sold" class="label">Homes Sold (Last 30 Days)</label>
                            <input type="number" id="velocity-sold" class="input" placeholder="e.g., 15">
                        </div>
                        <div class="input-group">
                            <label for="velocity-inventory" class="label">Total Homes For Sale</label>
                            <input type="number" id="velocity-inventory" class="input" placeholder="e.g., 100">
                        </div>
                        <button id="velocity-calculate-btn" class="btn btn-secondary w-full">Calculate Rate</button>

                        <div id="velocity-results-container" class="results-box mt-4" style="display: none;">
                            <div class="result-line">
                                <span class="result-line-label text-lg">Sell-Through Rate</span>
                                <span class="result-line-value text-2xl text-cyan-400" id="velocity-rate-result">---</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label text-lg">Market Type</span>
                                <span class="result-line-value text-2xl" id="velocity-market-result">---</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End AI Market Analyzer Tab -->

            <!-- ===== What If? Tab ===== -->
            <div id="what-if" class="tab-pane">
                <h2 class="text-2xl font-semibold mb-4 text-cyan-400">"What If?" Sensitivity Analysis</h2>
                <p class="text-gray-400 mb-6">See how your profit and ROI change based on different ARV and Rehab Cost scenarios. First, calculate a deal on the "Deal Calculator" tab, then come back here to analyze it.</p>
                
                <div class="results-box">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="text-center p-3 bg-gray-900 rounded">
                            <span class="text-sm text-gray-400 block">Original ARV</span>
                            <span id="what-if-arv-base" class="text-lg font-bold text-cyan-400">---</span>
                        </div>
                        <div class="text-center p-3 bg-gray-900 rounded">
                            <span class="text-sm text-gray-400 block">Original Rehab</span>
                            <span id="what-if-rehab-base" class="text-lg font-bold text-cyan-400">---</span>
                        </div>
                        <div class="text-center p-3 bg-gray-900 rounded">
                            <span class="text-sm text-gray-400 block">Original Profit</span>
                            <span id="what-if-profit-base" class="text-lg font-bold text-cyan-400">---</span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="p-3 text-cyan-400">Profit / ROI</th>
                                    <th id="what-if-arv-low" class="p-3 text-center">ARV -5%</th>
                                    <th id="what-if-arv-mid" class="p-3 text-center font-bold text-cyan-400">Target ARV</th>
                                    <th id="what-if-arv-high" class="p-3 text-center">ARV +5%</th>
                                </tr>
                            </thead>
                            <tbody id="what-if-table-body" class="divide-y divide-gray-700">
                                <!-- Rows will be generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- End What If? Tab -->

            <!-- ===== Batch Analyzer Tab ===== -->
            <div id="batch-analyzer" class="tab-pane">
                <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Batch Deal Analyzer</h2>
                <p class="text-gray-400 mb-4">Upload a CSV file of properties to analyze them in bulk. This tool will run the first 10 properties through the AI Comp Finder and Deal Calculator to find the best deals.</p>
                
                <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                    <div class="input-group">
                        <label class="label">1. Upload your CSV File</label>
                        <div class="flex items-center">
                            <div class="file-input-wrapper">
                                <button class="file-input-btn">Choose File</button>
                                <input type="file" id="csv-file-input" accept=".csv">
                            </div>
                            <span id="file-name" class="ml-4 text-gray-400">No file chosen</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="batch-rehab-cost" class="label">2. Enter Default Rehab Cost (per property)</label>
                        <input type="text" id="batch-rehab-cost" class="input max-w-xs" placeholder="e.g., 40,000" oninput="formatCurrency(this)">
                    </div>

                    <div class="input-group">
                        <label class="label">3. Map Your CSV Columns</label>
                        <button id="map-columns-btn" class="btn btn-secondary" disabled>Map CSV Columns</button>
                    </div>

                    <div class="input-group">
                        <label class="label">4. Run Analyzer</label>
                        <button id="run-batch-btn" class="btn btn-primary" disabled>
                            <span class="spinner" style="display: none;"></span>
                            Analyze First 10 Properties
                        </button>
                    </div>
                </div>

                <div id="batch-results-container" class="mt-6" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-cyan-400">Batch Analysis Results</h3>
                        <button id="download-batch-csv-btn" class="btn btn-success">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download Results
                        </button>
                    </div>
                    <p id="batch-status-text" class="text-cyan-400 mb-4"></p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead id="batch-results-table-head">
                                <!-- JS will populate this -->
                            </thead>
                            <tbody id="batch-results-table-body" class="divide-y divide-gray-700">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> <!-- End Batch Analyzer Tab -->

            <!-- ===== Saved Deals Tab ===== -->
            <div id="saved-deals" class="tab-pane">
                <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Saved Deals</h2>
                <div id="saved-deals-container">
                    <!-- Saved deal cards will be injected here -->
                    <p id="no-saved-deals" class="text-gray-400">You have no saved deals. Calculate a deal and click "Save Deal" to add one.</p>
                </div>
            </div> <!-- End Saved Deals Tab -->

        </div> <!-- End Tab Content -->

    </div> <!-- End Container -->

    <!-- ===== Save Deal Modal ===== -->
    <div id="save-deal-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Save Deal</h2>
                <span class="modal-close" id="save-deal-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="save-deal-name" class="label">Deal Name (e.g., Address)</label>
                    <input type="text" id="save-deal-name" class="input" placeholder="e.g., 123 Main St">
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-save-deal-btn" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>

    <!-- ===== How to Use Modal ===== -->
    <div id="how-to-use-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">How to Use This Calculator</h2>
                <span class="modal-close" id="how-to-use-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="text-lg text-gray-300">Welcome to the Homeland Property Flip Calculator! This is an all-in-one tool designed to help you analyze potential real estate deals from start to finish.</p>
                
                <h4 class="text-cyan-400 text-xl font-semibold mt-6 mb-2">Core Workflow (1-2-3)</h4>
                <ol class="list-decimal pl-6 text-gray-300 space-y-2">
                    <li><strong>Start in "Deal Calculator":</strong> Enter your <code>Purchase Price</code>, <code>Rehab Costs</code>, and <code>ARV</code>.
                        <ul>
                            <li>Not sure on ARV? Click the <code>Calculator</code> button next to ARV to open the <strong>ARV Comps Calculator</strong>.</li>
                            <li>Not sure on Rehab? Click the <code>AI</code> button next to Rehab Costs to open the <strong>AI Rehab Breakdown</strong>.</li>
                        </ul>
                    </li>
                    <li><strong>Fill Out Costs:</strong> Enter your <code>Financing</code>, <code>Holding</code>, and <code>Selling Costs</code>.</li>
                    <li><strong>Calculate & Analyze:</strong> Click <code>Calculate Deal</code> to see your Profit, ROI, and Annualized ROI. From here, you can use the other tabs to analyze the deal further.</li>
                </ol>

                <h4 class="text-cyan-400 text-xl font-semibold mt-6 mb-2">Feature Breakdown by Tab</h4>

                <h5 class="text-cyan-300 text-lg font-semibold mt-4">1. Deal Calculator Tab</h5>
                <ul>
                    <li><strong>Main Calculator:</strong> The core of the tool. Enter all your numbers here to get a detailed breakdown of costs, profit, and returns.</li>
                    <li><strong>ARV Comps Calculator:</strong> A modal tool to help you find the ARV.
                        <ul>
                            <li><strong>AI Comp Finder:</strong> Enter a property address and click "Find Comps with AI". It will use Google Search to find recent comps, auto-fill the table, and calculate an ARV for you.</li>
                            <li><strong>Manual Entry:</strong> You can also manually add your own comps to calculate an ARV based on price per square foot.</li>
                        </ul>
                    </li>
                    <li><strong>AI Rehab Breakdown:</strong> A simple AI tool. Describe your renovation (e.g., "new kitchen and 2 baths") and it provides a suggested budget checklist (e.g., "Kitchen: 40%, Bathrooms: 30%...").</li>
                    <li><strong>AI Deal Summary:</strong> After calculating, click this to get a natural-language summary of the deal's strengths and weaknesses.</li>
                    <li><strong>Save Deal:</strong> Saves all your inputs and results to a "deal card" in the "Saved Deals" tab.</li>
                </ul>

                <h5 class="text-cyan-300 text-lg font-semibold mt-4">2. MAO Calculator Tab</h5>
                <ul>
                    <li><strong>Quick MAO Rule:</strong> Uses a percentage-based rule (like the 70% Rule) to find a quick "Max Allowable Offer". Use the slider to adjust your risk.</li>
                    <li><strong>Detailed MAO:</strong> A more advanced calculation. It works *backwards* from your <code>Desired Profit</code> to tell you the most you can pay for the property.</li>
                </ul>

                <h5 class="text-cyan-300 text-lg font-semibold mt-4">3. AI Market Analyzer Tab</h5>
                <ul>
                    <li><strong>AI Neighborhood Analyzer:</strong> Enter a zip code or address to get an AI-powered report on market trends, schools, and local amenities.</li>
                    <li><strong>AI-Powered Velocity Search:</strong> The fastest way to gauge the market. Enter a zip code, and the AI will search for the number of homes sold vs. for sale to calculate the <strong>Sell-Through Rate</strong>.</li>
                    <li><strong>Manual Sell-Through Rate:</strong> If you have your own numbers, you can enter them here to see the market velocity (i.e., "Hot Seller's Market").</li>
                </ul>

                <h5 class="text-cyan-300 text-lg font-semibold mt-4">4. What If? Tab</h5>
                <ul>
                    <li><strong>Sensitivity Analysis:</strong> After you calculate a deal, this tab shows you a table of how your profit and ROI would change if your ARV is lower or your rehab costs are higher than expected. It's a great way to visualize your risk.</li>
                </ul>
                
                <h5 class="text-cyan-300 text-lg font-semibold mt-4">5. Batch Analyzer Tab</h5>
                <ul>
                    <li><strong>Bulk Analysis Tool:</strong> This is for power users. Upload a CSV of properties, map your columns (e.g., map your "Address" column to the "Full Address" field), and click "Analyze". The tool will run the first 10 properties through the AI Comp Finder and Deal Calculator, then present the results in a table.</li>
                    <li><strong>Download Results:</strong> You can download this new, enriched data as a CSV file to sort and find the best deals in your list.</li>
                </ul>
                
                <h5 class="text-cyan-300 text-lg font-semibold mt-4">6. Saved Deals Tab</h5>
                <ul>
                    <li><strong>Your Deal Pipeline:</strong> Every deal you save from the main calculator appears here as a card. You can quickly see the name, profit, and ROI.</li>
                    <li><strong>Load / Delete:</strong> Click "Load" to instantly repopulate the entire calculator with that deal's data, or click "Delete" to remove it.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="how-to-use-close-btn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- ===== Batch Map Modal ===== -->
    <div id="batch-map-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Map Your CSV Columns</h2>
                <span class="modal-close" id="batch-map-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="text-gray-400 mb-4">Tell the calculator which columns in your CSV file correspond to these key fields. This only needs to be set once per file upload.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div class="input-group">
                        <label class="label text-cyan-400">Address (Option 1)</label>
                        <select id="map-full-address" class="select map-select"></select>
                        <p class="text-xs text-gray-500 mt-1">Use this if your file has the full address in one column (e.g., "123 Main St, Denver, CO 80202").</p>
                    </div>

                    <div class="border-t border-gray-700 md:border-t-0 md:border-l md:pl-6 border-dashed">
                        <label class="label text-cyan-400">Address (Option 2)</label>
                        <div class="input-group">
                            <label for="map-street-address" class="label text-sm">Street Address</label>
                            <select id="map-street-address" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-city" class="label text-sm">City</label>
                            <select id="map-city" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-state" class="label text-sm">State</label>
                            <select id="map-state" class="select map-select"></select>
                        </div>
                         <p class="text-xs text-gray-500 mt-1">Use this if your address is broken into multiple columns.</p>
                    </div>
                </div>

                <hr class="border-gray-700 my-4">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div class="input-group">
                        <label for="map-zip-code" class="label">Zip Code</label>
                        <select id="map-zip-code" class="select map-select"></select>
                        <p class="text-xs text-gray-500 mt-1">Required for AI Market Analyzer.</p>
                    </div>
                    <div class="input-group">
                        <label for="map-sqft" class="label">Square Footage</label>
                        <select id="map-sqft" class="select map-select"></select>
                        <p class="text-xs text-gray-500 mt-1">Required for ARV calculation.</p>
                    </div>
                    <div class="input-group">
                        <label for="map-purchase-price" class="label">Current Value / Est. Price</label>
                        <select id="map-purchase-price" class="select map-select"></select>
                        <p class="text-xs text-gray-500 mt-1">Will be mapped to "Purchase Price".</p>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button id="confirm-map-btn" class="btn btn-success">Save Mapping</button>
            </div>
        </div>
    </div>

    <!-- ===== Main App Script ===== -->
    <script>
        console.log("Homeland Property Flip Calculator script loaded.");

        // --- Global State ---
        // We'll store the full deal object here for "What If" and "Save"
        let currentDealData = null; 
        let savedDeals = [];
        let arvComps = []; // Array to hold comp objects
        let csvData = [];
        let csvHeaders = [];
        let csvColumnMapping = {};

        // --- Helper Functions ---
        const getById = (id) => document.getElementById(id);
        
        const currencyFormatter = (value) => {
            if (isNaN(value)) return "---";
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        };

        const percentFormatter = (value) => {
            if (isNaN(value)) return "---";
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1,
            }).format(value);
        };

        const parseCurrency = (value) => {
            if (typeof value !== 'string') {
                value = String(value);
            }
            return parseFloat(value.replace(/[^0-9.-]+/g, '')) || 0;
        };
        
        const formatCurrencyInput = (input) => {
            let value = input.value;
            let num = parseCurrency(value);
            if (isNaN(num)) {
                input.value = '';
            } else {
                input.value = new Intl.NumberFormat('en-US').format(num);
            }
        };

        const toggleSpinner = (btnId, textContent, show) => {
            const btn = getById(btnId);
            const spinner = btn.querySelector('.spinner');
            const text = btn.querySelector('span:not(.spinner)');
            
            if (show) {
                btn.disabled = true;
                if (spinner) spinner.style.display = 'inline-block';
                if (text) text.textContent = 'Loading...';
            } else {
                btn.disabled = false;
                if (spinner) spinner.style.display = 'none';
                if (text) text.textContent = textContent;
            }
        };

        const openModal = (id) => getById(id).style.display = 'block';
        const closeModal = (id) => getById(id).style.display = 'none';
        
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white';
            if (type === 'success') {
                toast.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'error') {
                toast.style.backgroundColor = 'var(--danger-color)';
            } else {
                toast.style.backgroundColor = 'var(--primary-color)';
            }
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s ease';
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
        };

        // --- Core Deal Calculation ---
        function getDealInputs() {
            return {
                purchasePrice: parseCurrency(getById('purchase-price').value),
                arv: parseCurrency(getById('arv').value),
                rehabCosts: parseCurrency(getById('rehab-costs').value),
                financingType: getById('financing-type').value,
                downPaymentPercent: parseFloat(getById('down-payment-percent').value) / 100 || 0,
                interestRate: parseFloat(getById('interest-rate').value) / 100 || 0,
                loanPoints: parseFloat(getById('loan-points').value) / 100 || 0,
                otherClosingCosts: parseCurrency(getById('other-closing-costs').value),
                holdingMonths: parseInt(getById('holding-months').value) || 0,
                monthlyHoldingCosts: parseCurrency(getById('monthly-holding-costs').value),
                sellingCostsPercent: parseFloat(getById('selling-costs-percent').value) / 100 || 0,
                sellingCostsFlat: parseCurrency(getById('selling-costs-flat').value),
            };
        }

        function calculateDeal(dealInputs) {
            const {
                purchasePrice, arv, rehabCosts, financingType, downPaymentPercent,
                interestRate, loanPoints, otherClosingCosts, holdingMonths,
                monthlyHoldingCosts, sellingCostsPercent, sellingCostsFlat
            } = dealInputs;

            let loanAmount = 0;
            let totalFinancingCosts = 0;
            let downPayment = 0;
            let upfrontCash = 0;
            let totalCashNeeded = 0;

            const totalHoldingCosts = monthlyHoldingCosts * holdingMonths;
            const totalSellingCosts = (arv * sellingCostsPercent) + sellingCostsFlat;

            if (financingType === 'loan') {
                loanAmount = purchasePrice * (1 - downPaymentPercent);
                downPayment = purchasePrice * downPaymentPercent;
                const pointsCost = (loanAmount + (rehabCosts > 0 ? rehabCosts : 0)) * loanPoints; // Points on loan + rehab
                const interestCost = (loanAmount * interestRate / 12) * holdingMonths;
                
                totalFinancingCosts = pointsCost + interestCost + otherClosingCosts;
                upfrontCash = downPayment + otherClosingCosts + pointsCost;
                totalCashNeeded = downPayment + rehabCosts + totalHoldingCosts + totalSellingCosts + interestCost + otherClosingCosts + pointsCost;
            } else {
                // All cash deal
                totalCashNeeded = purchasePrice + rehabCosts + totalHoldingCosts + totalSellingCosts;
            }

            const totalCosts = purchasePrice + rehabCosts + totalHoldingCosts + totalFinancingCosts + totalSellingCosts;
            const grossProfit = arv - totalCosts;

            let roi = 0;
            if (financingType === 'loan') {
                roi = totalCashNeeded > 0 ? grossProfit / totalCashNeeded : 0;
            } else {
                roi = totalCashNeeded > 0 ? grossProfit / totalCashNeeded : 0;
            }
            
            const annualizedRoi = (roi / holdingMonths) * 12;
            const profitPerMonth = holdingMonths > 0 ? grossProfit / holdingMonths : 0;
            
            const totalInvestmentCash = purchasePrice + rehabCosts + totalHoldingCosts + totalSellingCosts;

            return {
                ...dealInputs, // Store inputs for saving
                grossProfit,
                roi,
                annualizedRoi,
                totalCashNeeded,
                totalInvestmentCash,
                profitPerMonth,
                totalCosts,
                totalHoldingCosts,
                totalFinancingCosts,
                totalSellingCosts,
            };
        }

        function displayDealResults(results) {
            currentDealData = results; // Save for other tabs

            getById('gross-profit-result').textContent = currencyFormatter(results.grossProfit);
            getById('gross-profit-result').className = `result-line-value text-2xl ${results.grossProfit >= 0 ? 'profit' : 'loss'}`;
            
            getById('roi-result').textContent = percentFormatter(results.roi);
            getById('roi-result').className = `result-line-value ${results.roi >= 0 ? 'profit' : 'loss'}`;
            
            getById('annualized-roi-result').textContent = percentFormatter(results.annualizedRoi);
            getById('annualized-roi-result').className = `result-line-value ${results.annualizedRoi >= 0 ? 'profit' : 'loss'}`;

            getById('total-cash-needed-result').textContent = currencyFormatter(results.totalCashNeeded);
            getById('total-investment-cash-result').textContent = currencyFormatter(results.totalInvestmentCash);
            getById('profit-per-month-result').textContent = currencyFormatter(results.profitPerMonth);
            
            getById('purchase-price-result').textContent = currencyFormatter(results.purchasePrice);
            getById('rehab-costs-result').textContent = currencyFormatter(results.rehabCosts);
            getById('total-holding-costs-result').textContent = currencyFormatter(results.totalHoldingCosts);
            getById('total-financing-costs-result').textContent = currencyFormatter(results.totalFinancingCosts);
            getById('total-selling-costs-result').textContent = currencyFormatter(results.totalSellingCosts);
            getById('total-costs-result').textContent = currencyFormatter(results.totalCosts);
            getById('profit-check-result').textContent = currencyFormatter(results.arv - results.totalCosts);
            
            getById('results-container').style.display = 'block';
            getById('ai-summary-container').style.display = 'none'; // Hide old summary
            getById('ai-summary-content').textContent = '';
            
            // Auto-populate other tabs
            syncArvFields(results.arv, 'arv');
            getById('mao-rule-rehab').value = new Intl.NumberFormat('en-US').format(results.rehabCosts);
            getById('mao-profit-rehab').value = new Intl.NumberFormat('en-US').format(results.rehabCosts);
            const holdingAndSelling = results.totalHoldingCosts + results.totalFinancingCosts + results.totalSellingCosts;
            getById('mao-profit-holding').value = new Intl.NumberFormat('en-US').format(holdingAndSelling);

            // Trigger "What If" calculation
            calculateWhatIf();
        }

        // --- Gemini API Function ---
        async function callGeminiAPI(userQuery, systemPrompt, jsonSchema = null, useGoogleSearch = false, retries = 3) {
            const apiKey = localStorage.getItem('geminiApiKey') || "";
            if (!apiKey) {
                return { error: "Error: API Key is missing. Please enter your Google AI Studio API Key at the top of the calculator and click 'Save Key'." };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
            };

            if (systemPrompt) {
                payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            }

            if (useGoogleSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            if (jsonSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema
                };
            }
            
            // This is the combined request logic for Search + JSON
            // If we use Google Search AND a JSON schema, we must put the system prompt in the user query.
            if (useGoogleSearch && jsonSchema) {
                payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: systemPrompt + "\n\nUser Query: " + userQuery }]
                    }],
                    tools: [{ "google_search": {} }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: jsonSchema
                    }
                };
                // Remove systemInstruction as it conflicts
                delete payload.systemInstruction;
            } else if (useGoogleSearch && !jsonSchema) {
                // This is for the AI Comp Finder, which does search but *not* a schema
                payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: systemPrompt + "\n\nUser Query: " + userQuery }]
                    }],
                    tools: [{ "google_search": {} }]
                };
                delete payload.systemInstruction;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error Body:", errorBody);
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    
                    const errorReason = errorBody?.error?.details?.[0]?.reason;
                    if (response.status === 400 && errorReason === "API_KEY_INVALID") {
                        errorMsg = "Error: API Key Not Valid. The key you entered is incorrect or has expired. Please get a new key from Google AI Studio.";
                    } else if (response.status === 401 || response.status === 403) {
                        errorMsg = "Error: API Key is invalid or unauthorized. Please check your Google AI Studio API Key and permissions.";
                    }
                    
                    return { error: new Error(errorMsg) };
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    // Clean up markdown if AI returns it
                    text = text.replace(/^```json\n/, '').replace(/\n```$/, '');
                    return { text };
                } else {
                    return { error: new Error("Invalid response structure from API.") };
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                if (retries > 0) {
                    console.log(`Retrying... (${retries} attempts left)`);
                    await new Promise(res => setTimeout(res, (4 - retries) * 1000)); // Exponential backoff
                    return callGeminiAPI(userQuery, systemPrompt, jsonSchema, useGoogleSearch, retries - 1);
                }
                return { error };
            }
        }

        // --- ARV Comps Calculator Logic ---
        function addCompRow(comp = {}) {
            const container = getById('comps-list-container');
            const compId = `comp-${arvComps.length}`;
            const newRow = document.createElement('div');
            newRow.className = 'comp-grid mb-2';
            newRow.id = compId;
            newRow.innerHTML = `
                <div class="input-group">
                    <label for="${compId}-address" class="label md:hidden">Address</label>
                    <input type="text" id="${compId}-address" class="input comp-address" placeholder="123 Main St" value="${comp.address || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-beds" class="label md:hidden">Beds</label>
                    <input type="number" id="${compId}-beds" class="input comp-beds" placeholder="Beds" value="${comp.beds || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-baths" class="label md:hidden">Baths</label>
                    <input type="number" id="${compId}-baths" class="input comp-baths" placeholder="Baths" value="${comp.baths || ''}">
                </div>
                <div class="input-group">
                    <label for="${compId}-sqft" class="label md:hidden">Sq. Ft.</label>
                    <input type="text" id="${compId}-sqft" class="input comp-sqft" placeholder="1,400" value="${comp.sqft || ''}" oninput="formatCurrency(this)">
                </div>
                <div class="input-group">
                    <label for="${compId}-price" class="label md:hidden">Sale Price</label>
                    <input type="text" id="${compId}-price" class="input comp-price" placeholder="410,000" value="${comp.salePrice || ''}" oninput="formatCurrency(this)">
                </div>
            `;
            container.appendChild(newRow);
            
            // Add listeners to re-calculate on change
            newRow.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', calculateArv);
            });

            arvComps.push(newRow); // Add to our tracked array
        }

        function calculateArv() {
            let totalSqft = 0;
            let totalPrice = 0;
            let compCount = 0;

            getById('comps-list-container').querySelectorAll('.comp-grid').forEach(row => {
                const sqft = parseCurrency(row.querySelector('.comp-sqft').value);
                const price = parseCurrency(row.querySelector('.comp-price').value);
                
                if (sqft > 0 && price > 0) {
                    totalSqft += sqft;
                    totalPrice += price;
                    compCount++;
                }
            });

            const avgPricePerSqft = compCount > 0 ? totalPrice / totalSqft : 0;
            const subjectSqft = parseCurrency(getById('subject-sqft').value);
            const estimatedArv = subjectSqft * avgPricePerSqft;

            getById('avg-price-per-sqft-result').textContent = currencyFormatter(avgPricePerSqft);
            getById('estimated-arv-result').textContent = currencyFormatter(estimatedArv);

            return estimatedArv;
        }

        // --- MAO Calculator Logic ---
        function calculateMaoRule() {
            const arv = parseCurrency(getById('mao-rule-arv').value);
            const rehab = parseCurrency(getById('mao-rule-rehab').value);
            const percent = parseFloat(getById('mao-rule-slider').value) / 100;
            
            const mao = (arv * percent) - rehab;
            getById('mao-rule-result').textContent = currencyFormatter(mao);
        }

        function calculateMaoProfit() {
            const arv = parseCurrency(getById('mao-profit-arv').value);
            const rehab = parseCurrency(getById('mao-profit-rehab').value);
            const holdingSelling = parseCurrency(getById('mao-profit-holding').value);
            const profit = parseCurrency(getById('mao-profit-desired').value);

            const mao = arv - rehab - holdingSelling - profit;
            getById('mao-profit-result').textContent = currencyFormatter(mao);
        }
        
        // --- AI Market Analyzer Logic ---
        function calculateVelocity() {
            const sold = parseInt(getById('velocity-sold').value);
            const inventory = parseInt(getById('velocity-inventory').value);
            
            if (isNaN(sold) || isNaN(inventory) || inventory === 0) {
                getById('velocity-rate-result').textContent = "---";
                getById('velocity-market-result').textContent = "---";
                getById('velocity-results-container').style.display = 'none';
                return;
            }
            
            const rate = sold / inventory;
            let marketType = "---";
            let className = "profit"; // Default color

            if (rate < 0.14) {
                marketType = "Strong Buyer's Market";
                className = "loss";
            } else if (rate < 0.16) {
                marketType = "Buyer's Market";
                className = "loss";
            } else if (rate < 0.19) {
                marketType = "Balanced Market";
                className = "profit";
            } else if (rate < 0.22) {
                marketType = "Seller's Market";
                className = "profit";
            } else {
                marketType = "Hot Seller's Market";
                className = "profit";
            }
            
            getById('velocity-rate-result').textContent = percentFormatter(rate);
            getById('velocity-market-result').textContent = marketType;
            getById('velocity-market-result').className = `result-line-value text-2xl ${className}`;
            getById('velocity-results-container').style.display = 'block';
        }

        // --- What If? Logic ---
        function calculateWhatIf() {
            if (!currentDealData) return;

            const { arv, rehabCosts, grossProfit } = currentDealData;

            getById('what-if-arv-base').textContent = currencyFormatter(arv);
            getById('what-if-rehab-base').textContent = currencyFormatter(rehabCosts);
            getById('what-if-profit-base').textContent = currencyFormatter(grossProfit);

            const arvLow = arv * 0.95;
            const arvHigh = arv * 1.05;
            const rehabLow = rehabCosts * 0.90;
            const rehabMid = rehabCosts;
            const rehabHigh = rehabCosts * 1.10;
            const rehabOver = rehabCosts * 1.20;
            
            // Update table headers
            getById('what-if-arv-low').textContent = `ARV -5% (${currencyFormatter(arvLow)})`;
            getById('what-if-arv-mid').textContent = `Target ARV (${currencyFormatter(arv)})`;
            getById('what-if-arv-high').textContent = `ARV +5% (${currencyFormatter(arvHigh)})`;
            
            const tableBody = getById('what-if-table-body');
            tableBody.innerHTML = '';
            
            const scenarios = [
                { label: `Rehab -10% (${currencyFormatter(rehabLow)})`, cost: rehabLow },
                { label: `Target Rehab (${currencyFormatter(rehabMid)})`, cost: rehabMid, isBold: true },
                { label: `Rehab +10% (${currencyFormatter(rehabHigh)})`, cost: rehabHigh },
                { label: `Rehab +20% (${currencyFormatter(rehabOver)})`, cost: rehabOver },
            ];

            const arvScenarios = [arvLow, arv, arvHigh];

            scenarios.forEach(scenario => {
                const row = document.createElement('tr');
                row.className = scenario.isBold ? 'font-bold bg-gray-900' : '';
                
                let rowHtml = `<td class="p-3">${scenario.label}</td>`;
                
                arvScenarios.forEach(arvScenario => {
                    const inputs = { ...currentDealData, arv: arvScenario, rehabCosts: scenario.cost };
                    const result = calculateDeal(inputs);
                    
                    const profitClass = result.grossProfit >= 0 ? 'profit' : 'loss';
                    
                    rowHtml += `
                        <td class="p-3 text-center">
                            <span class="${profitClass}">${currencyFormatter(result.grossProfit)}</span>
                            <br>
                            <span class="text-sm ${profitClass} opacity-80">(${percentFormatter(result.roi)})</span>
                        </td>
                    `;
                });
                
                row.innerHTML = rowHtml;
                tableBody.appendChild(row);
            });
        }

        // --- Batch Analyzer Logic ---
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        reject(new Error("CSV file must have at least one header row and one data row."));
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const data = lines.slice(1).map(line => {
                        // This regex handles commas inside quotes
                        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
                        });
                        return obj;
                    });
                    resolve({ headers, data });
                };
                reader.onerror = (e) => reject(new Error("Error reading file."));
                reader.readAsText(file);
            });
        }

        function openMapModal() {
            if (!csvHeaders.length) {
                showToast("Please upload a CSV file first.", "error");
                return;
            }
            const selects = document.querySelectorAll('.map-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">-- Select Column --</option>'; // Clear old options
                csvHeaders.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
                // Try to auto-select based on common names
                const id = select.id;
                const commonNames = {
                    'map-full-address': ['Full Address', 'Parcel Full Address', 'Address', 'Property Address'],
                    'map-street-address': ['Street Address', 'Parcel Address', 'Address1'],
                    'map-city': ['City', 'Parcel City'],
                    'map-state': ['State', 'Parcel State'],
                    'map-zip-code': ['ZIP', 'Zip Code', 'Parcel ZIP'],
                    'map-sqft': ['Sq Ft', 'Structure Sq Ft', 'Living Area'],
                    'map-purchase-price': ['Market Value Estimate', 'Market Total Parcel Value', 'Est Value', 'Price']
                };
                const matchingHeader = csvHeaders.find(h => commonNames[id]?.some(name => h.toLowerCase() === name.toLowerCase()));
                if (matchingHeader) {
                    select.value = matchingHeader;
                }
            });
            openModal('batch-map-modal');
        }

        async function runBatchAnalysis() {
            const defaultRehab = parseCurrency(getById('batch-rehab-cost').value);
            if (defaultRehab === 0) {
                showToast("Please enter a default rehab cost.", "error");
                return;
            }
            if (Object.keys(csvColumnMapping).length === 0) {
                showToast("Please map your CSV columns first.", "error");
                return;
            }

            toggleSpinner('run-batch-btn', 'Analyze First 10 Properties', true);
            getById('batch-results-container').style.display = 'block';
            const statusText = getById('batch-status-text');
            const tableHead = getById('batch-results-table-head');
            const tableBody = getById('batch-results-table-body');

            // Prepare table
            tableHead.innerHTML = `
                <tr>
                    <th class="p-3">Address</th>
                    <th class="p-3">Est. Purchase Price</th>
                    <th class="p-3">Est. ARV (AI)</th>
                    <th class="p-3">Est. Rehab</th>
                    <th class="p-3">Est. Profit (AI)</th>
                    <th class="p-3">Est. ROI (AI)</th>
                    <th class="p-3">MAO (70% Rule)</th>
                    <th class="p-3">Status</th>
                </tr>
            `;
            tableBody.innerHTML = '';
            
            const propertiesToAnalyze = csvData.slice(0, 10);
            let resultsData = [];

            for (let i = 0; i < propertiesToAnalyze.length; i++) {
                const row = propertiesToAnalyze[i];
                statusText.textContent = `Analyzing property ${i + 1} of ${propertiesToAnalyze.length}...`;
                
                // 1. Construct Address
                let fullAddress = "";
                if (csvColumnMapping.fullAddress) {
                    fullAddress = row[csvColumnMapping.fullAddress];
                } else if (csvColumnMapping.streetAddress && csvColumnMapping.city && csvColumnMapping.state) {
                    fullAddress = `${row[csvColumnMapping.streetAddress]}, ${row[csvColumnMapping.city]}, ${row[csvColumnMapping.state]}`;
                }
                
                const zip = row[csvColumnMapping.zipCode] || '';
                if (!fullAddress && zip) {
                    fullAddress = zip; // Fallback to zip
                }

                if (!fullAddress) {
                    statusText.textContent = `Skipping row ${i + 1}: Missing address information.`;
                    continue;
                }

                const purchasePrice = parseCurrency(row[csvColumnMapping.purchasePrice]);
                const sqft = parseCurrency(row[csvColumnMapping.sqft]);

                if (sqft === 0) {
                    statusText.textContent = `Skipping ${fullAddress}: Missing Sq. Ft.`;
                    continue;
                }

                // 2. Run AI Comp Finder to get ARV
                const compQuery = `Find recent sold homes near ${fullAddress}.`;
                const compPrompt = `You are a real estate comping expert. Find recently sold comparable properties for ${fullAddress}. Return a JSON array of comps, up to 10. For each comp, include "address", "salePrice", and "sqft".
                
                Example:
                {
                  "comps": [
                    { "address": "125 Main St, Denver, CO", "salePrice": 400000, "sqft": 1500 },
                    { "address": "127 Main St, Denver, CO", "salePrice": 410000, "sqft": 1550 }
                  ]
                }
                
                If you cannot find any comps, return { "comps": [] }.
                YOU MUST return ONLY the JSON object and no other text.`;

                const compResult = await callGeminiAPI(compQuery, compPrompt, null, true, 2);
                let estArv = 0;
                let analysisStatus = "Error";
                let estProfit = 0, estRoi = 0, estMao = 0;

                if (!compResult.error) {
                    try {
                        const compsData = JSON.parse(compResult.text);
                        if (compsData.comps && compsData.comps.length > 0) {
                            let totalSqft = 0;
                            let totalPrice = 0;
                            compsData.comps.forEach(c => {
                                totalSqft += parseFloat(c.sqft) || 0;
                                totalPrice += parseFloat(c.salePrice) || 0;
                            });
                            const avgPpsqf = totalSqft > 0 ? totalPrice / totalSqft : 0;
                            estArv = avgPpsqf * sqft;
                            analysisStatus = "Success";
                        } else {
                            analysisStatus = "No Comps Found";
                        }
                    } catch (e) {
                        console.error("AI Comp Parse Error (Batch):", e, compResult.text);
                        analysisStatus = "AI Error";
                    }
                } else {
                    analysisStatus = "API Error";
                }

                // 3. Run Deal Calculation
                if (analysisStatus === "Success") {
                    const inputs = getDealInputs(); // Get defaults
                    inputs.purchasePrice = purchasePrice;
                    inputs.arv = estArv;
                    inputs.rehabCosts = defaultRehab;
                    
                    const deal = calculateDeal(inputs);
                    estProfit = deal.grossProfit;
                    estRoi = deal.roi;
                    estMao = (estArv * 0.70) - defaultRehab;
                }
                
                // 4. Add to results and table
                const resultRow = {
                    ...row, // Original data
                    "Est. ARV (AI)": currencyFormatter(estArv),
                    "Est. Rehab": currencyFormatter(defaultRehab),
                    "Est. Profit (AI)": currencyFormatter(estProfit),
                    "Est. ROI (AI)": percentFormatter(estRoi),
                    "MAO (70% Rule)": currencyFormatter(estMao),
                    "Analysis Status": analysisStatus
                };
                resultsData.push(resultRow);

                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-800">
                        <td class="p-3">${fullAddress}</td>
                        <td class="p-3">${currencyFormatter(purchasePrice)}</td>
                        <td class="p-3">${currencyFormatter(estArv)}</td>
                        <td class="p-3">${currencyFormatter(defaultRehab)}</td>
                        <td class="p-3 ${estProfit > 0 ? 'profit' : 'loss'}">${currencyFormatter(estProfit)}</td>
                        <td class="p-3 ${estRoi > 0 ? 'profit' : 'loss'}">${percentFormatter(estRoi)}</td>
                        <td class="p-3">${currencyFormatter(estMao)}</td>
                        <td class="p-3">${analysisStatus}</td>
                    </tr>
                `;
            }
            
            statusText.textContent = `Analysis complete for ${propertiesToAnalyze.length} properties.`;
            toggleSpinner('run-batch-btn', 'Analyze First 10 Properties', false);
            csvData = resultsData; // Overwrite for download
        }

        function downloadBatchCSV() {
            if (csvData.length === 0) {
                showToast("No data to download.", "error");
                return;
            }

            const headers = Object.keys(csvData[0]);
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\n";

            csvData.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header] ? row[header].toString() : '';
                    // Handle values with commas
                    if (cell.includes(',')) {
                        cell = `"${cell}"`;
                    }
                    return cell;
                });
                csvContent += values.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "flip_analysis_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Saved Deals Logic ---
        function saveDeal() {
            const dealName = getById('save-deal-name').value.trim();
            if (!dealName) {
                showToast("Please enter a deal name.", "error");
                return;
            }
            if (!currentDealData) {
                showToast("Please calculate a deal first.", "error");
                return;
            }
            
            const dealToSave = {
                id: `deal-${new Date().getTime()}`,
                name: dealName,
                ...currentDealData
            };
            
            savedDeals.push(dealToSave);
            localStorage.setItem('savedDeals', JSON.stringify(savedDeals));
            renderSavedDeals();
            closeModal('save-deal-modal');
            showToast("Deal saved successfully!", "success");
        }

        function loadDeal(id) {
            const deal = savedDeals.find(d => d.id === id);
            if (!deal) return;

            // Load inputs
            getById('purchase-price').value = new Intl.NumberFormat('en-US').format(deal.purchasePrice);
            getById('arv').value = new Intl.NumberFormat('en-US').format(deal.arv);
            getById('rehab-costs').value = new Intl.NumberFormat('en-US').format(deal.rehabCosts);
            getById('financing-type').value = deal.financingType;
            getById('down-payment-percent').value = deal.downPaymentPercent * 100;
            getById('interest-rate').value = deal.interestRate * 100;
            getById('loan-points').value = deal.loanPoints * 100;
            getById('other-closing-costs').value = new Intl.NumberFormat('en-US').format(deal.otherClosingCosts);
            getById('holding-months').value = deal.holdingMonths;
            getById('monthly-holding-costs').value = new Intl.NumberFormat('en-US').format(deal.monthlyHoldingCosts);
            getById('selling-costs-percent').value = deal.sellingCostsPercent * 100;
            getById('selling-costs-flat').value = new Intl.NumberFormat('en-US').format(deal.sellingCostsFlat);

            // Re-calculate and display
            calculateDeal(deal);
            
            // Switch to main tab
            showTab('deal-calculator');
            showToast(`Deal "${deal.name}" loaded.`, "info");
        }

        function deleteDeal(id) {
            if (!confirm("Are you sure you want to delete this deal?")) return;
            savedDeals = savedDeals.filter(d => d.id !== id);
            localStorage.setItem('savedDeals', JSON.stringify(savedDeals));
            renderSavedDeals();
            showToast("Deal deleted.", "info");
        }

        function renderSavedDeals() {
            const container = getById('saved-deals-container');
            const noDealsMsg = getById('no-saved-deals');
            
            container.innerHTML = ''; // Clear
            
            if (savedDeals.length === 0) {
                container.appendChild(noDealsMsg);
                return;
            }

            savedDeals.forEach(deal => {
                const card = document.createElement('div');
                card.className = 'deal-card';
                card.innerHTML = `
                    <div class="deal-card-header">
                        <h4 class="deal-card-title">${deal.name}</h4>
                        <div class="deal-card-profit ${deal.grossProfit >= 0 ? 'profit' : 'loss'}">
                            ${currencyFormatter(deal.grossProfit)}
                        </div>
                    </div>
                    <div class="deal-card-body">
                        <div>
                            <span class="deal-card-label">ROI</span>
                            <span class="deal-card-value ${deal.roi >= 0 ? 'profit' : 'loss'}">${percentFormatter(deal.roi)}</span>
                        </div>
                        <div>
                            <span class="deal-card-label">ARV</span>
                            <span class="deal-card-value">${currencyFormatter(deal.arv)}</span>
                        </div>
                        <div>
                            <span class="deal-card-label">Purchase</span>
                            <span class="deal-card-value">${currencyFormatter(deal.purchasePrice)}</span>
                        </div>
                    </div>
                    <div class="deal-card-footer">
                        <button class="btn btn-secondary btn-sm" onclick="loadDeal('${deal.id}')">Load</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDeal('${deal.id}')">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- Tab & ARV Sync Logic ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-link').forEach(link => {
                link.classList.remove('active');
            });
            
            getById(tabId).classList.add('active');
            document.querySelector(`.tab-link[onclick="showTab('${tabId}')"]`).classList.add('active');
        }
        
        function syncArvFields(value, sourceId) {
            const arv = parseCurrency(value);
            const formattedArv = new Intl.NumberFormat('en-US').format(arv);

            if (sourceId !== 'arv') getById('arv').value = formattedArv;
            if (sourceId !== 'mao-rule-arv') getById('mao-rule-arv').value = formattedArv;
            if (sourceId !== 'mao-profit-arv') getById('mao-profit-arv').value = formattedArv;
            
            // Recalculate MAO fields if they were changed
            if (sourceId.startsWith('mao-')) {
                calculateMaoRule();
                calculateMaoProfit();
            }
        }
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing calculator...");

            // --- Main Tab Navigation ---
            document.querySelectorAll('.tab-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = e.currentTarget.getAttribute('onclick').match(/'(.*?)'/)[1];
                    showTab(tabId);
                });
            });

            // --- API Key ---
            getById('save-api-key-btn').addEventListener('click', () => {
                const key = getById('api-key-input').value.trim();
                localStorage.setItem('geminiApiKey', key);
                getById('api-key-input').value = '******************';
                showToast("API Key saved successfully!", "success");
            });
            // Load saved key on start
            if (localStorage.getItem('geminiApiKey')) {
                getById('api-key-input').value = '******************';
            }

            // --- How-to-Use Modal ---
            getById('how-to-use-btn').addEventListener('click', () => openModal('how-to-use-modal'));
            getById('how-to-use-modal-close').addEventListener('click', () => closeModal('how-to-use-modal'));
            getById('how-to-use-close-btn').addEventListener('click', () => closeModal('how-to-use-modal'));
            
            // --- Deal Calculator Tab ---
            getById('financing-type').addEventListener('change', (e) => {
                getById('loan-inputs-container').style.display = e.target.value === 'loan' ? 'block' : 'none';
            });
            
            getById('calculate-deal-btn').addEventListener('click', () => {
                const inputs = getDealInputs();
                displayDealResults(calculateDeal(inputs));
            });
            
            getById('get-deal-summary-btn').addEventListener('click', async () => {
                if (!currentDealData) {
                    showToast("Please calculate a deal first.", "error");
                    return;
                }
                const container = getById('ai-summary-container');
                const content = getById('ai-summary-content');
                const spinner = getById('ai-summary-spinner');
                
                container.style.display = 'block';
                content.style.display = 'none';
                spinner.style.display = 'flex';

                const prompt = `Analyze this real estate flip deal:\n${JSON.stringify(currentDealData, null, 2)}`;
                const systemPrompt = "You are a seasoned real estate investor. Provide a concise, bulleted summary of the strengths and weaknesses of this deal. Focus on profit, ROI, and cash needed.";
                
                const result = await callGeminiAPI(prompt, systemPrompt);
                
                spinner.style.display = 'none';
                content.style.display = 'block';
                if (result.error) {
                    content.textContent = result.error;
                } else {
                    content.textContent = result.text;
                }
            });

            getById('print-report-btn').addEventListener('click', () => {
                if (!currentDealData) {
                    showToast("Please calculate a deal first.", "error");
                    return;
                }
                const reportWindow = window.open('', '', 'height=800,width=800');
                reportWindow.document.write('<html><head><title>Flip Analysis Report</title>');
                reportWindow.document.write('<style> body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; padding: 20px; background: #f4f4f4; color: #333;} .container { max-width: 750px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); } h1 { color: #007BFF; border-bottom: 2px solid #007BFF; padding-bottom: 10px; } h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 30px; } .line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dotted #ccc; } .line-label { font-weight: bold; color: #555; } .line-value { font-weight: bold; } .profit { color: #28a745; } .loss { color: #dc3545; } </style>');
                reportWindow.document.write('</head><body><div class="container">');
                reportWindow.document.write(`<h1>Flip Analysis Report: ${getById('save-deal-name').value || 'My Deal'}</h1>`);
                
                const results = currentDealData;
                const profitClass = results.grossProfit >= 0 ? 'profit' : 'loss';
                const roiClass = results.roi >= 0 ? 'profit' : 'loss';
                
                reportWindow.document.write('<h2>Key Metrics</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Estimated Gross Profit</span><span class="line-value ${profitClass}">${currencyFormatter(results.grossProfit)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Return on Investment (ROI)</span><span class="line-value ${roiClass}">${percentFormatter(results.roi)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Annualized ROI</span><span class="line-value ${roiClass}">${percentFormatter(results.annualizedRoi)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Cash Needed</span><span class="line-value">${currencyFormatter(results.totalCashNeeded)}</span></div>`);
                
                reportWindow.document.write('<h2>Deal Assumptions</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Purchase Price</span><span class="line-value">${currencyFormatter(results.purchasePrice)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">After Repair Value (ARV)</span><span class="line-value">${currencyFormatter(results.arv)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Rehab Costs</span><span class="line-value">${currencyFormatter(results.rehabCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Project Length</span><span class="line-value">${results.holdingMonths} Months</span></div>`);
                
                reportWindow.document.write('<h2>Cost Breakdown</h2>');
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Holding Costs</span><span class="line-value">${currencyFormatter(results.totalHoldingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Financing Costs</span><span class="line-value">${currencyFormatter(results.totalFinancingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line"><span class="line-label">Total Selling Costs</span><span class="line-value">${currencyFormatter(results.totalSellingCosts)}</span></div>`);
                reportWindow.document.write(`<div class="line" style="border-top: 2px solid #333; font-weight: bold;"><span class="line-label">Total All Costs</span><span class="line-value">${currencyFormatter(results.totalCosts)}</span></div>`);

                reportWindow.document.write('</div></body></html>');
                reportWindow.document.close();
                reportWindow.print();
            });

            // --- ARV Comps Modal ---
            getById('arv-comps-btn').addEventListener('click', () => {
                // Clear old comps
                getById('comps-list-container').innerHTML = '';
                arvComps = [];
                // Add 3 default rows
                addCompRow();
                addCompRow();
                addCompRow();
                // Reset results
                calculateArv();
                openModal('arv-modal');
            });
            getById('arv-modal-close').addEventListener('click', () => closeModal('arv-modal'));
            getById('add-comp-row-btn').addEventListener('click', () => addCompRow());
            getById('use-arv-btn').addEventListener('click', () => {
                const estArv = parseCurrency(getById('estimated-arv-result').textContent);
                if (estArv > 0) {
                    syncArvFields(estArv, 'arv-modal');
                    showToast("ARV updated successfully!", "success");
                    closeModal('arv-modal');
                } else {
                    showToast("Cannot use an ARV of $0.", "error");
                }
            });
            
            getById('ai-comp-status').addEventListener('change', (e) => {
                getById('ai-sold-since-container').style.display = e.target.value === 'Sold' ? 'block' : 'none';
            });

            getById('ai-comp-finder-btn').addEventListener('click', async () => {
                const address = getById('subject-address').value.trim();
                const radius = getById('ai-comp-radius').value || '3';
                const status = getById('ai-comp-status').value;
                const soldSince = getById('ai-sold-since').value;
                const statusText = getById('ai-comp-finder-status');

                if (!address) {
                    showToast("Please enter a subject property address.", "error");
                    return;
                }

                toggleSpinner('ai-comp-finder-btn', '✨ Find Comps with AI', true);
                statusText.textContent = "Finding comps...";
                statusText.style.display = 'block';

                const query = `${status} home comps near ${address} within a ${radius} mile radius. ${status === 'Sold' ? `Sold in the last ${soldSince}.` : ''}`;
                const prompt = `You are a real estate comping expert. Find ${status} comparable properties for ${address} within a ${radius} mile radius. ${status === 'Sold' ? `Must be sold in the last ${soldSince}.` : ''}
                Return a JSON object with a single key "comps", which is an array. For each comp, include "address", "beds", "baths", "sqft", and "salePrice".
                
                Example:
                {
                  "comps": [
                    { "address": "125 Main St, Denver, CO", "beds": 3, "baths": 2, "sqft": 1500, "salePrice": 400000 },
                    { "address": "127 Main St, Denver, CO", "beds": 3, "baths": 2.5, "sqft": 1550, "salePrice": 410000 }
                  ]
                }
                
                If you cannot find at least 3 comps, return { "comps": [] }.
                YOU MUST return ONLY the JSON object and no other text.`;

                const result = await callGeminiAPI(query, prompt, null, true, 2);
                
                toggleSpinner('ai-comp-finder-btn', '✨ Find Comps with AI', false);
                getById('comps-list-container').innerHTML = ''; // Clear existing rows
                arvComps = [];

                if (result.error) {
                    statusText.textContent = result.error.message;
                } else {
                    try {
                        const compsData = JSON.parse(result.text);
                        if (compsData.comps && compsData.comps.length > 0) {
                            if (compsData.comps.length < 3) {
                                statusText.textContent = `Only ${compsData.comps.length} comps found. Try expanding your criteria.`;
                            } else {
                                statusText.textContent = `Success! Found ${compsData.comps.length} comps.`;
                            }
                            compsData.comps.forEach(comp => addCompRow(comp));
                        } else {
                            statusText.textContent = "No comps found matching your criteria. Please try a larger radius or different timeframe.";
                            addCompRow(); addCompRow(); addCompRow(); // Add empty rows
                        }
                    } catch (e) {
                        console.error("AI Comp Parse Error:", e, result.text);
                        statusText.textContent = "AI response was in an invalid format. Please try again.";
                        addCompRow(); addCompRow(); addCompRow(); // Add empty rows
                    }
                }
                calculateArv(); // Recalculate with new comps
            });

            // --- AI Rehab Modal ---
            getById('rehab-breakdown-btn').addEventListener('click', () => {
                getById('ai-rehab-content').textContent = '';
                getById('ai-rehab-output').style.display = 'none';
                openModal('rehab-modal');
            });
            getById('rehab-modal-close').addEventListener('click', () => closeModal('rehab-modal'));
            getById('ai-rehab-btn').addEventListener('click', async () => {
                const description = getById('rehab-description').value.trim();
                if (!description) {
                    showToast("Please describe the rehab.", "error");
                    return;
                }
                
                toggleSpinner('ai-rehab-btn', 'Generate Breakdown', true);
                const outputDiv = getById('ai-rehab-output');
                const contentP = getById('ai-rehab-content');
                outputDiv.style.display = 'block';

                const prompt = `Generate a typical budget allocation checklist (using percentages) for a house flip with the following rehab description: "${description}"`;
                const systemPrompt = "You are a general contractor. Provide a simple, bulleted checklist of rehab items and their estimated percentage of the total budget. Do not add any introductory or concluding text. Just the list.";

                const result = await callGeminiAPI(prompt, systemPrompt);
                
                toggleSpinner('ai-rehab-btn', 'Generate Breakdown', false);
                if (result.error) {
                    contentP.textContent = result.error.message;
                } else {
                    contentP.textContent = result.text;
                }
            });

            // --- MAO Calculator Tab ---
            getById('mao-rule-arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'mao-rule-arv');
                calculateMaoRule();
            });
            getById('mao-profit-arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'mao-profit-arv');
                calculateMaoProfit();
            });
            getById('arv').addEventListener('input', (e) => {
                syncArvFields(e.target.value, 'arv');
            });
            
            getById('mao-rule-slider').addEventListener('input', (e) => {
                getById('mao-rule-percent').textContent = `${e.target.value}%`;
                calculateMaoRule();
            });
            [getById('mao-rule-rehab'), getById('mao-rule-slider')].forEach(el => {
                el.addEventListener('input', calculateMaoRule);
            });
            [getById('mao-profit-rehab'), getById('mao-profit-holding'), getById('mao-profit-desired')].forEach(el => {
                el.addEventListener('input', calculateMaoProfit);
            });

            // --- AI Market Analyzer Tab ---
            getById('ai-market-btn').addEventListener('click', async () => {
                const address = getById('ai-market-address').value.trim();
                if (!address) {
                    showToast("Please enter a zip code or address.", "error");
                    return;
                }
                
                toggleSpinner('ai-market-btn', '✨ Analyze Market', true);
                const outputDiv = getById('ai-market-output');
                const contentP = getById('ai-market-content');
                outputDiv.style.display = 'block';

                const query = `Provide a real estate market analysis for ${address}`;
                const systemPrompt = "You are a real estate market analyst. Provide a summary of the market trends, school ratings, and local amenities for this area. Use bullet points.";

                const result = await callGeminiAPI(query, systemPrompt, null, true);
                
                toggleSpinner('ai-market-btn', '✨ Analyze Market', false);
                if (result.error) {
                    contentP.textContent = result.error.message;
                } else {
                    contentP.textContent = result.text;
                }
            });
            
            getById('velocity-calculate-btn').addEventListener('click', calculateVelocity);

            getById('ai-velocity-btn').addEventListener('click', async () => {
                const zip = getById('ai-velocity-zip').value.trim();
                const type = getById('ai-velocity-type').value.trim() || 'homes';
                if (!zip) {
                    showToast("Please enter a zip code.", "error");
                    return;
                }
                
                toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', true);
                const statusText = getById('ai-velocity-status');
                statusText.textContent = "Searching for market data...";
                statusText.style.display = 'block';

                // --- Two-Step AI Velocity Search ---
                // Step 1: Search for raw data
                const searchQuery = `real estate market data ${type} for sale vs sold in last 30 days in zip code ${zip}`;
                const searchPrompt = "You are a real estate data scraper. Find the total number of homes for sale right now AND the number of homes sold in the last 30 days for the following query. Provide this data as raw text.";
                
                const searchResult = await callGeminiAPI(searchQuery, searchPrompt, null, true, 2);

                if (searchResult.error) {
                    toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', false);
                    statusText.textContent = searchResult.error.message;
                    return;
                }

                statusText.textContent = "Data found. Extracting numbers...";

                // Step 2: Extract numbers from the raw data
                const extractQuery = `From the text below, extract "homesSold" (number sold in last 30 days) and "homesForSale" (total current inventory).
                
                TEXT: """${searchResult.text}"""
                `;
                const extractPrompt = "Extract the two numbers from the user's query and return ONLY a JSON object in the specified format.";
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "homesSold": { "type": "NUMBER" },
                        "homesForSale": { "type": "NUMBER" }
                    },
                    required: ["homesSold", "homesForSale"]
                };

                const extractResult = await callGeminiAPI(extractQuery, extractPrompt, schema, false, 2);

                toggleSpinner('ai-velocity-btn', '✨ AI-Powered Velocity Search', false);
                
                if (extractResult.error) {
                    statusText.textContent = extractResult.error.message;
                } else {
                    try {
                        const data = JSON.parse(extractResult.text);
                        getById('velocity-sold').value = data.homesSold;
                        getById('velocity-inventory').value = data.homesForSale;
                        calculateVelocity();
                        statusText.textContent = "Success! Data populated below.";
                    } catch (e) {
                        console.error("AI Velocity Parse Error:", e, extractResult.text);
                        statusText.textContent = "AI response was in an invalid format. Please try again.";
                    }
                }
            });

            // --- Batch Analyzer Tab ---
            getById('csv-file-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                getById('file-name').textContent = file.name;
                try {
                    const { headers, data } = await parseCSV(file);
                    csvHeaders = headers;
                    csvData = data;
                    getById('map-columns-btn').disabled = false;
                    getById('run-batch-btn').disabled = true; // Force re-mapping
                    showToast("CSV file loaded successfully!", "success");
                    openMapModal(); // Automatically open map modal
                } catch (error) {
                    showToast(error.message, "error");
                    getById('file-name').textContent = "No file chosen";
                }
            });
            
            getById('map-columns-btn').addEventListener('click', openMapModal);
            
            getById('batch-map-modal-close').addEventListener('click', () => closeModal('batch-map-modal'));
            
            getById('confirm-map-btn').addEventListener('click', () => {
                csvColumnMapping.fullAddress = getById('map-full-address').value;
                csvColumnMapping.streetAddress = getById('map-street-address').value;
                csvColumnMapping.city = getById('map-city').value;
                csvColumnMapping.state = getById('map-state').value;
                csvColumnMapping.zipCode = getById('map-zip-code').value;
                csvColumnMapping.sqft = getById('map-sqft').value;
                csvColumnMapping.purchasePrice = getById('map-purchase-price').value;

                // Validation
                const hasOption1 = csvColumnMapping.fullAddress;
                const hasOption2 = csvColumnMapping.streetAddress && csvColumnMapping.city && csvColumnMapping.state;

                if (!hasOption1 && !hasOption2) {
                    showToast("Please map either Full Address (Option 1) or all of Option 2.", "error");
                    return;
                }
                if (!csvColumnMapping.zipCode || !csvColumnMapping.sqft || !csvColumnMapping.purchasePrice) {
                    showToast("Please map Zip Code, Sq. Ft., and Current Value.", "error");
                    return;
                }
                
                getById('run-batch-btn').disabled = false;
                closeModal('batch-map-modal');
                showToast("Column mapping saved!", "success");
            });
            
            getById('run-batch-btn').addEventListener('click', runBatchAnalysis);
            getById('download-batch-csv-btn').addEventListener('click', downloadBatchCSV);

            // --- Saved Deals Tab ---
            getById('save-deal-btn').addEventListener('click', () => {
                if (currentDealData) {
                    getById('save-deal-name').value = getById('subject-address').value.trim() || '';
                    openModal('save-deal-modal');
                } else {
                    showToast("Please calculate a deal first.", "error");
                }
            });
            getById('save-deal-modal-close').addEventListener('click', () => closeModal('save-deal-modal'));
            getById('confirm-save-deal-btn').addEventListener('click', saveDeal);
            
            // --- Init ---
            // Load saved deals from localStorage
            try {
                const storedDeals = localStorage.getItem('savedDeals');
                if (storedDeals) {
                    savedDeals = JSON.parse(storedDeals);
                    renderSavedDeals();
                }
            } catch (e) {
                console.error("Error loading saved deals:", e);
                localStorage.removeItem('savedDeals');
            }

            // Trigger initial tab
            showTab('deal-calculator');
            
            // Trigger initial MAO calculations
            calculateMaoRule();
            calculateMaoProfit();
            
            // Add initial 3 comp rows
            addCompRow();
            addCompRow();
            addCompRow();

            // Add auto-formatting to all currency inputs
            document.querySelectorAll('input[oninput="formatCurrency(this)"]').forEach(input => {
                input.addEventListener('input', () => formatCurrencyInput(input));
                // Format any pre-filled values
                if(input.value) formatCurrencyInput(input);
            });
        });
    </script>
</html>


