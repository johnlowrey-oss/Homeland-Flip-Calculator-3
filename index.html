<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeland Property Flip Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #2a2f4a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0c0;
            --primary-color: #00e0ff;
            --primary-hover: #00b8d4;
            --danger-color: #ff4d4d;
            --success-color: #39ff14;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        
        .tab-link:hover {
            color: var(--text-primary);
        }

        .tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-pane {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .input, .select, .textarea {
            width: 100%;
            background-color: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem; /* 16px to prevent iOS zoom */
            transition: all 0.2s ease-in-out;
        }
        
        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 224, 255, 0.2);
        }
        
        .input::placeholder, .textarea::placeholder {
            color: #505070;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            line-height: 1.5;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background-color: #3a3f6a;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--text-primary);
        }
        
        .btn-danger:hover {
            background-color: #cc3d3d;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 99px;
            line-height: 1;
        }
        .btn-icon:hover {
            background-color: var(--danger-color);
            color: var(--text-primary);
        }

        .result-box {
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--bg-tertiary);
            height: 100%;
        }
        
        .result-box-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        
        .subsection-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
            padding-bottom: 0.5rem;
        }
        
        .result-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .result-line:last-child {
            border-bottom: none;
        }
        
        .result-line-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .result-line-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .total-line {
            border-top: 2px solid var(--primary-color);
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .total-line .result-line-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .profit {
            color: var(--success-color) !important;
        }
        
        .loss {
            color: var(--danger-color) !important;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .grid-container {
                grid-template-columns: 1fr 1fr;
            }
            .grid-container-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-output-box {
            background-color: var(--bg-primary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--bg-tertiary);
        }

        .ai-output-content {
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .what-if-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        
        .what-if-table th, .what-if-table td {
            padding: 0.75rem;
            border: 1px solid var(--bg-tertiary);
            font-size: 0.875rem;
        }
        
        .what-if-table th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
        }
        
        .what-if-table .base-cell {
            background-color: rgba(0, 224, 255, 0.1);
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 1.5rem 2rem;
            border: 1px solid var(--bg-tertiary);
            width: 90%;
            max-width: 800px;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-tertiary);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            color: var(--text-secondary);
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            color: var(--text-secondary);
        }
        
        .modal-text {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .modal-footer {
            border-top: 1px solid var(--bg-tertiary);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .comp-grid {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 1.5fr;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .rehab-item-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        /* Mobile Responsive for Comp Grid */
        @media (max-width: 768px) {
            .comp-grid {
                grid-template-columns: 1fr;
                gap: 0;
                border: 1px solid var(--bg-tertiary);
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .comp-grid .input-group {
                margin-bottom: 0.75rem;
            }
            .comp-grid .label {
                display: block; /* Show labels on mobile */
            }
            .comp-grid-header {
                display: none; /* Hide desktop header on mobile */
            }
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--bg-tertiary);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .deal-card {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .deal-card:hover {
            border-color: var(--primary-color);
        }
        .deal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-primary);
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .deal-card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .deal-card-profit {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .deal-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .deal-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .deal-card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }
        .deal-card-footer {
            display: flex;
            gap: 0.5rem;
        }
        
        .file-input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background-color: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover {
            border-color: var(--primary-color);
        }
        .file-input-label span:first-child {
            background-color: var(--bg-tertiary);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .file-name-display {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-bg-primary">
    
    <div class="container">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-8">
            <h1 class="text-3xl font-bold text-white mb-4 md:mb-0">
                <span class="text-primary-color">Homeland</span> Property Flip Calculator
            </h1>
            <button id="how-to-use-btn" class="btn btn-secondary btn-sm">
                How to Use This Calculator
            </button>
        </header>

        <!-- API Key Input -->
        <div class="result-box mb-6">
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="input-group flex-1 w-full m-0">
                    <label for="api-key-input" class="label">Google AI API Key</label>
                    <input type: "text" id="api-key-input" class="input" placeholder="Enter your API Key...">
                </div>
                <button id="save-api-key-btn" class="btn btn-primary w-full md:w-auto mt-0 md:mt-6">Save Key</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-bg-secondary rounded-lg border border-bg-tertiary shadow-lg">
            <nav class="flex flex-wrap border-b border-bg-tertiary overflow-x-auto">
                <a href="#" class="tab-link active" onclick="showTab('deal-calculator')">Deal Calculator</a>
                <a href="#" class="tab-link" onclick="showTab('mao-calculator')">MAO Calculator</a>
                <a href="#" class="tab-link" onclick="showTab('ai-market-analyzer')">AI Market Analyzer</a>
                <a href="#" class="tab-link" onclick="showTab('what-if')">What If?</a>
                <a href="#" class="tab-link" onclick="showTab('batch-analyzer')">Batch Analyzer</a>
                <a href="#" class="tab-link" onclick="showTab('saved-deals')">Saved Deals</a>
            </nav>
            
            <div class="tab-content p-6">
<!-- ===== Tab Pane: Deal Calculator ===== -->
                <div id="deal-calculator" class="tab-pane active">
                    <div class="grid-container">
                        <!-- Left Column: Inputs -->
                        <div class="result-box space-y-4">
                            <h3 class="result-box-title">1. Core Numbers</h3>
                            <div class="input-group">
                                <label for="purchase-price" class="label">Purchase Price ($)</label>
                                <input type="text" id="purchase-price" class="input" placeholder="e.g., 250,000" oninput="formatCurrency(this)">
                            </div>
                            
                            <div class="input-group">
                                <label for="arv" class="label">After Repair Value (ARV) ($)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="arv" class="input" placeholder="e.g., 400,000" oninput="formatCurrency(this)">
                                    <button id="arv-comps-btn" class="btn btn-secondary">âœ¨ Comps</button>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label for="rehab-costs" class="label">Rehab Costs ($)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="rehab-costs" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                                    <button id="rehab-breakdown-btn" class="btn btn-secondary">Tools</button>
                                </div>
                            </div>
                            
                            <h3 class="subsection-title">2. Financing</h3>
                            <div class="input-group">
                                <label for="financing-type" class="label">Financing Type</label>
                                <select id="financing-type" class="select">
                                    <option value="cash">All Cash</option>
                                    <option value="loan" selected>Loan (Hard Money / Bank)</option>
                                </select>
                            </div>
                            
                            <div id="loan-inputs-container" class="space-y-4 pt-4 border-t border-bg-tertiary">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="down-payment-percent" class="label">Down Payment (%)</label>
                                        <input type="number" id="down-payment-percent" class="input" placeholder="20" value="20">
                                    </div>
                                    <div class="input-group">
                                        <label for="interest-rate" class="label">Interest Rate (%)</label>
                                        <input type="number" id="interest-rate" class="input" placeholder="9" value="9">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="loan-points" class="label">Loan Points (%)</label>
                                        <input type="number" id="loan-points" class="input" placeholder="2" value="2">
                                    </div>
                                    <div class="input-group">
                                        <label for="other-closing-costs" class="label">Closing Costs ($)</label>
                                        <input type="text" id="other-closing-costs" class="input" placeholder="3,000" value="3,000" oninput="formatCurrency(this)">
                                    </div>
                                </div>
                            </div>

                            <h3 class="subsection-title">3. Holding & Selling</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="holding-months" class="label">Project Length (Months)</label>
                                    <input type="number" id="holding-months" class="input" placeholder="6" value="6">
                                </div>
                                <div class="input-group">
                                    <label for="monthly-holding-costs" class="label">Monthly Costs ($)</label>
                                    <input type="text" id="monthly-holding-costs" class="input" placeholder="500" value="500" oninput="formatCurrency(this)">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="selling-costs-percent" class="label">Selling Costs (%)</label>
                                    <input type="number" id="selling-costs-percent" class="input" placeholder="6" value="6">
                                </div>
                                <div class="input-group">
                                    <label for="selling-costs-flat" class="label">Selling Costs (Flat $)</label>
                                    <input type="text" id="selling-costs-flat" class="input" placeholder="1,500" value="1,500" oninput="formatCurrency(this)">
                                </div>
                            </div>

                            <button id="calculate-deal-btn" class="btn btn-primary w-full !mt-8">Calculate Deal</button>
                        </div>
                        
                        <!-- Right Column: Results -->
                        <div id="results-container" class="result-box space-y-4" style="display: none;">
                            <div class="flex justify-between items-center">
                                <h3 class="result-box-title">Deal Summary</h3>
                                <div class="flex gap-2">
                                    <button id="print-report-btn" class="btn btn-secondary btn-sm">Print</button>
                                    <button id="save-deal-btn" class="btn btn-primary btn-sm">ðŸ’¾ Save Deal</button>
                                </div>
                            </div>

                            <div class="result-line total-line">
                                <span class="result-line-label">Estimated Gross Profit</span>
                                <span id="gross-profit-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="result-box !bg-bg-primary !p-4">
                                    <div class="result-line-label">Return on Investment (ROI)</div>
                                    <div id="roi-result" class="result-line-value text-xl profit">0.0%</div>
                                </div>
                                <div class="result-box !bg-bg-primary !p-4">
                                    <div class="result-line-label">Annualized ROI</div>
                                    <div id="annualized-roi-result" class="result-line-value text-xl profit">0.0%</div>
                                </div>
                            </div>
                            
                            <h3 class="subsection-title">Cash & Profit per Month</h3>
                            <div class="result-line">
                                <span class="result-line-label">Total Cash Needed</span>
                                <span id="total-cash-needed-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Total Investment (Cash Deal)</span>
                                <span id="total-investment-cash-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Profit per Month</span>
                                <span id="profit-per-month-result" class="result-line-value">$0</span>
                            </div>
                            
                            <h3 class="subsection-title">Profit Breakdown</h3>
                            <div class="result-line">
                                <span class="result-line-label">ARV</span>
                                <span id="profit-check-arv" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Total All Costs</span>
                                <span id="profit-check-costs" class="result-line-value loss">($0)</span>
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Gross Profit</span>
                                <span id="profit-check-result" class="result-line-value text-xl profit">$0</span>
                            </div>

                            <h3 class="subsection-title">Cost Breakdown</h3>
                            <div class="result-line">
                                <span class="result-line-label">Purchase Price</span>
                                <span id="purchase-price-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Rehab Costs</span>
                                <span id="rehab-costs-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Holding Costs (Monthly)</span>
                                <span id="total-holding-costs-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Financing Costs</span>
                                <span id="total-financing-costs-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line">
                                <span class="result-line-label">Selling Costs</span>
                                <span id="total-selling-costs-result" class="result-line-value">$0</span>
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Total Costs</span>
                                <span id="total-costs-result" class="result-line-value text-xl loss">($0)</span>
                            </div>
                            
                            <button id="get-deal-summary-btn" class="btn btn-secondary w-full !mt-8">
                                <span class="spinner"></span>
                                <span>âœ¨ Get AI Deal Summary</span>
                            </button>
                            <div id="ai-summary-container" class="ai-output-box" style="display: none;">
                                <div id="ai-summary-spinner" class="flex justify-center items-center py-4">
                                    <div class="spinner !inline-block"></div>
                                </div>
                                <pre id="ai-summary-content" class="ai-output-content"></pre>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Deal Calculator Tab Pane -->
                
                <!-- ===== Modals for Deal Calculator ===== -->
                
                <!-- ARV Comps Modal -->
                <div id="arv-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">ARV Comps Calculator</h3>
                            <span id="arv-modal-close" class="modal-close">&times;</span>
                        </div>
                        <div class="modal-body">
                            <!-- AI Comp Finder -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI Comp Finder</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="subject-address" class="label">Subject Property Address or Zip</label>
                                        <input type="text" id="subject-address" class="input" placeholder="123 Main St, Denver, CO">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-comp-radius" class="label">Search Radius (miles)</label>
                                        <input type="number" id="ai-comp-radius" class="input" placeholder="3" value="3">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="ai-comp-status" class="label">Comp Status</label>
                                        <select id="ai-comp-status" class="select">
                                            <option value="Sold">Sold Comps</option>
                                            <option value="For Sale">For Sale Comps</option>
                                        </select>
                                    </div>
                                    <div class="input-group" id="ai-sold-since-container">
                                        <label for="ai-sold-since" class="label">Sold Since</label>
                                        <select id="ai-sold-since" class="select">
                                            <option value="1 month">1 Month</option>
                                            <option value="3 months">3 Months</option>
                                            <option value="6 months" selected>6 Months</option>
                                            <option value="12 months">12 Months</option>
                                            <option value="24 months">24 Months</option>
                                            <option value="36 months">36 Months</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="ai-comp-finder-btn" class="btn btn-primary w-full mt-2">
                                    <span class="spinner"></span>
                                    <span>âœ¨ Find Comps with AI</span>
                                </button>
                                <p id="ai-comp-finder-status" class="text-sm text-center mt-2" style="display: none;"></p>
                            </div>

                            <!-- Manual Comps -->
                            <h4 class="subsection-title">Manual Comps</h4>
                            <div class="input-group">
                                <label for="subject-sqft" class="label">Subject Property Sq. Ft.</label>
                                <input type="text" id="subject-sqft" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                            </div>
                            
                            <div class="comp-grid-header hidden md:grid comp-grid mb-2">
                                <label class="label">Address</label>
                                <label class="label">Beds</label>
                                <label class="label">Baths</label>
                                <label class="label">Sq. Ft.</label>
                                <label class="label">Sale Price</label>
                            </div>
                            <div id="comps-list-container">
                                <!-- Comp rows injected by JS -->
                            </div>
                            <button id="add-comp-row-btn" class="btn btn-secondary btn-sm mt-2">+ Add Comp</button>

                        </div>
                        <div class="modal-footer justify-between">
                            <div class="text-left">
                                <div class="result-line-label">Avg. Price / SqFt</div>
                                <div id="avg-price-per-sqft-result" class="result-line-value text-xl profit">$0</div>
                                <div class="result-line-label mt-2">Estimated ARV</div>
                                <div id="estimated-arv-result" class="result-line-value text-3xl profit">$0</div>
                            </div>
                            <button id="use-arv-btn" class="btn btn-primary">Use this ARV</button>
                        </div>
                    </div>
                </div>
                
                <!-- Rehab Cost Estimator Modal -->
                <div id="rehab-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Rehab Cost Estimator</h3>
                            <span id="rehab-modal-close" class="modal-close">&times;</span>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI Rehab Estimate</h4>
                                <div class="input-group">
                                    <label for="subject-sqft-rehab" class="label">Subject Property Sq. Ft.</label>
                                    <input type="text" id="subject-sqft-rehab" class="input" placeholder="e.g., 1,500" oninput="formatCurrency(this)">
                                </div>
                                <div class="input-group">
                                    <label for="rehab-description" class="label">Rehab Description</label>
                                    <textarea id="rehab-description" class="textarea" rows="3" placeholder="e.g., Full gut job, new kitchen, 2 new baths, paint, and flooring..."></textarea>
                                </div>
                                <button id="ai-rehab-btn" class="btn btn-primary w-full">
                                    <span class="spinner"></span>
                                    <span>Generate AI Estimate</span>
                                </button>
                                <div id="ai-rehab-output" class_name="ai-output-box !mt-4" style="display: none;">
                                    <h5 class="font-bold text-cyan-400 mb-2">Budget Breakdown:</h5>
                                    <pre id="ai-rehab-content" class="ai-output-content mb-4"></pre>
                                    <div id="ai-rehab-cost-output"></div>
                                </div>
                            </div>
                            
                            <h4 class="subsection-title">Manual Itemization</h4>
                            <div id="manual-rehab-list" class="space-y-2">
                                <!-- Rehab items injected by JS -->
                            </div>
                            <button id="add-rehab-item-btn" class="btn btn-secondary btn-sm mt-2">+ Add Item</button>
                            
                        </div>
                        <div class="modal-footer justify-between">
                            <div class="text-left">
                                <div class="result-line-label">Total Itemized Cost</div>
                                <div id="manual-rehab-total" class="result-line-value text-3xl profit">$0</div>
                            </div>
                            <button id="use-itemized-rehab-btn" class="btn btn-primary">Use this Total</button>
                        </div>
                    </div>
                </div>

                <!-- ===== Tab Pane: MAO Calculator ===== -->
                <div id="mao-calculator" class="tab-pane">
                    <div class="grid-container">
                        <!-- Quick MAO (70% Rule) -->
                        <div class="result-box">
                            <h3 class="result-box-title">Quick MAO Rule</h3>
                            <p class="modal-text -mt-4 mb-4">The "70% Rule" is a common baseline. This slider lets you adjust that percentage. A lower % is a more conservative offer, leaving more room for profit. A higher % is a more aggressive offer.</p>
                            
                            <div class="input-group">
                                <label for="mao-rule-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-rule-arv" class="input" placeholder="400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-rule-rehab" class="label">Est. Rehab Costs</label>
                                <input type="text" id="mao-rule-rehab" class="input" placeholder="50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="label !mb-0">ARV Percentage</label>
                                    <span id="mao-rule-percent" class="font-bold text-lg text-primary-color">70%</span>
                                </div>
                                <input type="range" id="mao-rule-slider" class="slider" min="50" max="100" value="70">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer</span>
                                <span id="mao-rule-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>

                        <!-- MAO by Profit -->
                        <div class="result-box">
                            <h3 class="result-box-title">MAO by Desired Profit</h3>
                            <p class="modal-text -mt-4 mb-4">This is the most accurate way to calculate an offer. It works backwards from your desired profit, accounting for all costs.</p>

                            <div class="input-group">
                                <label for="mao-profit-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-profit-arv" class="input" placeholder="400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-rehab" class="label">Est. Rehab Costs</label>
                                <input type="text" id="mao-profit-rehab" class="input" placeholder="50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-holding" class="label">Est. Holding & Selling Costs</label>
                                <input type="text" id="mao-profit-holding" class="input" placeholder="40,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-desired" class="label">Desired Profit</label>
                                <input type="text" id="mao-profit-desired" class="input" placeholder="60,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer</span>
                                <span id="mao-profit-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>
                    </div>
                </div> <!-- End MAO Tab Pane -->
                
                <!-- ===== Tab Pane: AI Market Analyzer ===== -->
                <div id="ai-market-analyzer" class="tab-pane">
                    <div class="grid-container">
                        <!-- AI Neighborhood Analyzer -->
                        <div class="result-box">
                            <h3 class="result-box-title">AI Neighborhood Analyzer</h3>
                            <div class="input-group">
                                <label for="ai-market-address" class="label">Zip Code or Full Address</label>
                                <input type="text" id="ai-market-address" class="input" placeholder="e.g., 80210 or 123 Main St...">
                            </div>
                            <button id="ai-market-btn" class="btn btn-primary w-full">
                                <span class="spinner"></span>
                                <span>âœ¨ Analyze Market</span>
                            </button>
                            <div id="ai-market-output" class="ai-output-box" style="display: none;">
                                <pre id="ai-market-content" class="ai-output-content"></pre>
                            </div>
                        </div>
                        <!-- Market Velocity -->
                        <div class="result-box">
                            <h3 class="result-box-title">Market Velocity (Sell-Through Rate)</h3>
                            
                            <!-- AI Velocity Search -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI-Powered Velocity Search</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="ai-velocity-zip" class="label">Zip Code</label>
                                        <input type="text" id="ai-velocity-zip" class="input" placeholder="80210">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-velocity-type" class="label">Property Type (Optional)</label>
                                        <input type="text" id="ai-velocity-type" class="input" placeholder="e.g., 3-bed homes">
                                    </div>
                                </div>
                                <button id="ai-velocity-btn" class="btn btn-primary w-full mt-2">
                                    <span class="spinner"></span>
                                    <span>âœ¨ AI-Powered Velocity Search</span>
                                </button>
                                <p id="ai-velocity-status" class="text-sm text-center mt-2" style="display: none;"></p>
                            </div>
                            
                            <!-- Manual Velocity Calc -->
                            <h4 class="subsection-title">Manual Calculator</h4>
                            <p class="modal-text -mt-2 mb-4">Find these numbers on your MLS or sites like Redfin/Zillow. This rate shows how fast homes are selling.</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="velocity-sold" class="label">Homes Sold (Last 30 Days)</label>
                                    <input type="number" id="velocity-sold" class="input" placeholder="15">
                                </div>
                                <div class="input-group">
                                    <label for="velocity-inventory" class="label">Total Homes for Sale</label>
                                    <input type="number" id="velocity-inventory" class="input" placeholder="100">
                                </div>
                            </div>
                            <button id="velocity-calculate-btn" class="btn btn-secondary w-full">Calculate Rate</button>
                            
                            <div id="velocity-results-container" style="display: none;">
                                <div class="result-line total-line">
                                    <span class="result-line-label">Sell-Through Rate</span>
                                    <span id="velocity-rate-result" class="result-line-value text-2xl profit">0.0%</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Market Type</span>
                                    <span id="velocity-market-result" class="result-line-value text-2xl profit">---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End AI Market Analyzer Tab Pane -->
                
                <!-- ===== Tab Pane: What If? ===== -->
                <div id="what-if" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">"What If?" Sensitivity Analysis</h3>
                        <p class="modal-text -mt-4 mb-6">This table shows how your profit changes if your ARV and Rehab Costs are different from your estimate. (Calculated from "Deal Calculator" tab).</p>
                        
                        <div class="overflow-x-auto">
                            <table class="what-if-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">Profit</th>
                                        <th>-10% Rehab</th>
                                        <th>Base Rehab</th>
                                        <th>+10% Rehab</th>
                                        <th>+20% Rehab</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-left font-bold">+5% ARV</td>
                                        <td id="what-if-arv-high-rehab-low">---</td>
                                        <td id="what-if-arv-high-rehab-mid">---</td>
                                        <td id="what-if-arv-high-rehab-high">---</td>
                                        <td id="what-if-arv-high-rehab-over">---</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left font-bold">Base ARV</td>
                                        <td id="what-if-arv-mid-rehab-low">---</td>
                                        <td id="what-if-profit-base" class="base-cell">---</td>
                                        <td id="what-if-arv-mid-rehab-high">---</td>
                                        <td id="what-if-arv-mid-rehab-over">---</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left font-bold">-5% ARV</td>
                                        <td id="what-if-arv-low-rehab-low">---</td>
                                        <td id="what-if-arv-low-rehab-mid">---</td>
                                        <td id="what-if-arv-low-rehab-high">---</td>
                                        <td id="what-if-arv-low-rehab-over">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div> <!-- End What If? Tab Pane -->
                
                <!-- ===== Tab Pane: Batch Analyzer ===== -->
                <div id="batch-analyzer" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">Batch Deal Analyzer</h3>
                        <p class="modal-text -mt-4 mb-4">Upload a CSV file of properties to analyze the first 10 deals at once. This tool will run an AI Comp search to estimate ARV and calculate potential profit for each.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div class="input-group">
                                <label for="csv-file-label" class="label">Upload Property List (.csv)</label>
                                <label for="csv-file-input" class="file-input-label" id="csv-file-label">
                                    <span>Choose File</span>
                                    <span id="file-name" class="file-name-display">No file chosen</span>
                                </label>
                                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                            </div>
                            <div class="input-group">
                                <label for="batch-rehab-cost" class="label">Default Rehab Cost ($)</label>
                                <input type="text" id="batch-rehab-cost" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <button id="map-columns-btn" class="btn btn-secondary w-full" disabled>Map Columns</button>
                            <button id="run-batch-btn" class="btn btn-primary w-full" disabled>
                                <span class="spinner"></span>
                                <span>Analyze First 10 Properties</span>
                            </button>
                        </div>

                        <div id="batch-results-container" class="mt-8" style="display: none;">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="subsection-title !mt-0 !mb-1">Batch Results</h3>
                                    <p id="batch-status-text" class="text-sm text-text-secondary"></p>
                                </div>
                                <button id="download-batch-csv-btn" class="btn btn-secondary btn-sm">Download Results</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-bg-tertiary">
                                        <tr id="batch-results-table-head">
                                            <!-- Headers injected by JS -->
                                        </tr>
                                    </thead>
                                    <tbody id="batch-results-table-body" class="divide-y divide-bg-tertiary">
                                        <!-- Results injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Batch Analyzer Tab Pane -->
                
                <!-- ===== Tab Pane: Saved Deals ===== -->
                <div id="saved-deals" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">Saved Deals</h3>
                        <div id="saved-deals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- "No Deals" message is a template -->
                            <div id="no-saved-deals" class="text-center col-span-full py-12">
                                <p class="text-text-secondary">You haven't saved any deals yet.</p>
                                <p class="text-text-secondary text-sm">Calculate a deal on the first tab and click "ðŸ’¾ Save Deal".</p>
                            </div>
                            <!-- Saved deal cards injected by JS -->
                        </div>
                    </div>
                </div> <!-- End Saved Deals Tab Pane -->

            </div> <!-- End Tab Content -->
        </div> <!-- End Tab Container -->
    </div> <!-- End Container -->

    <!-- ===== All Modals ===== -->

    <!-- How to Use Modal -->
    <div id="how-to-use-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">How to Use This Calculator</h3>
                <span id="how-to-use-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <h4 class="subsection-title !mt-0">Core Workflow (1-2-3)</h4>
                <ol class="list-decimal list-inside modal-text space-y-2 mb-6">
                    <li><strong>Start on the "Deal Calculator" tab.</strong> Enter the `Purchase Price`, `ARV`, and `Rehab Costs`. The "Tools" and "Comps" buttons will help you find these numbers.</li>
                    <li><strong>Enter your project details.</strong> Fill out `Financing` (if any), `Holding Months`, and `Selling Costs`.</li>
                    <li><strong>Click "Calculate Deal".</strong> Your results (Profit, ROI, etc.) will appear on the right.</li>
                </ol>

                <h4 class="subsection-title">Feature Definitions</h4>
                
                <h5 class="font-bold text-white">Deal Calculator Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>ARV Comps Calculator:</strong> Click the "âœ¨ Comps" button to open this.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI Comp Finder:</strong> Automatically finds Sold or For Sale comps near your property. It will fill in the addresses, specs, and sale prices for you.</li>
                            <li><strong>Manual Comps:</strong> Enter comps yourself. The tool calculates the average price per square foot.</li>
                            <li><strong>Estimated ARV:</strong> This is the final calculated value based on the comps and your property's Sq. Ft. Click "Use this ARV" to send it to the main calculator.</li>
                        </ul>
                    </li>
                    <li><strong>Rehab Cost Estimator:</strong> Click the "Tools" button to open this.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI Rehab Estimate:</strong> Describe your renovation (e.g., "new kitchen, 2 baths") and the AI will provide a percentage breakdown and a Low/Average/High total cost estimate.</li>
                            <li><strong>Manual Itemization:</strong> Create your own line-item budget (e.g., "Roof - $10,000").</li>
                            <li>Click "Use this Total" or "Use Average Cost" to send the final number to the main calculator.</li>
                        </ul>
                    </li>
                    <li><strong>AI Deal Summary:</strong> After calculating, this button appears. The AI will give you a short paragraph analyzing the deal's strengths and weaknesses.</li>
                </ul>

                <h5 class="font-bold text-white">MAO Calculator Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>Quick MAO Rule:</strong> A simple calculator for "rule of thumb" offers. The 70% rule (ARV * 70% - Rehab) is a common baseline.</li>
                    <li><strong>MAO by Desired Profit:</strong> The "pro" method. It works backwards to find your offer price (ARV - Rehab - All Other Costs - Desired Profit = MAO).</li>
                </ul>
                
                <h5 class="font-bold text-white">AI Market Analyzer Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>AI Neighborhood Analyzer:</strong> Enter a zip code or address to get an AI-generated report on market trends, schools, and amenities.</li>
                    <li><strong>Market Velocity (Sell-Through Rate):</strong> This measures how fast the market is moving.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI-Powered Search:</strong> Enter a zip code, and the AI will find the "Homes Sold" and "Total Inventory" numbers for you.</li>
                            <li><strong>Manual Calculator:</strong> Enter the numbers yourself to see the rate (e.g., 20% = "Hot Seller's Market").</li>
                        </ul>
                    </li>
                </ul>

                <h5 class="font-bold text-white">What If? Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>A "Sensitivity Analysis" table. It automatically takes your calculated deal and shows how your profit would change if your ARV is lower or your rehab costs are higher than you estimated.</li>
                </ul>
                
                <h5 class="font-bold text-white">Batch Analyzer Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>Upload your CSV file of properties.</li>
                    <li>Click "Map Columns" to tell the calculator which columns are your `Address`, `Zip Code`, `Sq Ft`, and `Market Value Estimate` (which we use as the Purchase Price).</li>
                    <li>Click "Analyze First 10 Properties." The tool will run an AI Comp search on the first 10 properties to estimate ARV and calculate profit for each, displaying the results in a table.</li>
                    <li>You can then download this new, enriched CSV file.</li>
                </ul>
                
                <h5 class="font-bold text-white">Saved Deals Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>After calculating a deal, click "ðŸ’¾ Save Deal" to save it.</li>
                    <li>This tab lets you see all your saved deals in one place. You can click "Load" to repopulate the calculator with that deal's numbers or "Delete" to remove it.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="how-to-use-close-btn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Save Deal Modal -->
    <div id="save-deal-modal" class="modal-overlay">
        <div class="modal-content !max-w-md">
            <div class="modal-header">
                <h3 class="modal-title">Save Deal</h3>
                <span id="save-deal-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="save-deal-name" class="label">Deal Name</label>
                    <input type="text" id="save-deal-name" class="input" placeholder="e.g., 123 Main St">
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-save-deal-btn" class="btn btn-primary">Save Deal</button>
            </div>
        </div>
    </div>
    
    <!-- Batch Map Modal -->
    <div id="batch-map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Map CSV Columns</h3>
                <span id="batch-map-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-text mb-4">Tell the calculator which columns in your file match these fields. We'll use "Market Value Estimate" as your "Purchase Price" for the analysis.</p>
                
                <h4 class="subsection-title !mt-0">Address (Pick One Option)</h4>
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                    <p class="font-bold text-white mb-2">Option 1: Full Address</p>
                    <div class="input-group">
                        <label for="map-full-address" class="label">Full Address</label>
                        <select id="map-full-address" class="select map-select"></select>
                    </div>
                </div>
                
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                    <p class="font-bold text-white mb-2">Option 2: Separate Fields</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label for="map-street-address" class="label">Street Address</label>
                            <select id="map-street-address" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-city" class="label">City</label>
                            <select id="map-city" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-state" class="label">State</label>
                            <select id="map-state" class="select map-select"></select>
                        </div>
                    </div>
                </div>

                <h4 class="subsection-title">Required Fields</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="map-zip-code" class="label">Zip Code</label>
                        <select id="map-zip-code" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-sqft" class="label">Square Footage</label>
                        <select id="map-sqft" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-purchase-price" class="label">Current Value (as Purchase Price)</label>
                        <select id="map-purchase-price" class="select map-select"></select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-map-btn" class="btn btn-primary">Confirm Mapping</button>
            </div>
        </div>
    </div>
<!-- ===== Tab Pane: MAO Calculator ===== -->
                <div id="mao-calculator" class="tab-pane">
                    <div class="grid-container">
                        <!-- Quick MAO (70% Rule) -->
                        <div class="result-box">
                            <h3 class="result-box-title">Quick MAO Rule</h3>
                            <p class="modal-text -mt-4 mb-4">The "70% Rule" is a common baseline. This slider lets you adjust that percentage. A lower % is a more conservative offer, leaving more room for profit. A higher % is a more aggressive offer.</p>
                            
                            <div class="input-group">
                                <label for="mao-rule-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-rule-arv" class="input" placeholder="400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-rule-rehab" class="label">Est. Rehab Costs</label>
                                <input type="text" id="mao-rule-rehab" class="input" placeholder="50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="label !mb-0">ARV Percentage</label>
                                    <span id="mao-rule-percent" class="font-bold text-lg text-primary-color">70%</span>
                                </div>
                                <input type="range" id="mao-rule-slider" class="slider" min="50" max="100" value="70">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer</span>
                                <span id="mao-rule-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>

                        <!-- MAO by Profit -->
                        <div class="result-box">
                            <h3 class="result-box-title">MAO by Desired Profit</h3>
                            <p class="modal-text -mt-4 mb-4">This is the most accurate way to calculate an offer. It works backwards from your desired profit, accounting for all costs.</p>

                            <div class="input-group">
                                <label for="mao-profit-arv" class="label">After Repair Value (ARV)</label>
                                <input type="text" id="mao-profit-arv" class="input" placeholder="400,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-rehab" class="label">Est. Rehab Costs</label>
                                <input type="text" id="mao-profit-rehab" class="input" placeholder="50,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-holding" class="label">Est. Holding & Selling Costs</label>
                                <input type="text" id="mao-profit-holding" class="input" placeholder="40,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="input-group">
                                <label for="mao-profit-desired" class="label">Desired Profit</label>
                                <input type="text" id="mao-profit-desired" class="input" placeholder="60,000" oninput="formatCurrency(this)">
                            </div>
                            <div class="result-line total-line">
                                <span class="result-line-label">Max Allowable Offer</span>
                                <span id="mao-profit-result" class="result-line-value text-2xl profit">$0</span>
                            </div>
                        </div>
                    </div>
                </div> <!-- End MAO Tab Pane -->
                
                <!-- ===== Tab Pane: AI Market Analyzer ===== -->
                <div id="ai-market-analyzer" class="tab-pane">
                    <div class="grid-container">
                        <!-- AI Neighborhood Analyzer -->
                        <div class="result-box">
                            <h3 class="result-box-title">AI Neighborhood Analyzer</h3>
                            <div class="input-group">
                                <label for="ai-market-address" class="label">Zip Code or Full Address</label>
                                <input type="text" id="ai-market-address" class="input" placeholder="e.g., 80210 or 123 Main St...">
                            </div>
                            <button id="ai-market-btn" class="btn btn-primary w-full">
                                <span class="spinner"></span>
                                <span>âœ¨ Analyze Market</span>
                            </button>
                            <div id="ai-market-output" class="ai-output-box" style="display: none;">
                                <pre id="ai-market-content" class="ai-output-content"></pre>
                            </div>
                        </div>
                        <!-- Market Velocity -->
                        <div class="result-box">
                            <h3 class="result-box-title">Market Velocity (Sell-Through Rate)</h3>
                            
                            <!-- AI Velocity Search -->
                            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                                <h4 class="subsection-title mt-0">AI-Powered Velocity Search</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label for="ai-velocity-zip" class="label">Zip Code</label>
                                        <input type="text" id="ai-velocity-zip" class="input" placeholder="80210">
                                    </div>
                                    <div class="input-group">
                                        <label for="ai-velocity-type" class="label">Property Type (Optional)</label>
                                        <input type="text" id="ai-velocity-type" class="input" placeholder="e.g., 3-bed homes">
                                    </div>
                                </div>
                                <button id="ai-velocity-btn" class="btn btn-primary w-full mt-2">
                                    <span class="spinner"></span>
                                    <span>âœ¨ AI-Powered Velocity Search</span>
                                </button>
                                <p id="ai-velocity-status" class="text-sm text-center mt-2" style="display: none;"></p>
                            </div>
                            
                            <!-- Manual Velocity Calc -->
                            <h4 class="subsection-title">Manual Calculator</h4>
                            <p class="modal-text -mt-2 mb-4">Find these numbers on your MLS or sites like Redfin/Zillow. This rate shows how fast homes are selling.</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="velocity-sold" class="label">Homes Sold (Last 30 Days)</label>
                                    <input type="number" id="velocity-sold" class="input" placeholder="15">
                                </div>
                                <div class="input-group">
                                    <label for="velocity-inventory" class="label">Total Homes for Sale</label>
                                    <input type="number" id="velocity-inventory" class="input" placeholder="100">
                                </div>
                            </div>
                            <button id="velocity-calculate-btn" class="btn btn-secondary w-full">Calculate Rate</button>
                            
                            <div id="velocity-results-container" style="display: none;">
                                <div class="result-line total-line">
                                    <span class="result-line-label">Sell-Through Rate</span>
                                    <span id="velocity-rate-result" class="result-line-value text-2xl profit">0.0%</span>
                                </div>
                                <div class="result-line">
                                    <span class="result-line-label">Market Type</span>
                                    <span id="velocity-market-result" class="result-line-value text-2xl profit">---</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End AI Market Analyzer Tab Pane -->
                
                <!-- ===== Tab Pane: What If? ===== -->
                <div id="what-if" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">"What If?" Sensitivity Analysis</h3>
                        <p class="modal-text -mt-4 mb-6">This table shows how your profit changes if your ARV and Rehab Costs are different from your estimate. (Calculated from "Deal Calculator" tab).</p>
                        
                        <div class="overflow-x-auto">
                            <table class="what-if-table">
                                <thead>
                                    <tr>
                                        <th class="text-left">Profit</th>
                                        <th>-10% Rehab</th>
                                        <th>Base Rehab</th>
                                        <th>+10% Rehab</th>
                                        <th>+20% Rehab</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="text-left font-bold">+5% ARV</td>
                                        <td id="what-if-arv-high-rehab-low">---</td>
                                        <td id="what-if-arv-high-rehab-mid">---</td>
                                        <td id="what-if-arv-high-rehab-high">---</td>
                                        <td id="what-if-arv-high-rehab-over">---</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left font-bold">Base ARV</td>
                                        <td id="what-if-arv-mid-rehab-low">---</td>
                                        <td id="what-if-profit-base" class="base-cell">---</td>
                                        <td id="what-if-arv-mid-rehab-high">---</td>
                                        <td id="what-if-arv-mid-rehab-over">---</td>
                                    </tr>
                                    <tr>
                                        <td class="text-left font-bold">-5% ARV</td>
                                        <td id="what-if-arv-low-rehab-low">---</td>
                                        <td id="what-if-arv-low-rehab-mid">---</td>
                                        <td id="what-if-arv-low-rehab-high">---</td>
                                        <td id="what-if-arv-low-rehab-over">---</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div> <!-- End What If? Tab Pane -->
                
                <!-- ===== Tab Pane: Batch Analyzer ===== -->
                <div id="batch-analyzer" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">Batch Deal Analyzer</h3>
                        <p class="modal-text -mt-4 mb-4">Upload a CSV file of properties to analyze the first 10 deals at once. This tool will run an AI Comp search to estimate ARV and calculate potential profit for each.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div class="input-group">
                                <label for="csv-file-label" class="label">Upload Property List (.csv)</label>
                                <label for="csv-file-input" class="file-input-label" id="csv-file-label">
                                    <span>Choose File</span>
                                    <span id="file-name" class="file-name-display">No file chosen</span>
                                </label>
                                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                            </div>
                            <div class="input-group">
                                <label for="batch-rehab-cost" class="label">Default Rehab Cost ($)</label>
                                <input type="text" id="batch-rehab-cost" class="input" placeholder="e.g., 50,000" oninput="formatCurrency(this)">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <button id="map-columns-btn" class="btn btn-secondary w-full" disabled>Map Columns</button>
                            <button id="run-batch-btn" class="btn btn-primary w-full" disabled>
                                <span class="spinner"></span>
                                <span>Analyze First 10 Properties</span>
                            </button>
                        </div>

                        <div id="batch-results-container" class="mt-8" style="display: none;">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="subsection-title !mt-0 !mb-1">Batch Results</h3>
                                    <p id="batch-status-text" class="text-sm text-text-secondary"></p>
                                </div>
                                <button id="download-batch-csv-btn" class="btn btn-secondary btn-sm">Download Results</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-bg-tertiary">
                                        <tr id="batch-results-table-head">
                                            <!-- Headers injected by JS -->
                                        </tr>
                                    </thead>
                                    <tbody id="batch-results-table-body" class="divide-y divide-bg-tertiary">
                                        <!-- Results injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div> <!-- End Batch Analyzer Tab Pane -->
                
                <!-- ===== Tab Pane: Saved Deals ===== -->
                <div id="saved-deals" class="tab-pane">
                    <div class="result-box">
                        <h3 class="result-box-title">Saved Deals</h3>
                        <div id="saved-deals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- "No Deals" message is a template -->
                            <div id="no-saved-deals" class="text-center col-span-full py-12">
                                <p class="text-text-secondary">You haven't saved any deals yet.</p>
                                <p class="text-text-secondary text-sm">Calculate a deal on the first tab and click "ðŸ’¾ Save Deal".</p>
                            </div>
                            <!-- Saved deal cards injected by JS -->
                        </div>
                    </div>
                </div> <!-- End Saved Deals Tab Pane -->

            </div> <!-- End Tab Content -->
        </div> <!-- End Tab Container -->
    </div> <!-- End Container -->

    <!-- ===== All Modals ===== -->

    <!-- How to Use Modal -->
    <div id="how-to-use-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">How to Use This Calculator</h3>
                <span id="how-to-use-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <h4 class="subsection-title !mt-0">Core Workflow (1-2-3)</h4>
                <ol class="list-decimal list-inside modal-text space-y-2 mb-6">
                    <li><strong>Start on the "Deal Calculator" tab.</strong> Enter the `Purchase Price`, `ARV`, and `Rehab Costs`. The "Tools" and "Comps" buttons will help you find these numbers.</li>
                    <li><strong>Enter your project details.</strong> Fill out `Financing` (if any), `Holding Months`, and `Selling Costs`.</li>
                    <li><strong>Click "Calculate Deal".</strong> Your results (Profit, ROI, etc.) will appear on the right.</li>
                </ol>

                <h4 class="subsection-title">Feature Definitions</h4>
                
                <h5 class="font-bold text-white">Deal Calculator Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>ARV Comps Calculator:</strong> Click the "âœ¨ Comps" button to open this.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI Comp Finder:</strong> Automatically finds Sold or For Sale comps near your property. It will fill in the addresses, specs, and sale prices for you.</li>
                            <li><strong>Manual Comps:</strong> Enter comps yourself. The tool calculates the average price per square foot.</li>
                            <li><strong>Estimated ARV:</strong> This is the final calculated value based on the comps and your property's Sq. Ft. Click "Use this ARV" to send it to the main calculator.</li>
                        </ul>
                    </li>
                    <li><strong>Rehab Cost Estimator:</strong> Click the "Tools" button to open this.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI Rehab Estimate:</strong> Describe your renovation (e.g., "new kitchen, 2 baths") and the AI will provide a percentage breakdown and a Low/Average/High total cost estimate.</li>
                            <li><strong>Manual Itemization:</strong> Create your own line-item budget (e.g., "Roof - $10,000").</li>
                            <li>Click "Use this Total" or "Use Average Cost" to send the final number to the main calculator.</li>
                        </ul>
                    </li>
                    <li><strong>AI Deal Summary:</strong> After calculating, this button appears. The AI will give you a short paragraph analyzing the deal's strengths and weaknesses.</li>
                </ul>

                <h5 class="font-bold text-white">MAO Calculator Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>Quick MAO Rule:</strong> A simple calculator for "rule of thumb" offers. The 70% rule (ARV * 70% - Rehab) is a common baseline.</li>
                    <li><strong>MAO by Desired Profit:</strong> The "pro" method. It works backwards to find your offer price (ARV - Rehab - All Other Costs - Desired Profit = MAO).</li>
                </ul>
                
                <h5 class="font-bold text-white">AI Market Analyzer Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li><strong>AI Neighborhood Analyzer:</strong> Enter a zip code or address to get an AI-generated report on market trends, schools, and amenities.</li>
                    <li><strong>Market Velocity (Sell-Through Rate):</strong> This measures how fast the market is moving.
                        <ul class="list-disc list-inside ml-6 space-y-1 mt-1">
                            <li><strong>AI-Powered Search:</strong> Enter a zip code, and the AI will find the "Homes Sold" and "Total Inventory" numbers for you.</li>
                            <li><strong>Manual Calculator:</strong> Enter the numbers yourself to see the rate (e.g., 20% = "Hot Seller's Market").</li>
                        </ul>
                    </li>
                </ul>

                <h5 class="font-bold text-white">What If? Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>A "Sensitivity Analysis" table. It automatically takes your calculated deal and shows how your profit would change if your ARV is lower or your rehab costs are higher than you estimated.</li>
                </ul>
                
                <h5 class="font-bold text-white">Batch Analyzer Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>Upload your CSV file of properties.</li>
                    <li>Click "Map Columns" to tell the calculator which columns are your `Address`, `Zip Code`, `Sq Ft`, and `Market Value Estimate` (which we use as the Purchase Price).</li>
                    <li>Click "Analyze First 10 Properties." The tool will run an AI Comp search on the first 10 properties to estimate ARV and calculate profit for each, displaying the results in a table.</li>
                    <li>You can then download this new, enriched CSV file.</li>
                </ul>
                
                <h5 class="font-bold text-white">Saved Deals Tab</h5>
                <ul class="list-disc list-inside modal-text space-y-2 mb-4">
                    <li>After calculating a deal, click "ðŸ’¾ Save Deal" to save it.</li>
                    <li>This tab lets you see all your saved deals in one place. You can click "Load" to repopulate the calculator with that deal's numbers or "Delete" to remove it.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="how-to-use-close-btn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>
    
    <!-- Save Deal Modal -->
    <div id="save-deal-modal" class="modal-overlay">
        <div class="modal-content !max-w-md">
            <div class="modal-header">
                <h3 class="modal-title">Save Deal</h3>
                <span id="save-deal-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="save-deal-name" class="label">Deal Name</label>
                    <input type="text" id="save-deal-name" class="input" placeholder="e.g., 123 Main St">
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-save-deal-btn" class="btn btn-primary">Save Deal</button>
            </div>
        </div>
    </div>
    
    <!-- Batch Map Modal -->
    <div id="batch-map-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Map CSV Columns</h3>
                <span id="batch-map-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-text mb-4">Tell the calculator which columns in your file match these fields. We'll use "Market Value Estimate" as your "Purchase Price" for the analysis.</p>
                
                <h4 class="subsection-title !mt-0">Address (Pick One Option)</h4>
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                    <p class="font-bold text-white mb-2">Option 1: Full Address</p>
                    <div class="input-group">
                        <label for="map-full-address" class="label">Full Address</label>
                        <select id="map-full-address" class="select map-select"></select>
                    </div>
                </div>
                
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 mb-6">
                    <p class="font-bold text-white mb-2">Option 2: Separate Fields</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label for="map-street-address" class="label">Street Address</label>
                            <select id="map-street-address" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-city" class="label">City</label>
                            <select id="map-city" class="select map-select"></select>
                        </div>
                        <div class="input-group">
                            <label for="map-state" class="label">State</label>
                            <select id="map-state" class="select map-select"></select>
                        </div>
                    </div>
                </div>

                <h4 class="subsection-title">Required Fields</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="input-group">
                        <label for="map-zip-code" class="label">Zip Code</label>
                        <select id="map-zip-code" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-sqft" class="label">Square Footage</label>
                        <select id="map-sqft" class="select map-select"></select>
                    </div>
                    <div class="input-group">
                        <label for="map-purchase-price" class="label">Current Value (as Purchase Price)</label>
                        <select id="map-purchase-price" class="select map-select"></select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-map-btn" class="btn btn-primary">Confirm Mapping</button>
            </div>
        </div>
    </div>
